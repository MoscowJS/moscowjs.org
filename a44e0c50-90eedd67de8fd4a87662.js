/*! For license information please see a44e0c50-90eedd67de8fd4a87662.js.LICENSE.txt */
(self.webpackChunkmoscowjs_org=self.webpackChunkmoscowjs_org||[]).push([[828],{23160:function(t,e,n){"use strict";n.d(e,{B:function(){return sc},D:function(){return Ja},E:function(){return Ga},G:function(){return dc},K:function(){return hc},O:function(){return S},Q:function(){return cc},X:function(){return gc},Y:function(){return mc},Z:function(){return _c},a:function(){return oc},c:function(){return Dc},e:function(){return bc},i:function(){return Tc},j:function(){return fc},n:function(){return Ic},o:function(){return Nc},p:function(){return Ka},q:function(){return ac},r:function(){return Sc}});var r=n(28691),i=n(35190),o=n(78689),s=n(79900),a=n(40033),u=function(){function t(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.t(t)},this.i=function(t){return e.writeSequenceNumber(t)})}return t.prototype.t=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},t.prototype.next=function(){var t=++this.previousValue;return this.i&&this.i(t),t},t}();u.o=-1;var c={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},h=function(t){function e(e,n){var r=this;return(r=t.call(this,n)||this).code=e,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return(0,s.__extends)(e,t),e}(Error),f=new i.Logger("@firebase/firestore");function l(){return f.logLevel}function d(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(f.logLevel<=i.LogLevel.DEBUG){var r=e.map(v);f.debug.apply(f,(0,s.__spreadArray)(["Firestore (8.6.8): "+t],r))}}function p(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(f.logLevel<=i.LogLevel.ERROR){var r=e.map(v);f.error.apply(f,(0,s.__spreadArray)(["Firestore (8.6.8): "+t],r))}}function y(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(f.logLevel<=i.LogLevel.WARN){var r=e.map(v);f.warn.apply(f,(0,s.__spreadArray)(["Firestore (8.6.8): "+t],r))}}function v(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function m(t){void 0===t&&(t="Unexpected state");var e="FIRESTORE (8.6.8) INTERNAL ASSERTION FAILED: "+t;throw p(e),new Error(e)}function g(t,e){t||m()}function _(t,e){return t}function w(t){var e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(var r=0;r<t;r++)n[r]=Math.floor(256*Math.random());return n}var b=function(){function t(){}return t.u=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length,n="";n.length<20;)for(var r=w(40),i=0;i<r.length;++i)n.length<20&&r[i]<e&&(n+=t.charAt(r[i]%t.length));return n},t}();function I(t,e){return t<e?-1:t>e?1:0}function E(t,e,n){return t.length===e.length&&t.every((function(t,r){return n(t,e[r])}))}function T(t){return t+"\0"}var S=function(){function t(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new h(c.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new h(c.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new h(c.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new h(c.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return t.now=function(){return t.fromMillis(Date.now())},t.fromDate=function(e){return t.fromMillis(e.getTime())},t.fromMillis=function(e){var n=Math.floor(e/1e3);return new t(n,Math.floor(1e6*(e-1e3*n)))},t.prototype.toDate=function(){return new Date(this.toMillis())},t.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},t.prototype._compareTo=function(t){return this.seconds===t.seconds?I(this.nanoseconds,t.nanoseconds):I(this.seconds,t.seconds)},t.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},t.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},t.prototype.toJSON=function(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}},t.prototype.valueOf=function(){var t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")},t}(),N=function(){function t(t){this.timestamp=t}return t.fromTimestamp=function(e){return new t(e)},t.min=function(){return new t(new S(0,0))},t.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},t.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},t.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},t.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},t.prototype.toTimestamp=function(){return this.timestamp},t}();function D(t){var e=0;for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function A(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function k(t){for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}var x=function(){function t(t,e,n){void 0===e?e=0:e>t.length&&m(),void 0===n?n=t.length-e:n>t.length-e&&m(),this.segments=t,this.offset=e,this.len=n}return Object.defineProperty(t.prototype,"length",{get:function(){return this.len},enumerable:!1,configurable:!0}),t.prototype.isEqual=function(e){return 0===t.comparator(this,e)},t.prototype.child=function(e){var n=this.segments.slice(this.offset,this.limit());return e instanceof t?e.forEach((function(t){n.push(t)})):n.push(e),this.construct(n)},t.prototype.limit=function(){return this.offset+this.length},t.prototype.popFirst=function(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)},t.prototype.popLast=function(){return this.construct(this.segments,this.offset,this.length-1)},t.prototype.firstSegment=function(){return this.segments[this.offset]},t.prototype.lastSegment=function(){return this.get(this.length-1)},t.prototype.get=function(t){return this.segments[this.offset+t]},t.prototype.isEmpty=function(){return 0===this.length},t.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},t.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},t.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(i>o)return 1}return t.length<e.length?-1:t.length>e.length?1:0},t}(),C=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,s.__extends)(e,t),e.prototype.construct=function(t,n,r){return new e(t,n,r)},e.prototype.canonicalString=function(){return this.toArray().join("/")},e.prototype.toString=function(){return this.canonicalString()},e.fromString=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];for(var r=[],i=0,o=t;i<o.length;i++){var s=o[i];if(s.indexOf("//")>=0)throw new h(c.INVALID_ARGUMENT,"Invalid segment ("+s+"). Paths must not contain // in them.");r.push.apply(r,s.split("/").filter((function(t){return t.length>0})))}return new e(r)},e.emptyPath=function(){return new e([])},e}(x),R=/^[_a-zA-Z][_a-zA-Z0-9]*$/,L=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,s.__extends)(e,t),e.prototype.construct=function(t,n,r){return new e(t,n,r)},e.isValidIdentifier=function(t){return R.test(t)},e.prototype.canonicalString=function(){return this.toArray().map((function(t){return t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e.isValidIdentifier(t)||(t="`"+t+"`"),t})).join(".")},e.prototype.toString=function(){return this.canonicalString()},e.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},e.keyField=function(){return new e(["__name__"])},e.fromServerFormat=function(t){for(var n=[],r="",i=0,o=function(){if(0===r.length)throw new h(c.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");n.push(r),r=""},s=!1;i<t.length;){var a=t[i];if("\\"===a){if(i+1===t.length)throw new h(c.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var u=t[i+1];if("\\"!==u&&"."!==u&&"`"!==u)throw new h(c.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);r+=u,i+=2}else"`"===a?(s=!s,i++):"."!==a||s?(r+=a,i++):(o(),i++)}if(o(),s)throw new h(c.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new e(n)},e.emptyPath=function(){return new e([])},e}(x),O=function(){function t(t){this.fields=t,t.sort(L.comparator)}return t.prototype.covers=function(t){for(var e=0,n=this.fields;e<n.length;e++)if(n[e].isPrefixOf(t))return!0;return!1},t.prototype.isEqual=function(t){return E(this.fields,t.fields,(function(t,e){return t.isEqual(e)}))},t}(),P=function(){function t(t){this.binaryString=t}return t.fromBase64String=function(e){return new t(atob(e))},t.fromUint8Array=function(e){return new t(function(t){for(var e="",n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(e))},t.prototype.toBase64=function(){return t=this.binaryString,btoa(t);var t},t.prototype.toUint8Array=function(){return function(t){for(var e=new Uint8Array(t.length),n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)},t.prototype.approximateByteSize=function(){return 2*this.binaryString.length},t.prototype.compareTo=function(t){return I(this.binaryString,t.binaryString)},t.prototype.isEqual=function(t){return this.binaryString===t.binaryString},t}();P.EMPTY_BYTE_STRING=new P("");var M=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function F(t){if(g(!!t),"string"==typeof t){var e=0,n=M.exec(t);if(g(!!n),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t);return{seconds:Math.floor(i.getTime()/1e3),nanos:e}}return{seconds:V(t.seconds),nanos:V(t.nanos)}}function V(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function q(t){return"string"==typeof t?P.fromBase64String(t):P.fromUint8Array(t)}function U(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function B(t){var e=t.mapValue.fields.__previous_value__;return U(e)?B(e):e}function j(t){var e=F(t.mapValue.fields.__local_write_time__.timestampValue);return new S(e.seconds,e.nanos)}function K(t){return null==t}function G(t){return 0===t&&1/t==-1/0}function Q(t){return"number"==typeof t&&Number.isInteger(t)&&!G(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}var z=function(){function t(t){this.path=t}return t.fromPath=function(e){return new t(C.fromString(e))},t.fromName=function(e){return new t(C.fromString(e).popFirst(5))},t.prototype.hasCollectionId=function(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t},t.prototype.isEqual=function(t){return null!==t&&0===C.comparator(this.path,t.path)},t.prototype.toString=function(){return this.path.toString()},t.comparator=function(t,e){return C.comparator(t.path,e.path)},t.isDocumentKey=function(t){return t.length%2==0},t.fromSegments=function(e){return new t(new C(e.slice()))},t}();function W(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?U(t)?4:10:m()}function H(t,e){var n=W(t);if(n!==W(e))return!1;switch(n){case 0:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return j(t).isEqual(j(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;var n=F(t.timestampValue),r=F(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return q(t.bytesValue).isEqual(q(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return V(t.geoPointValue.latitude)===V(e.geoPointValue.latitude)&&V(t.geoPointValue.longitude)===V(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return V(t.integerValue)===V(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){var n=V(t.doubleValue),r=V(e.doubleValue);return n===r?G(n)===G(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return E(t.arrayValue.values||[],e.arrayValue.values||[],H);case 10:return function(t,e){var n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(D(n)!==D(r))return!1;for(var i in n)if(n.hasOwnProperty(i)&&(void 0===r[i]||!H(n[i],r[i])))return!1;return!0}(t,e);default:return m()}}function Y(t,e){return void 0!==(t.values||[]).find((function(t){return H(t,e)}))}function $(t,e){var n=W(t),r=W(e);if(n!==r)return I(n,r);switch(n){case 0:return 0;case 1:return I(t.booleanValue,e.booleanValue);case 2:return function(t,e){var n=V(t.integerValue||t.doubleValue),r=V(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return X(t.timestampValue,e.timestampValue);case 4:return X(j(t),j(e));case 5:return I(t.stringValue,e.stringValue);case 6:return function(t,e){var n=q(t),r=q(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){for(var n=t.split("/"),r=e.split("/"),i=0;i<n.length&&i<r.length;i++){var o=I(n[i],r[i]);if(0!==o)return o}return I(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){var n=I(V(t.latitude),V(e.latitude));return 0!==n?n:I(V(t.longitude),V(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){for(var n=t.values||[],r=e.values||[],i=0;i<n.length&&i<r.length;++i){var o=$(n[i],r[i]);if(o)return o}return I(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){var n=t.fields||{},r=Object.keys(n),i=e.fields||{},o=Object.keys(i);r.sort(),o.sort();for(var s=0;s<r.length&&s<o.length;++s){var a=I(r[s],o[s]);if(0!==a)return a;var u=$(n[r[s]],i[o[s]]);if(0!==u)return u}return I(r.length,o.length)}(t.mapValue,e.mapValue);default:throw m()}}function X(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return I(t,e);var n=F(t),r=F(e),i=I(n.seconds,r.seconds);return 0!==i?i:I(n.nanos,r.nanos)}function J(t){return Z(t)}function Z(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){var e=F(t);return"time("+e.seconds+","+e.nanos+")"}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?q(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,z.fromName(n).toString()):"geoPointValue"in t?"geo("+(e=t.geoPointValue).latitude+","+e.longitude+")":"arrayValue"in t?function(t){for(var e="[",n=!0,r=0,i=t.values||[];r<i.length;r++)n?n=!1:e+=",",e+=Z(i[r]);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){for(var e="{",n=!0,r=0,i=Object.keys(t.fields||{}).sort();r<i.length;r++){var o=i[r];n?n=!1:e+=",",e+=o+":"+Z(t.fields[o])}return e+"}"}(t.mapValue):m();var e,n}function tt(t,e){return{referenceValue:"projects/"+t.projectId+"/databases/"+t.database+"/documents/"+e.path.canonicalString()}}function et(t){return!!t&&"integerValue"in t}function nt(t){return!!t&&"arrayValue"in t}function rt(t){return!!t&&"nullValue"in t}function it(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function ot(t){return!!t&&"mapValue"in t}function st(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue)return{timestampValue:Object.assign({},F(t.timestampValue))};if(t.mapValue){var e={mapValue:{fields:{}}};return A(t.mapValue.fields,(function(t,n){return e.mapValue.fields[t]=st(n)})),e}if(t.arrayValue){for(var n={arrayValue:{values:[]}},r=0;r<(t.arrayValue.values||[]).length;++r)n.arrayValue.values[r]=st(t.arrayValue.values[r]);return n}return Object.assign({},t)}var at=function(){function t(t){this.value=t}return t.empty=function(){return new t({mapValue:{}})},t.prototype.field=function(t){if(t.isEmpty())return this.value;for(var e=this.value,n=0;n<t.length-1;++n)if(!ot(e=(e.mapValue.fields||{})[t.get(n)]))return null;return(e=(e.mapValue.fields||{})[t.lastSegment()])||null},t.prototype.set=function(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=st(e)},t.prototype.setAll=function(t){var e=this,n=L.emptyPath(),r={},i=[];t.forEach((function(t,o){if(!n.isImmediateParentOf(o)){var s=e.getFieldsMap(n);e.applyChanges(s,r,i),r={},i=[],n=o.popLast()}t?r[o.lastSegment()]=st(t):i.push(o.lastSegment())}));var o=this.getFieldsMap(n);this.applyChanges(o,r,i)},t.prototype.delete=function(t){var e=this.field(t.popLast());ot(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]},t.prototype.isEqual=function(t){return H(this.value,t.value)},t.prototype.getFieldsMap=function(t){var e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(var n=0;n<t.length;++n){var r=e.mapValue.fields[t.get(n)];ot(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields},t.prototype.applyChanges=function(t,e,n){A(e,(function(e,n){return t[e]=n}));for(var r=0,i=n;r<i.length;r++){var o=i[r];delete t[o]}},t.prototype.clone=function(){return new t(st(this.value))},t}();function ut(t){var e=[];return A(t.fields,(function(t,n){var r=new L([t]);if(ot(n)){var i=ut(n.mapValue).fields;if(0===i.length)e.push(r);else for(var o=0,s=i;o<s.length;o++){var a=s[o];e.push(r.child(a))}}else e.push(r)})),new O(e)}var ct=function(){function t(t,e,n,r,i){this.key=t,this.documentType=e,this.version=n,this.data=r,this.documentState=i}return t.newInvalidDocument=function(e){return new t(e,0,N.min(),at.empty(),0)},t.newFoundDocument=function(e,n,r){return new t(e,1,n,r,0)},t.newNoDocument=function(e,n){return new t(e,2,n,at.empty(),0)},t.newUnknownDocument=function(e,n){return new t(e,3,n,at.empty(),2)},t.prototype.convertToFoundDocument=function(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this},t.prototype.convertToNoDocument=function(t){return this.version=t,this.documentType=2,this.data=at.empty(),this.documentState=0,this},t.prototype.convertToUnknownDocument=function(t){return this.version=t,this.documentType=3,this.data=at.empty(),this.documentState=2,this},t.prototype.setHasCommittedMutations=function(){return this.documentState=2,this},t.prototype.setHasLocalMutations=function(){return this.documentState=1,this},Object.defineProperty(t.prototype,"hasLocalMutations",{get:function(){return 1===this.documentState},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasCommittedMutations",{get:function(){return 2===this.documentState},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!1,configurable:!0}),t.prototype.isValidDocument=function(){return 0!==this.documentType},t.prototype.isFoundDocument=function(){return 1===this.documentType},t.prototype.isNoDocument=function(){return 2===this.documentType},t.prototype.isUnknownDocument=function(){return 3===this.documentType},t.prototype.isEqual=function(e){return e instanceof t&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)},t.prototype.clone=function(){return new t(this.key,this.documentType,this.version,this.data.clone(),this.documentState)},t.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+JSON.stringify(this.data.value)+", {documentType: "+this.documentType+"}), {documentState: "+this.documentState+"})"},t}(),ht=function(t,e,n,r,i,o,s){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===s&&(s=null),this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=s,this.h=null};function ft(t,e,n,r,i,o,s){return void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===s&&(s=null),new ht(t,e,n,r,i,o,s)}function lt(t){var e=_(t);if(null===e.h){var n=e.path.canonicalString();null!==e.collectionGroup&&(n+="|cg:"+e.collectionGroup),n+="|f:",n+=e.filters.map((function(t){return function(t){return t.field.canonicalString()+t.op.toString()+J(t.value)}(t)})).join(","),n+="|ob:",n+=e.orderBy.map((function(t){return function(t){return t.field.canonicalString()+t.dir}(t)})).join(","),K(e.limit)||(n+="|l:",n+=e.limit),e.startAt&&(n+="|lb:",n+=St(e.startAt)),e.endAt&&(n+="|ub:",n+=St(e.endAt)),e.h=n}return e.h}function dt(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(var n=0;n<t.orderBy.length;n++)if(!Dt(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(var r=0;r<t.filters.length;r++)if(i=t.filters[r],o=e.filters[r],i.op!==o.op||!i.field.isEqual(o.field)||!H(i.value,o.value))return!1;var i,o;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!kt(t.startAt,e.startAt)&&kt(t.endAt,e.endAt)}function pt(t){return z.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}var yt=function(t){function e(e,n,r){var i=this;return(i=t.call(this)||this).field=e,i.op=n,i.value=r,i}return(0,s.__extends)(e,t),e.create=function(t,n,r){return t.isKeyField()?"in"===n||"not-in"===n?this.l(t,n,r):new vt(t,n,r):"array-contains"===n?new wt(t,r):"in"===n?new bt(t,r):"not-in"===n?new It(t,r):"array-contains-any"===n?new Et(t,r):new e(t,n,r)},e.l=function(t,e,n){return"in"===e?new mt(t,n):new gt(t,n)},e.prototype.matches=function(t){var e=t.data.field(this.field);return"!="===this.op?null!==e&&this.m($(e,this.value)):null!==e&&W(this.value)===W(e)&&this.m($(e,this.value))},e.prototype.m=function(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return m()}},e.prototype.g=function(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0},e}((function(){})),vt=function(t){function e(e,n,r){var i=this;return(i=t.call(this,e,n,r)||this).key=z.fromName(r.referenceValue),i}return(0,s.__extends)(e,t),e.prototype.matches=function(t){var e=z.comparator(t.key,this.key);return this.m(e)},e}(yt),mt=function(t){function e(e,n){var r=this;return(r=t.call(this,e,"in",n)||this).keys=_t("in",n),r}return(0,s.__extends)(e,t),e.prototype.matches=function(t){return this.keys.some((function(e){return e.isEqual(t.key)}))},e}(yt),gt=function(t){function e(e,n){var r=this;return(r=t.call(this,e,"not-in",n)||this).keys=_t("not-in",n),r}return(0,s.__extends)(e,t),e.prototype.matches=function(t){return!this.keys.some((function(e){return e.isEqual(t.key)}))},e}(yt);function _t(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((function(t){return z.fromName(t.referenceValue)}))}var wt=function(t){function e(e,n){return t.call(this,e,"array-contains",n)||this}return(0,s.__extends)(e,t),e.prototype.matches=function(t){var e=t.data.field(this.field);return nt(e)&&Y(e.arrayValue,this.value)},e}(yt),bt=function(t){function e(e,n){return t.call(this,e,"in",n)||this}return(0,s.__extends)(e,t),e.prototype.matches=function(t){var e=t.data.field(this.field);return null!==e&&Y(this.value.arrayValue,e)},e}(yt),It=function(t){function e(e,n){return t.call(this,e,"not-in",n)||this}return(0,s.__extends)(e,t),e.prototype.matches=function(t){if(Y(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var e=t.data.field(this.field);return null!==e&&!Y(this.value.arrayValue,e)},e}(yt),Et=function(t){function e(e,n){return t.call(this,e,"array-contains-any",n)||this}return(0,s.__extends)(e,t),e.prototype.matches=function(t){var e=this,n=t.data.field(this.field);return!(!nt(n)||!n.arrayValue.values)&&n.arrayValue.values.some((function(t){return Y(e.value.arrayValue,t)}))},e}(yt),Tt=function(t,e){this.position=t,this.before=e};function St(t){return(t.before?"b":"a")+":"+t.position.map((function(t){return J(t)})).join(",")}var Nt=function(t,e){void 0===e&&(e="asc"),this.field=t,this.dir=e};function Dt(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function At(t,e,n){for(var r=0,i=0;i<t.position.length;i++){var o=e[i],s=t.position[i];if(r=o.field.isKeyField()?z.comparator(z.fromName(s.referenceValue),n.key):$(s,n.data.field(o.field)),"desc"===o.dir&&(r*=-1),0!==r)break}return t.before?r<=0:r<0}function kt(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.before!==e.before||t.position.length!==e.position.length)return!1;for(var n=0;n<t.position.length;n++)if(!H(t.position[n],e.position[n]))return!1;return!0}var xt=function(t,e,n,r,i,o,s,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o="F"),void 0===s&&(s=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=o,this.startAt=s,this.endAt=a,this.p=null,this.T=null,this.startAt,this.endAt};function Ct(t,e,n,r,i,o,s,a){return new xt(t,e,n,r,i,o,s,a)}function Rt(t){return new xt(t)}function Lt(t){return!K(t.limit)&&"F"===t.limitType}function Ot(t){return!K(t.limit)&&"L"===t.limitType}function Pt(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Mt(t){for(var e=0,n=t.filters;e<n.length;e++){var r=n[e];if(r.g())return r.field}return null}function Ft(t){return null!==t.collectionGroup}function Vt(t){var e=_(t);if(null===e.p){e.p=[];var n=Mt(e),r=Pt(e);if(null!==n&&null===r)n.isKeyField()||e.p.push(new Nt(n)),e.p.push(new Nt(L.keyField(),"asc"));else{for(var i=!1,o=0,s=e.explicitOrderBy;o<s.length;o++){var a=s[o];e.p.push(a),a.field.isKeyField()&&(i=!0)}if(!i){var u=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.p.push(new Nt(L.keyField(),u))}}}return e.p}function qt(t){var e=_(t);if(!e.T)if("F"===e.limitType)e.T=ft(e.path,e.collectionGroup,Vt(e),e.filters,e.limit,e.startAt,e.endAt);else{for(var n=[],r=0,i=Vt(e);r<i.length;r++){var o=i[r],s="desc"===o.dir?"asc":"desc";n.push(new Nt(o.field,s))}var a=e.endAt?new Tt(e.endAt.position,!e.endAt.before):null,u=e.startAt?new Tt(e.startAt.position,!e.startAt.before):null;e.T=ft(e.path,e.collectionGroup,n,e.filters,e.limit,a,u)}return e.T}function Ut(t,e,n){return new xt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Bt(t,e){return dt(qt(t),qt(e))&&t.limitType===e.limitType}function jt(t){return lt(qt(t))+"|lt:"+t.limitType}function Kt(t){return"Query(target="+function(t){var e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=", filters: ["+t.filters.map((function(t){return(e=t).field.canonicalString()+" "+e.op+" "+J(e.value);var e})).join(", ")+"]"),K(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=", orderBy: ["+t.orderBy.map((function(t){return function(t){return t.field.canonicalString()+" ("+t.dir+")"}(t)})).join(", ")+"]"),t.startAt&&(e+=", startAt: "+St(t.startAt)),t.endAt&&(e+=", endAt: "+St(t.endAt)),"Target("+e+")"}(qt(t))+"; limitType="+t.limitType+")"}function Gt(t,e){return e.isFoundDocument()&&function(t,e){var n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):z.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(var n=0,r=t.explicitOrderBy;n<r.length;n++){var i=r[n];if(!i.field.isKeyField()&&null===e.data.field(i.field))return!1}return!0}(t,e)&&function(t,e){for(var n=0,r=t.filters;n<r.length;n++)if(!r[n].matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!At(t.startAt,Vt(t),e)||t.endAt&&At(t.endAt,Vt(t),e))}(t,e)}function Qt(t){return function(e,n){for(var r=!1,i=0,o=Vt(t);i<o.length;i++){var s=o[i],a=zt(s,e,n);if(0!==a)return a;r=r||s.field.isKeyField()}return 0}}function zt(t,e,n){var r=t.field.isKeyField()?z.comparator(e.key,n.key):function(t,e,n){var r=e.data.field(t),i=n.data.field(t);return null!==r&&null!==i?$(r,i):m()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return m()}}function Wt(t,e){if(t.I){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:G(e)?"-0":e}}function Ht(t){return{integerValue:""+t}}function Yt(t,e){return Q(e)?Ht(e):Wt(t,e)}var $t=function(){this._=void 0};function Xt(t,e,n){return t instanceof te?function(t,e){var n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof ee?ne(t,e):t instanceof re?ie(t,e):function(t,e){var n=Zt(t,e),r=se(n)+se(t.A);return et(n)&&et(t.A)?Ht(r):Wt(t.R,r)}(t,e)}function Jt(t,e,n){return t instanceof ee?ne(t,e):t instanceof re?ie(t,e):n}function Zt(t,e){return t instanceof oe?et(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}var te=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,s.__extends)(e,t),e}($t),ee=function(t){function e(e){var n=this;return(n=t.call(this)||this).elements=e,n}return(0,s.__extends)(e,t),e}($t);function ne(t,e){for(var n=ae(e),r=function(t){n.some((function(e){return H(e,t)}))||n.push(t)},i=0,o=t.elements;i<o.length;i++)r(o[i]);return{arrayValue:{values:n}}}var re=function(t){function e(e){var n=this;return(n=t.call(this)||this).elements=e,n}return(0,s.__extends)(e,t),e}($t);function ie(t,e){for(var n=ae(e),r=function(t){n=n.filter((function(e){return!H(e,t)}))},i=0,o=t.elements;i<o.length;i++)r(o[i]);return{arrayValue:{values:n}}}var oe=function(t){function e(e,n){var r=this;return(r=t.call(this)||this).R=e,r.A=n,r}return(0,s.__extends)(e,t),e}($t);function se(t){return V(t.integerValue||t.doubleValue)}function ae(t){return nt(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}var ue=function(t,e){this.field=t,this.transform=e},ce=function(t,e){this.version=t,this.transformResults=e},he=function(){function t(t,e){this.updateTime=t,this.exists=e}return t.none=function(){return new t},t.exists=function(e){return new t(void 0,e)},t.updateTime=function(e){return new t(e)},Object.defineProperty(t.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!1,configurable:!0}),t.prototype.isEqual=function(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)},t}();function fe(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}var le=function(){};function de(t,e,n){t instanceof ge?function(t,e,n){var r=t.value.clone(),i=be(t.fieldTransforms,e,n.transformResults);r.setAll(i),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof _e?function(t,e,n){if(fe(t.precondition,e)){var r=be(t.fieldTransforms,e,n.transformResults),i=e.data;i.setAll(we(t)),i.setAll(r),e.convertToFoundDocument(n.version,i).setHasCommittedMutations()}else e.convertToUnknownDocument(n.version)}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function pe(t,e,n){t instanceof ge?function(t,e,n){if(fe(t.precondition,e)){var r=t.value.clone(),i=Ie(t.fieldTransforms,n,e);r.setAll(i),e.convertToFoundDocument(me(e),r).setHasLocalMutations()}}(t,e,n):t instanceof _e?function(t,e,n){if(fe(t.precondition,e)){var r=Ie(t.fieldTransforms,n,e),i=e.data;i.setAll(we(t)),i.setAll(r),e.convertToFoundDocument(me(e),i).setHasLocalMutations()}}(t,e,n):function(t,e){fe(t.precondition,e)&&e.convertToNoDocument(N.min())}(t,e)}function ye(t,e){for(var n=null,r=0,i=t.fieldTransforms;r<i.length;r++){var o=i[r],s=e.data.field(o.field),a=Zt(o.transform,s||null);null!=a&&(null==n&&(n=at.empty()),n.set(o.field,a))}return n||null}function ve(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&E(t,e,(function(t,e){return function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof ee&&e instanceof ee||t instanceof re&&e instanceof re?E(t.elements,e.elements,H):t instanceof oe&&e instanceof oe?H(t.A,e.A):t instanceof te&&e instanceof te}(t.transform,e.transform)}(t,e)}))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}function me(t){return t.isFoundDocument()?t.version:N.min()}var ge=function(t){function e(e,n,r,i){void 0===i&&(i=[]);var o=this;return(o=t.call(this)||this).key=e,o.value=n,o.precondition=r,o.fieldTransforms=i,o.type=0,o}return(0,s.__extends)(e,t),e}(le),_e=function(t){function e(e,n,r,i,o){void 0===o&&(o=[]);var s=this;return(s=t.call(this)||this).key=e,s.data=n,s.fieldMask=r,s.precondition=i,s.fieldTransforms=o,s.type=1,s}return(0,s.__extends)(e,t),e}(le);function we(t){var e=new Map;return t.fieldMask.fields.forEach((function(n){if(!n.isEmpty()){var r=t.data.field(n);e.set(n,r)}})),e}function be(t,e,n){var r=new Map;g(t.length===n.length);for(var i=0;i<n.length;i++){var o=t[i],s=o.transform,a=e.data.field(o.field);r.set(o.field,Jt(s,a,n[i]))}return r}function Ie(t,e,n){for(var r=new Map,i=0,o=t;i<o.length;i++){var s=o[i],a=s.transform,u=n.data.field(s.field);r.set(s.field,Xt(a,u,e))}return r}var Ee,Te,Se=function(t){function e(e,n){var r=this;return(r=t.call(this)||this).key=e,r.precondition=n,r.type=2,r.fieldTransforms=[],r}return(0,s.__extends)(e,t),e}(le),Ne=function(t){function e(e,n){var r=this;return(r=t.call(this)||this).key=e,r.precondition=n,r.type=3,r.fieldTransforms=[],r}return(0,s.__extends)(e,t),e}(le),De=function(t){this.count=t};function Ae(t){switch(t){case c.OK:return m();case c.CANCELLED:case c.UNKNOWN:case c.DEADLINE_EXCEEDED:case c.RESOURCE_EXHAUSTED:case c.INTERNAL:case c.UNAVAILABLE:case c.UNAUTHENTICATED:return!1;case c.INVALID_ARGUMENT:case c.NOT_FOUND:case c.ALREADY_EXISTS:case c.PERMISSION_DENIED:case c.FAILED_PRECONDITION:case c.ABORTED:case c.OUT_OF_RANGE:case c.UNIMPLEMENTED:case c.DATA_LOSS:return!0;default:return m()}}function ke(t){if(void 0===t)return p("GRPC error has no .code"),c.UNKNOWN;switch(t){case Ee.OK:return c.OK;case Ee.CANCELLED:return c.CANCELLED;case Ee.UNKNOWN:return c.UNKNOWN;case Ee.DEADLINE_EXCEEDED:return c.DEADLINE_EXCEEDED;case Ee.RESOURCE_EXHAUSTED:return c.RESOURCE_EXHAUSTED;case Ee.INTERNAL:return c.INTERNAL;case Ee.UNAVAILABLE:return c.UNAVAILABLE;case Ee.UNAUTHENTICATED:return c.UNAUTHENTICATED;case Ee.INVALID_ARGUMENT:return c.INVALID_ARGUMENT;case Ee.NOT_FOUND:return c.NOT_FOUND;case Ee.ALREADY_EXISTS:return c.ALREADY_EXISTS;case Ee.PERMISSION_DENIED:return c.PERMISSION_DENIED;case Ee.FAILED_PRECONDITION:return c.FAILED_PRECONDITION;case Ee.ABORTED:return c.ABORTED;case Ee.OUT_OF_RANGE:return c.OUT_OF_RANGE;case Ee.UNIMPLEMENTED:return c.UNIMPLEMENTED;case Ee.DATA_LOSS:return c.DATA_LOSS;default:return m()}}(Te=Ee||(Ee={}))[Te.OK=0]="OK",Te[Te.CANCELLED=1]="CANCELLED",Te[Te.UNKNOWN=2]="UNKNOWN",Te[Te.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Te[Te.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Te[Te.NOT_FOUND=5]="NOT_FOUND",Te[Te.ALREADY_EXISTS=6]="ALREADY_EXISTS",Te[Te.PERMISSION_DENIED=7]="PERMISSION_DENIED",Te[Te.UNAUTHENTICATED=16]="UNAUTHENTICATED",Te[Te.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Te[Te.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Te[Te.ABORTED=10]="ABORTED",Te[Te.OUT_OF_RANGE=11]="OUT_OF_RANGE",Te[Te.UNIMPLEMENTED=12]="UNIMPLEMENTED",Te[Te.INTERNAL=13]="INTERNAL",Te[Te.UNAVAILABLE=14]="UNAVAILABLE",Te[Te.DATA_LOSS=15]="DATA_LOSS";var xe=function(){function t(t,e){this.comparator=t,this.root=e||Re.EMPTY}return t.prototype.insert=function(e,n){return new t(this.comparator,this.root.insert(e,n,this.comparator).copy(null,null,Re.BLACK,null,null))},t.prototype.remove=function(e){return new t(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Re.BLACK,null,null))},t.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null},t.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1},t.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(t.prototype,"size",{get:function(){return this.root.size},enumerable:!1,configurable:!0}),t.prototype.minKey=function(){return this.root.minKey()},t.prototype.maxKey=function(){return this.root.maxKey()},t.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},t.prototype.forEach=function(t){this.inorderTraversal((function(e,n){return t(e,n),!1}))},t.prototype.toString=function(){var t=[];return this.inorderTraversal((function(e,n){return t.push(e+":"+n),!1})),"{"+t.join(", ")+"}"},t.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},t.prototype.getIterator=function(){return new Ce(this.root,null,this.comparator,!1)},t.prototype.getIteratorFrom=function(t){return new Ce(this.root,t,this.comparator,!1)},t.prototype.getReverseIterator=function(){return new Ce(this.root,null,this.comparator,!0)},t.prototype.getReverseIteratorFrom=function(t){return new Ce(this.root,t,this.comparator,!0)},t}(),Ce=function(){function t(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}return t.prototype.getNext=function(){var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},t.prototype.hasNext=function(){return this.nodeStack.length>0},t.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},t}(),Re=function(){function t(e,n,r,i,o){this.key=e,this.value=n,this.color=null!=r?r:t.RED,this.left=null!=i?i:t.EMPTY,this.right=null!=o?o:t.EMPTY,this.size=this.left.size+1+this.right.size}return t.prototype.copy=function(e,n,r,i,o){return new t(null!=e?e:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=o?o:this.right)},t.prototype.isEmpty=function(){return!1},t.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},t.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},t.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},t.prototype.minKey=function(){return this.min().key},t.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},t.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},t.prototype.removeMin=function(){if(this.left.isEmpty())return t.EMPTY;var e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()},t.prototype.remove=function(e,n){var r,i=this;if(n(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,n),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===n(e,i.key)){if(i.right.isEmpty())return t.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,n))}return i.fixUp()},t.prototype.isRed=function(){return this.color},t.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},t.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},t.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},t.prototype.rotateLeft=function(){var e=this.copy(null,null,t.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},t.prototype.rotateRight=function(){var e=this.copy(null,null,t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},t.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},t.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},t.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw m();if(this.right.isRed())throw m();var t=this.left.check();if(t!==this.right.check())throw m();return t+(this.isRed()?0:1)},t}();Re.EMPTY=null,Re.RED=!0,Re.BLACK=!1,Re.EMPTY=new(function(){function t(){this.size=0}return Object.defineProperty(t.prototype,"key",{get:function(){throw m()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){throw m()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){throw m()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"left",{get:function(){throw m()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){throw m()},enumerable:!1,configurable:!0}),t.prototype.copy=function(t,e,n,r,i){return this},t.prototype.insert=function(t,e,n){return new Re(t,e)},t.prototype.remove=function(t,e){return this},t.prototype.isEmpty=function(){return!0},t.prototype.inorderTraversal=function(t){return!1},t.prototype.reverseTraversal=function(t){return!1},t.prototype.minKey=function(){return null},t.prototype.maxKey=function(){return null},t.prototype.isRed=function(){return!1},t.prototype.checkMaxDepth=function(){return!0},t.prototype.check=function(){return 0},t}());var Le=function(){function t(t){this.comparator=t,this.data=new xe(this.comparator)}return t.prototype.has=function(t){return null!==this.data.get(t)},t.prototype.first=function(){return this.data.minKey()},t.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(t.prototype,"size",{get:function(){return this.data.size},enumerable:!1,configurable:!0}),t.prototype.indexOf=function(t){return this.data.indexOf(t)},t.prototype.forEach=function(t){this.data.inorderTraversal((function(e,n){return t(e),!1}))},t.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}},t.prototype.forEachWhile=function(t,e){var n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return},t.prototype.firstAfterOrEqual=function(t){var e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null},t.prototype.getIterator=function(){return new Oe(this.data.getIterator())},t.prototype.getIteratorFrom=function(t){return new Oe(this.data.getIteratorFrom(t))},t.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},t.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},t.prototype.isEmpty=function(){return this.data.isEmpty()},t.prototype.unionWith=function(t){var e=this;return e.size<t.size&&(e=t,t=this),t.forEach((function(t){e=e.add(t)})),e},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.data.getIterator(),r=e.data.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(0!==this.comparator(i,o))return!1}return!0},t.prototype.toArray=function(){var t=[];return this.forEach((function(e){t.push(e)})),t},t.prototype.toString=function(){var t=[];return this.forEach((function(e){return t.push(e)})),"SortedSet("+t.toString()+")"},t.prototype.copy=function(e){var n=new t(this.comparator);return n.data=e,n},t}(),Oe=function(){function t(t){this.iter=t}return t.prototype.getNext=function(){return this.iter.getNext().key},t.prototype.hasNext=function(){return this.iter.hasNext()},t}(),Pe=new xe(z.comparator);function Me(){return Pe}var Fe=new xe(z.comparator);function Ve(){return Fe}var qe=new xe(z.comparator);function Ue(){return qe}var Be=new Le(z.comparator);function je(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=Be,r=0,i=t;r<i.length;r++){var o=i[r];n=n.add(o)}return n}var Ke=new Le(I);function Ge(){return Ke}var Qe=function(){function t(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}return t.createSynthesizedRemoteEventForCurrentChange=function(e,n){var r=new Map;return r.set(e,ze.createSynthesizedTargetChangeForCurrentChange(e,n)),new t(N.min(),r,Ge(),Me(),je())},t}(),ze=function(){function t(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}return t.createSynthesizedTargetChangeForCurrentChange=function(e,n){return new t(P.EMPTY_BYTE_STRING,n,je(),je(),je())},t}(),We=function(t,e,n,r){this.v=t,this.removedTargetIds=e,this.key=n,this.P=r},He=function(t,e){this.targetId=t,this.V=e},Ye=function(t,e,n,r){void 0===n&&(n=P.EMPTY_BYTE_STRING),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r},$e=function(){function t(){this.S=0,this.D=Ze(),this.C=P.EMPTY_BYTE_STRING,this.N=!1,this.F=!0}return Object.defineProperty(t.prototype,"current",{get:function(){return this.N},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"resumeToken",{get:function(){return this.C},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"k",{get:function(){return 0!==this.S},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"$",{get:function(){return this.F},enumerable:!1,configurable:!0}),t.prototype.O=function(t){t.approximateByteSize()>0&&(this.F=!0,this.C=t)},t.prototype.M=function(){var t=je(),e=je(),n=je();return this.D.forEach((function(r,i){switch(i){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:m()}})),new ze(this.C,this.N,t,e,n)},t.prototype.L=function(){this.F=!1,this.D=Ze()},t.prototype.B=function(t,e){this.F=!0,this.D=this.D.insert(t,e)},t.prototype.q=function(t){this.F=!0,this.D=this.D.remove(t)},t.prototype.U=function(){this.S+=1},t.prototype.K=function(){this.S-=1},t.prototype.j=function(){this.F=!0,this.N=!0},t}(),Xe=function(){function t(t){this.W=t,this.G=new Map,this.H=Me(),this.J=Je(),this.Y=new Le(I)}return t.prototype.X=function(t){for(var e=0,n=t.v;e<n.length;e++){var r=n[e];t.P&&t.P.isFoundDocument()?this.Z(r,t.P):this.tt(r,t.key,t.P)}for(var i=0,o=t.removedTargetIds;i<o.length;i++)r=o[i],this.tt(r,t.key,t.P)},t.prototype.et=function(t){var e=this;this.forEachTarget(t,(function(n){var r=e.nt(n);switch(t.state){case 0:e.st(n)&&r.O(t.resumeToken);break;case 1:r.K(),r.k||r.L(),r.O(t.resumeToken);break;case 2:r.K(),r.k||e.removeTarget(n);break;case 3:e.st(n)&&(r.j(),r.O(t.resumeToken));break;case 4:e.st(n)&&(e.it(n),r.O(t.resumeToken));break;default:m()}}))},t.prototype.forEachTarget=function(t,e){var n=this;t.targetIds.length>0?t.targetIds.forEach(e):this.G.forEach((function(t,r){n.st(r)&&e(r)}))},t.prototype.rt=function(t){var e=t.targetId,n=t.V.count,r=this.ot(e);if(r){var i=r.target;if(pt(i))if(0===n){var o=new z(i.path);this.tt(e,o,ct.newNoDocument(o,N.min()))}else g(1===n);else this.ct(e)!==n&&(this.it(e),this.Y=this.Y.add(e))}},t.prototype.ut=function(t){var e=this,n=new Map;this.G.forEach((function(r,i){var o=e.ot(i);if(o){if(r.current&&pt(o.target)){var s=new z(o.target.path);null!==e.H.get(s)||e.at(i,s)||e.tt(i,s,ct.newNoDocument(s,t))}r.$&&(n.set(i,r.M()),r.L())}}));var r=je();this.J.forEach((function(t,n){var i=!0;n.forEachWhile((function(t){var n=e.ot(t);return!n||2===n.purpose||(i=!1,!1)})),i&&(r=r.add(t))}));var i=new Qe(t,n,this.Y,this.H,r);return this.H=Me(),this.J=Je(),this.Y=new Le(I),i},t.prototype.Z=function(t,e){if(this.st(t)){var n=this.at(t,e.key)?2:0;this.nt(t).B(e.key,n),this.H=this.H.insert(e.key,e),this.J=this.J.insert(e.key,this.ht(e.key).add(t))}},t.prototype.tt=function(t,e,n){if(this.st(t)){var r=this.nt(t);this.at(t,e)?r.B(e,1):r.q(e),this.J=this.J.insert(e,this.ht(e).delete(t)),n&&(this.H=this.H.insert(e,n))}},t.prototype.removeTarget=function(t){this.G.delete(t)},t.prototype.ct=function(t){var e=this.nt(t).M();return this.W.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},t.prototype.U=function(t){this.nt(t).U()},t.prototype.nt=function(t){var e=this.G.get(t);return e||(e=new $e,this.G.set(t,e)),e},t.prototype.ht=function(t){var e=this.J.get(t);return e||(e=new Le(I),this.J=this.J.insert(t,e)),e},t.prototype.st=function(t){var e=null!==this.ot(t);return e||d("WatchChangeAggregator","Detected inactive target",t),e},t.prototype.ot=function(t){var e=this.G.get(t);return e&&e.k?null:this.W.lt(t)},t.prototype.it=function(t){var e=this;this.G.set(t,new $e),this.W.getRemoteKeysForTarget(t).forEach((function(n){e.tt(t,n,null)}))},t.prototype.at=function(t,e){return this.W.getRemoteKeysForTarget(t).has(e)},t}();function Je(){return new xe(z.comparator)}function Ze(){return new xe(z.comparator)}var tn={asc:"ASCENDING",desc:"DESCENDING"},en={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},nn=function(t,e){this.databaseId=t,this.I=e};function rn(t,e){return t.I?new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")+"."+("000000000"+e.nanoseconds).slice(-9)+"Z":{seconds:""+e.seconds,nanos:e.nanoseconds}}function on(t,e){return t.I?e.toBase64():e.toUint8Array()}function sn(t,e){return rn(t,e.toTimestamp())}function an(t){return g(!!t),N.fromTimestamp(function(t){var e=F(t);return new S(e.seconds,e.nanos)}(t))}function un(t,e){return function(t){return new C(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function cn(t){var e=C.fromString(t);return g(Ln(e)),e}function hn(t,e){return un(t.databaseId,e.path)}function fn(t,e){var n=cn(e);if(n.get(1)!==t.databaseId.projectId)throw new h(c.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new h(c.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new z(yn(n))}function ln(t,e){return un(t.databaseId,e)}function dn(t){var e=cn(t);return 4===e.length?C.emptyPath():yn(e)}function pn(t){return new C(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function yn(t){return g(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function vn(t,e,n){return{name:hn(t,e),fields:n.value.mapValue.fields}}function mn(t,e,n){var r=fn(t,e.name),i=an(e.updateTime),o=new at({mapValue:{fields:e.fields}}),s=ct.newFoundDocument(r,i,o);return n&&s.setHasCommittedMutations(),n?s.setHasCommittedMutations():s}function gn(t,e){var n;if(e instanceof ge)n={update:vn(t,e.key,e.value)};else if(e instanceof Se)n={delete:hn(t,e.key)};else if(e instanceof _e)n={update:vn(t,e.key,e.data),updateMask:Rn(e.fieldMask)};else{if(!(e instanceof Ne))return m();n={verify:hn(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((function(t){return function(t,e){var n=e.transform;if(n instanceof te)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ee)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof re)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof oe)return{fieldPath:e.field.canonicalString(),increment:n.A};throw m()}(0,t)}))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:sn(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:m()}(t,e.precondition)),n}function _n(t,e){var n=e.currentDocument?function(t){return void 0!==t.updateTime?he.updateTime(an(t.updateTime)):void 0!==t.exists?he.exists(t.exists):he.none()}(e.currentDocument):he.none(),r=e.updateTransforms?e.updateTransforms.map((function(e){return function(t,e){var n=null;if("setToServerValue"in e)g("REQUEST_TIME"===e.setToServerValue),n=new te;else if("appendMissingElements"in e){var r=e.appendMissingElements.values||[];n=new ee(r)}else if("removeAllFromArray"in e){var i=e.removeAllFromArray.values||[];n=new re(i)}else"increment"in e?n=new oe(t,e.increment):m();var o=L.fromServerFormat(e.fieldPath);return new ue(o,n)}(t,e)})):[];if(e.update){e.update.name;var i=fn(t,e.update.name),o=new at({mapValue:{fields:e.update.fields}});if(e.updateMask){var s=function(t){var e=t.fieldPaths||[];return new O(e.map((function(t){return L.fromServerFormat(t)})))}(e.updateMask);return new _e(i,o,s,n,r)}return new ge(i,o,n,r)}if(e.delete){var a=fn(t,e.delete);return new Se(a,n)}if(e.verify){var u=fn(t,e.verify);return new Ne(u,n)}return m()}function wn(t,e){return{documents:[ln(t,e.path)]}}function bn(t,e){var n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=ln(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=ln(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var i=function(t){if(0!==t.length){var e=t.map((function(t){return function(t){if("=="===t.op){if(it(t.value))return{unaryFilter:{field:An(t.field),op:"IS_NAN"}};if(rt(t.value))return{unaryFilter:{field:An(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(it(t.value))return{unaryFilter:{field:An(t.field),op:"IS_NOT_NAN"}};if(rt(t.value))return{unaryFilter:{field:An(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:An(t.field),op:Dn(t.op),value:t.value}}}(t)}));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}}(e.filters);i&&(n.structuredQuery.where=i);var o=function(t){if(0!==t.length)return t.map((function(t){return function(t){return{field:An(t.field),direction:Nn(t.dir)}}(t)}))}(e.orderBy);o&&(n.structuredQuery.orderBy=o);var s=function(t,e){return t.I||K(e)?e:{value:e}}(t,e.limit);return null!==s&&(n.structuredQuery.limit=s),e.startAt&&(n.structuredQuery.startAt=Tn(e.startAt)),e.endAt&&(n.structuredQuery.endAt=Tn(e.endAt)),n}function In(t){var e=dn(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;if(r>0){g(1===r);var o=n.from[0];o.allDescendants?i=o.collectionId:e=e.child(o.collectionId)}var s=[];n.where&&(s=En(n.where));var a=[];n.orderBy&&(a=n.orderBy.map((function(t){return function(t){return new Nt(kn(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t)})));var u=null;n.limit&&(u=function(t){var e;return K(e="object"==typeof t?t.value:t)?null:e}(n.limit));var c=null;n.startAt&&(c=Sn(n.startAt));var h=null;return n.endAt&&(h=Sn(n.endAt)),Ct(e,i,a,s,u,"F",c,h)}function En(t){return t?void 0!==t.unaryFilter?[Cn(t)]:void 0!==t.fieldFilter?[xn(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((function(t){return En(t)})).reduce((function(t,e){return t.concat(e)})):m():[]}function Tn(t){return{before:t.before,values:t.position}}function Sn(t){var e=!!t.before,n=t.values||[];return new Tt(n,e)}function Nn(t){return tn[t]}function Dn(t){return en[t]}function An(t){return{fieldPath:t.canonicalString()}}function kn(t){return L.fromServerFormat(t.fieldPath)}function xn(t){return yt.create(kn(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":default:return m()}}(t.fieldFilter.op),t.fieldFilter.value)}function Cn(t){switch(t.unaryFilter.op){case"IS_NAN":var e=kn(t.unaryFilter.field);return yt.create(e,"==",{doubleValue:NaN});case"IS_NULL":var n=kn(t.unaryFilter.field);return yt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var r=kn(t.unaryFilter.field);return yt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":var i=kn(t.unaryFilter.field);return yt.create(i,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":default:return m()}}function Rn(t){var e=[];return t.fields.forEach((function(t){return e.push(t.canonicalString())})),{fieldPaths:e}}function Ln(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function On(t){for(var e="",n=0;n<t.length;n++)e.length>0&&(e=Mn(e)),e=Pn(t.get(n),e);return Mn(e)}function Pn(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+="";break;case"":n+="";break;default:n+=o}}return n}function Mn(t){return t+""}function Fn(t){var e=t.length;if(g(e>=2),2===e)return g(""===t.charAt(0)&&""===t.charAt(1)),C.emptyPath();for(var n=e-2,r=[],i="",o=0;o<e;){var s=t.indexOf("",o);switch((s<0||s>n)&&m(),t.charAt(s+1)){case"":var a=t.substring(o,s),u=void 0;0===i.length?u=a:(u=i+=a,i=""),r.push(u);break;case"":i+=t.substring(o,s),i+="\0";break;case"":i+=t.substring(o,s+1);break;default:m()}o=s+2}return new C(r)}var Vn=function(t,e){this.seconds=t,this.nanoseconds=e},qn=function(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n};qn.store="owner",qn.key="owner";var Un=function(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n};Un.store="mutationQueues",Un.keyPath="userId";var Bn=function(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i};Bn.store="mutations",Bn.keyPath="batchId",Bn.userMutationsIndex="userMutationsIndex",Bn.userMutationsKeyPath=["userId","batchId"];var jn=function(){function t(){}return t.prefixForUser=function(t){return[t]},t.prefixForPath=function(t,e){return[t,On(e)]},t.key=function(t,e,n){return[t,On(e),n]},t}();jn.store="documentMutations",jn.PLACEHOLDER=new jn;var Kn=function(t,e){this.path=t,this.readTime=e},Gn=function(t,e){this.path=t,this.version=e},Qn=function(t,e,n,r,i,o){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=i,this.parentPath=o};Qn.store="remoteDocuments",Qn.readTimeIndex="readTimeIndex",Qn.readTimeIndexPath="readTime",Qn.collectionReadTimeIndex="collectionReadTimeIndex",Qn.collectionReadTimeIndexPath=["parentPath","readTime"];var zn=function(t){this.byteSize=t};zn.store="remoteDocumentGlobal",zn.key="remoteDocumentGlobalKey";var Wn=function(t,e,n,r,i,o,s){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.lastLimboFreeSnapshotVersion=o,this.query=s};Wn.store="targets",Wn.keyPath="targetId",Wn.queryTargetsIndexName="queryTargetsIndex",Wn.queryTargetsKeyPath=["canonicalId","targetId"];var Hn=function(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n};Hn.store="targetDocuments",Hn.keyPath=["targetId","path"],Hn.documentTargetsIndex="documentTargetsIndex",Hn.documentTargetsKeyPath=["path","targetId"];var Yn=function(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r};Yn.key="targetGlobalKey",Yn.store="targetGlobal";var $n=function(t,e){this.collectionId=t,this.parent=e};$n.store="collectionParents",$n.keyPath=["collectionId","parent"];var Xn=function(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r};Xn.store="clientMetadata",Xn.keyPath="clientId";var Jn=function(t,e,n){this.bundleId=t,this.createTime=e,this.version=n};Jn.store="bundles",Jn.keyPath="bundleId";var Zn=function(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n};Zn.store="namedQueries",Zn.keyPath="name";var tr=(0,s.__spreadArray)((0,s.__spreadArray)([],(0,s.__spreadArray)((0,s.__spreadArray)([],(0,s.__spreadArray)((0,s.__spreadArray)([],(0,s.__spreadArray)((0,s.__spreadArray)([],[Un.store,Bn.store,jn.store,Qn.store,Wn.store,qn.store,Yn.store,Hn.store]),[Xn.store])),[zn.store])),[$n.store])),[Jn.store,Zn.store]),er="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",nr=function(){function t(){this.onCommittedListeners=[]}return t.prototype.addOnCommittedListener=function(t){this.onCommittedListeners.push(t)},t.prototype.raiseOnCommittedEvent=function(){this.onCommittedListeners.forEach((function(t){return t()}))},t}(),rr=function(){var t=this;this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))},ir=function(){function t(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)}),(function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)}))}return t.prototype.catch=function(t){return this.next(void 0,t)},t.prototype.next=function(e,n){var r=this;return this.callbackAttached&&m(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(e,this.result):new t((function(t,i){r.nextCallback=function(n){r.wrapSuccess(e,n).next(t,i)},r.catchCallback=function(e){r.wrapFailure(n,e).next(t,i)}}))},t.prototype.toPromise=function(){var t=this;return new Promise((function(e,n){t.next(e,n)}))},t.prototype.wrapUserFunction=function(e){try{var n=e();return n instanceof t?n:t.resolve(n)}catch(e){return t.reject(e)}},t.prototype.wrapSuccess=function(e,n){return e?this.wrapUserFunction((function(){return e(n)})):t.resolve(n)},t.prototype.wrapFailure=function(e,n){return e?this.wrapUserFunction((function(){return e(n)})):t.reject(n)},t.resolve=function(e){return new t((function(t,n){t(e)}))},t.reject=function(e){return new t((function(t,n){n(e)}))},t.waitFor=function(e){return new t((function(t,n){var r=0,i=0,o=!1;e.forEach((function(e){++r,e.next((function(){++i,o&&i===r&&t()}),(function(t){return n(t)}))})),o=!0,i===r&&t()}))},t.or=function(e){for(var n=t.resolve(!1),r=function(e){n=n.next((function(n){return n?t.resolve(n):e()}))},i=0,o=e;i<o.length;i++)r(o[i]);return n},t.forEach=function(t,e){var n=this,r=[];return t.forEach((function(t,i){r.push(e.call(n,t,i))})),this.waitFor(r)},t}(),or=function(){function t(t,e){var n=this;this.action=t,this.transaction=e,this.aborted=!1,this.ft=new rr,this.transaction.oncomplete=function(){n.ft.resolve()},this.transaction.onabort=function(){e.error?n.ft.reject(new ur(t,e.error)):n.ft.resolve()},this.transaction.onerror=function(e){var r=dr(e.target.error);n.ft.reject(new ur(t,r))}}return t.open=function(e,n,r,i){try{return new t(n,e.transaction(i,r))}catch(e){throw new ur(n,e)}},Object.defineProperty(t.prototype,"dt",{get:function(){return this.ft.promise},enumerable:!1,configurable:!0}),t.prototype.abort=function(t){t&&this.ft.reject(t),this.aborted||(d("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},t.prototype.store=function(t){var e=this.transaction.objectStore(t);return new hr(e)},t}(),sr=function(){function t(e,n,i){this.name=e,this.version=n,this.wt=i,12.2===t._t((0,r.getUA)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}return t.delete=function(t){return d("SimpleDb","Removing database:",t),fr(window.indexedDB.deleteDatabase(t)).toPromise()},t.yt=function(){if("undefined"==typeof indexedDB)return!1;if(t.gt())return!0;var e=(0,r.getUA)(),n=t._t(e),i=0<n&&n<10,o=t.Et(e),s=0<o&&o<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||i||s)},t.gt=function(){var t;return void 0!==a&&"YES"===(null===(t={})||void 0===t?void 0:t.Tt)},t.It=function(t,e){return t.store(e)},t._t=function(t){var e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)},t.Et=function(t){var e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)},t.prototype.At=function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e,n=this;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return this.db?[3,2]:(d("SimpleDb","Opening database:",this.name),e=this,[4,new Promise((function(e,r){var i=indexedDB.open(n.name,n.version);i.onsuccess=function(t){var n=t.target.result;e(n)},i.onblocked=function(){r(new ur(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=function(e){var n=e.target.error;"VersionError"===n.name?r(new h(c.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):r(new ur(t,n))},i.onupgradeneeded=function(t){d("SimpleDb",'Database "'+n.name+'" requires upgrade from version:',t.oldVersion);var e=t.target.result;n.wt.Rt(e,i.transaction,t.oldVersion,n.version).next((function(){d("SimpleDb","Database upgrade to version "+n.version+" complete")}))}}))]);case 1:e.db=r.sent(),r.label=2;case 2:return[2,(this.bt&&(this.db.onversionchange=function(t){return n.bt(t)}),this.db)]}}))}))},t.prototype.vt=function(t){this.bt=t,this.db&&(this.db.onversionchange=function(e){return t(e)})},t.prototype.runTransaction=function(t,e,n,r){return(0,s.__awaiter)(this,void 0,void 0,(function(){var i,o,a,u,c;return(0,s.__generator)(this,(function(h){switch(h.label){case 0:i="readonly"===e,o=0,a=function(){var e,a,c,h,f;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:++o,s.label=1;case 1:return s.trys.push([1,4,,5]),[4,u.At(t)];case 2:return u.db=s.sent(),e=or.open(u.db,t,i?"readonly":"readwrite",n),a=r(e).catch((function(t){return e.abort(t),ir.reject(t)})).toPromise(),c={},a.catch((function(){})),[4,e.dt];case 3:return[2,(c.value=(s.sent(),a),c)];case 4:return h=s.sent(),f="FirebaseError"!==h.name&&o<3,d("SimpleDb","Transaction failed with error:",h.message,"Retrying:",f),u.close(),f?[3,5]:[2,{value:Promise.reject(h)}];case 5:return[2]}}))},u=this,h.label=1;case 1:return[5,a()];case 2:if("object"==typeof(c=h.sent()))return[2,c.value];h.label=3;case 3:return[3,1];case 4:return[2]}}))}))},t.prototype.close=function(){this.db&&this.db.close(),this.db=void 0},t}(),ar=function(){function t(t){this.Pt=t,this.Vt=!1,this.St=null}return Object.defineProperty(t.prototype,"isDone",{get:function(){return this.Vt},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Dt",{get:function(){return this.St},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cursor",{set:function(t){this.Pt=t},enumerable:!1,configurable:!0}),t.prototype.done=function(){this.Vt=!0},t.prototype.Ct=function(t){this.St=t},t.prototype.delete=function(){return fr(this.Pt.delete())},t}(),ur=function(t){function e(e,n){var r=this;return(r=t.call(this,c.UNAVAILABLE,"IndexedDB transaction '"+e+"' failed: "+n)||this).name="IndexedDbTransactionError",r}return(0,s.__extends)(e,t),e}(h);function cr(t){return"IndexedDbTransactionError"===t.name}var hr=function(){function t(t){this.store=t}return t.prototype.put=function(t,e){var n;return void 0!==e?(d("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(d("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),fr(n)},t.prototype.add=function(t){return d("SimpleDb","ADD",this.store.name,t,t),fr(this.store.add(t))},t.prototype.get=function(t){var e=this;return fr(this.store.get(t)).next((function(n){return void 0===n&&(n=null),d("SimpleDb","GET",e.store.name,t,n),n}))},t.prototype.delete=function(t){return d("SimpleDb","DELETE",this.store.name,t),fr(this.store.delete(t))},t.prototype.count=function(){return d("SimpleDb","COUNT",this.store.name),fr(this.store.count())},t.prototype.Nt=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.xt(n,(function(t,e){r.push(e)})).next((function(){return r}))},t.prototype.Ft=function(t,e){d("SimpleDb","DELETE ALL",this.store.name);var n=this.options(t,e);n.kt=!1;var r=this.cursor(n);return this.xt(r,(function(t,e,n){return n.delete()}))},t.prototype.$t=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.xt(r,e)},t.prototype.Ot=function(t){var e=this.cursor({});return new ir((function(n,r){e.onerror=function(t){var e=dr(t.target.error);r(e)},e.onsuccess=function(e){var r=e.target.result;r?t(r.primaryKey,r.value).next((function(t){t?r.continue():n()})):n()}}))},t.prototype.xt=function(t,e){var n=[];return new ir((function(r,i){t.onerror=function(t){i(t.target.error)},t.onsuccess=function(t){var i=t.target.result;if(i){var o=new ar(i),s=e(i.primaryKey,i.value,o);if(s instanceof ir){var a=s.catch((function(t){return o.done(),ir.reject(t)}));n.push(a)}o.isDone?r():null===o.Dt?i.continue():i.continue(o.Dt)}else r()}})).next((function(){return ir.waitFor(n)}))},t.prototype.options=function(t,e){var n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}},t.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.kt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},t}();function fr(t){return new ir((function(e,n){t.onsuccess=function(t){var n=t.target.result;e(n)},t.onerror=function(t){var e=dr(t.target.error);n(e)}}))}var lr=!1;function dr(t){var e=sr._t((0,r.getUA)());if(e>=12.2&&e<13){var n="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(n)>=0){var i=new h("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+n+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return lr||(lr=!0,setTimeout((function(){throw i}),0)),i}}return t}var pr=function(t){function e(e,n){var r=this;return(r=t.call(this)||this).Mt=e,r.currentSequenceNumber=n,r}return(0,s.__extends)(e,t),e}(nr);function yr(t,e){var n=_(t);return sr.It(n.Mt,e)}var vr=function(){function t(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}return t.prototype.applyToRemoteDocument=function(t,e){for(var n=e.mutationResults,r=0;r<this.mutations.length;r++){var i=this.mutations[r];i.key.isEqual(t.key)&&de(i,t,n[r])}},t.prototype.applyToLocalView=function(t){for(var e=0,n=this.baseMutations;e<n.length;e++)(o=n[e]).key.isEqual(t.key)&&pe(o,t,this.localWriteTime);for(var r=0,i=this.mutations;r<i.length;r++){var o;(o=i[r]).key.isEqual(t.key)&&pe(o,t,this.localWriteTime)}},t.prototype.applyToLocalDocumentSet=function(t){var e=this;this.mutations.forEach((function(n){var r=t.get(n.key),i=r;e.applyToLocalView(i),r.isValidDocument()||i.convertToNoDocument(N.min())}))},t.prototype.keys=function(){return this.mutations.reduce((function(t,e){return t.add(e.key)}),je())},t.prototype.isEqual=function(t){return this.batchId===t.batchId&&E(this.mutations,t.mutations,(function(t,e){return ve(t,e)}))&&E(this.baseMutations,t.baseMutations,(function(t,e){return ve(t,e)}))},t}(),mr=function(){function t(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}return t.from=function(e,n,r){g(e.mutations.length===r.length);for(var i=Ue(),o=e.mutations,s=0;s<o.length;s++)i=i.insert(o[s].key,r[s].version);return new t(e,n,r,i)},t}(),gr=function(){function t(t,e,n,r,i,o,s){void 0===i&&(i=N.min()),void 0===o&&(o=N.min()),void 0===s&&(s=P.EMPTY_BYTE_STRING),this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=s}return t.prototype.withSequenceNumber=function(e){return new t(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)},t.prototype.withResumeToken=function(e,n){return new t(this.target,this.targetId,this.purpose,this.sequenceNumber,n,this.lastLimboFreeSnapshotVersion,e)},t.prototype.withLastLimboFreeSnapshotVersion=function(e){return new t(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)},t}(),_r=function(t){this.Lt=t};function wr(t,e){if(e.document)return mn(t.Lt,e.document,!!e.hasCommittedMutations);if(e.noDocument){var n=z.fromSegments(e.noDocument.path),r=Sr(e.noDocument.readTime),i=ct.newNoDocument(n,r);return e.hasCommittedMutations?i.setHasCommittedMutations():i}if(e.unknownDocument){var o=z.fromSegments(e.unknownDocument.path);return r=Sr(e.unknownDocument.version),ct.newUnknownDocument(o,r)}return m()}function br(t,e,n){var r=Ir(n),i=e.key.path.popLast().toArray();if(e.isFoundDocument()){var o=function(t,e){return{name:hn(t,e.key),fields:e.data.value.mapValue.fields,updateTime:rn(t,e.version.toTimestamp())}}(t.Lt,e),s=e.hasCommittedMutations;return new Qn(null,null,o,s,r,i)}if(e.isNoDocument()){var a=e.key.path.toArray(),u=Tr(e.version);return s=e.hasCommittedMutations,new Qn(null,new Kn(a,u),null,s,r,i)}if(e.isUnknownDocument()){var c=e.key.path.toArray(),h=Tr(e.version);return new Qn(new Gn(c,h),null,null,!0,r,i)}return m()}function Ir(t){var e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Er(t){var e=new S(t[0],t[1]);return N.fromTimestamp(e)}function Tr(t){var e=t.toTimestamp();return new Vn(e.seconds,e.nanoseconds)}function Sr(t){var e=new S(t.seconds,t.nanoseconds);return N.fromTimestamp(e)}function Nr(t,e){for(var n=(e.baseMutations||[]).map((function(e){return _n(t.Lt,e)})),r=0;r<e.mutations.length-1;++r){var i=e.mutations[r];if(r+1<e.mutations.length&&void 0!==e.mutations[r+1].transform){var o=e.mutations[r+1];i.updateTransforms=o.transform.fieldTransforms,e.mutations.splice(r+1,1),++r}}var s=e.mutations.map((function(e){return _n(t.Lt,e)})),a=S.fromMillis(e.localWriteTimeMs);return new vr(e.batchId,a,n,s)}function Dr(t){var e,n,r=Sr(t.readTime),i=void 0!==t.lastLimboFreeSnapshotVersion?Sr(t.lastLimboFreeSnapshotVersion):N.min();return void 0!==t.query.documents?(g(1===(n=t.query).documents.length),e=qt(Rt(dn(n.documents[0])))):e=function(t){return qt(In(t))}(t.query),new gr(e,t.targetId,0,t.lastListenSequenceNumber,r,i,P.fromBase64String(t.resumeToken))}function Ar(t,e){var n,r=Tr(e.snapshotVersion),i=Tr(e.lastLimboFreeSnapshotVersion);n=pt(e.target)?wn(t.Lt,e.target):bn(t.Lt,e.target);var o=e.resumeToken.toBase64();return new Wn(e.targetId,lt(e.target),r,o,e.sequenceNumber,i,n)}function kr(t){var e=In({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Ut(e,e.limit,"L"):e}var xr=function(){function t(){}return t.prototype.getBundleMetadata=function(t,e){return Cr(t).get(e).next((function(t){if(t)return{id:(e=t).bundleId,createTime:Sr(e.createTime),version:e.version};var e}))},t.prototype.saveBundleMetadata=function(t,e){return Cr(t).put({bundleId:(n=e).id,createTime:Tr(an(n.createTime)),version:n.version});var n},t.prototype.getNamedQuery=function(t,e){return Rr(t).get(e).next((function(t){if(t)return{name:(e=t).name,query:kr(e.bundledQuery),readTime:Sr(e.readTime)};var e}))},t.prototype.saveNamedQuery=function(t,e){return Rr(t).put(function(t){return{name:t.name,readTime:Tr(an(t.readTime)),bundledQuery:t.bundledQuery}}(e))},t}();function Cr(t){return yr(t,Jn.store)}function Rr(t){return yr(t,Zn.store)}var Lr=function(){function t(){this.Bt=new Or}return t.prototype.addToCollectionParentIndex=function(t,e){return this.Bt.add(e),ir.resolve()},t.prototype.getCollectionParents=function(t,e){return ir.resolve(this.Bt.getEntries(e))},t}(),Or=function(){function t(){this.index={}}return t.prototype.add=function(t){var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Le(C.comparator),i=!r.has(n);return this.index[e]=r.add(n),i},t.prototype.has=function(t){var e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)},t.prototype.getEntries=function(t){return(this.index[t]||new Le(C.comparator)).toArray()},t}(),Pr=function(){function t(){this.qt=new Or}return t.prototype.addToCollectionParentIndex=function(t,e){var n=this;if(!this.qt.has(e)){var r=e.lastSegment(),i=e.popLast();t.addOnCommittedListener((function(){n.qt.add(e)}));var o={collectionId:r,parent:On(i)};return Mr(t).put(o)}return ir.resolve()},t.prototype.getCollectionParents=function(t,e){var n=[],r=IDBKeyRange.bound([e,""],[T(e),""],!1,!0);return Mr(t).Nt(r).next((function(t){for(var r=0,i=t;r<i.length;r++){var o=i[r];if(o.collectionId!==e)break;n.push(Fn(o.parent))}return n}))},t}();function Mr(t){return yr(t,$n.store)}var Fr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Vr=function(){function t(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}return t.withCacheSize=function(e){return new t(e,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},t}();function qr(t,e,n){var r=t.store(Bn.store),i=t.store(jn.store),o=[],s=IDBKeyRange.only(n.batchId),a=0,u=r.$t({range:s},(function(t,e,n){return a++,n.delete()}));o.push(u.next((function(){g(1===a)})));for(var c=[],h=0,f=n.mutations;h<f.length;h++){var l=f[h],d=jn.key(e,l.key.path,n.batchId);o.push(i.delete(d)),c.push(l.key)}return ir.waitFor(o).next((function(){return c}))}function Ur(t){if(!t)return 0;var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw m();e=t.noDocument}return JSON.stringify(e).length}Vr.DEFAULT_COLLECTION_PERCENTILE=10,Vr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Vr.DEFAULT=new Vr(41943040,Vr.DEFAULT_COLLECTION_PERCENTILE,Vr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Vr.DISABLED=new Vr(-1,0,0);var Br=function(){function t(t,e,n,r){this.userId=t,this.R=e,this.Ut=n,this.referenceDelegate=r,this.Qt={}}return t.Kt=function(e,n,r,i){return g(""!==e.uid),new t(e.isAuthenticated()?e.uid:"",n,r,i)},t.prototype.checkEmpty=function(t){var e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Kr(t).$t({index:Bn.userMutationsIndex,range:n},(function(t,n,r){e=!1,r.done()})).next((function(){return e}))},t.prototype.addMutationBatch=function(t,e,n,r){var i=this,o=Gr(t),s=Kr(t);return s.add({}).next((function(a){g("number"==typeof a);for(var u=new vr(a,e,n,r),c=function(t,e,n){var r=n.baseMutations.map((function(e){return gn(t.Lt,e)})),i=n.mutations.map((function(e){return gn(t.Lt,e)}));return new Bn(e,n.batchId,n.localWriteTime.toMillis(),r,i)}(i.R,i.userId,u),h=[],f=new Le((function(t,e){return I(t.canonicalString(),e.canonicalString())})),l=0,d=r;l<d.length;l++){var p=d[l],y=jn.key(i.userId,p.key.path,a);f=f.add(p.key.path.popLast()),h.push(s.put(c)),h.push(o.put(y,jn.PLACEHOLDER))}return f.forEach((function(e){h.push(i.Ut.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((function(){i.Qt[a]=u.keys()})),ir.waitFor(h).next((function(){return u}))}))},t.prototype.lookupMutationBatch=function(t,e){var n=this;return Kr(t).get(e).next((function(t){return t?(g(t.userId===n.userId),Nr(n.R,t)):null}))},t.prototype.jt=function(t,e){var n=this;return this.Qt[e]?ir.resolve(this.Qt[e]):this.lookupMutationBatch(t,e).next((function(t){if(t){var r=t.keys();return n.Qt[e]=r,r}return null}))},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=this,r=e+1,i=IDBKeyRange.lowerBound([this.userId,r]),o=null;return Kr(t).$t({index:Bn.userMutationsIndex,range:i},(function(t,e,i){e.userId===n.userId&&(g(e.batchId>=r),o=Nr(n.R,e)),i.done()})).next((function(){return o}))},t.prototype.getHighestUnacknowledgedBatchId=function(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return Kr(t).$t({index:Bn.userMutationsIndex,range:e,reverse:!0},(function(t,e,r){n=e.batchId,r.done()})).next((function(){return n}))},t.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Kr(t).Nt(Bn.userMutationsIndex,n).next((function(t){return t.map((function(t){return Nr(e.R,t)}))}))},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=jn.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=[];return Gr(t).$t({range:i},(function(r,i,s){var a=r[0],u=r[1],c=r[2],h=Fn(u);if(a===n.userId&&e.path.isEqual(h))return Kr(t).get(c).next((function(t){if(!t)throw m();g(t.userId===n.userId),o.push(Nr(n.R,t))}));s.done()})).next((function(){return o}))},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new Le(I),i=[];return e.forEach((function(e){var o=jn.prefixForPath(n.userId,e.path),s=IDBKeyRange.lowerBound(o),a=Gr(t).$t({range:s},(function(t,i,o){var s=t[0],a=t[1],u=t[2],c=Fn(a);s===n.userId&&e.path.isEqual(c)?r=r.add(u):o.done()}));i.push(a)})),ir.waitFor(i).next((function(){return n.Wt(t,r)}))},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var n=this,r=e.path,i=r.length+1,o=jn.prefixForPath(this.userId,r),s=IDBKeyRange.lowerBound(o),a=new Le(I);return Gr(t).$t({range:s},(function(t,e,o){var s=t[0],u=t[1],c=t[2],h=Fn(u);s===n.userId&&r.isPrefixOf(h)?h.length===i&&(a=a.add(c)):o.done()})).next((function(){return n.Wt(t,a)}))},t.prototype.Wt=function(t,e){var n=this,r=[],i=[];return e.forEach((function(e){i.push(Kr(t).get(e).next((function(t){if(null===t)throw m();g(t.userId===n.userId),r.push(Nr(n.R,t))})))})),ir.waitFor(i).next((function(){return r}))},t.prototype.removeMutationBatch=function(t,e){var n=this;return qr(t.Mt,this.userId,e).next((function(r){return t.addOnCommittedListener((function(){n.Gt(e.batchId)})),ir.forEach(r,(function(e){return n.referenceDelegate.markPotentiallyOrphaned(t,e)}))}))},t.prototype.Gt=function(t){delete this.Qt[t]},t.prototype.performConsistencyCheck=function(t){var e=this;return this.checkEmpty(t).next((function(n){if(!n)return ir.resolve();var r=IDBKeyRange.lowerBound(jn.prefixForUser(e.userId)),i=[];return Gr(t).$t({range:r},(function(t,n,r){if(t[0]===e.userId){var o=Fn(t[1]);i.push(o)}else r.done()})).next((function(){g(0===i.length)}))}))},t.prototype.containsKey=function(t,e){return jr(t,this.userId,e)},t.prototype.zt=function(t){var e=this;return Qr(t).get(this.userId).next((function(t){return t||new Un(e.userId,-1,"")}))},t}();function jr(t,e,n){var r=jn.prefixForPath(e,n.path),i=r[1],o=IDBKeyRange.lowerBound(r),s=!1;return Gr(t).$t({range:o,kt:!0},(function(t,n,r){var o=t[0],a=t[1];t[2],o===e&&a===i&&(s=!0),r.done()})).next((function(){return s}))}function Kr(t){return yr(t,Bn.store)}function Gr(t){return yr(t,jn.store)}function Qr(t){return yr(t,Un.store)}var zr=function(){function t(t){this.Ht=t}return t.prototype.next=function(){return this.Ht+=2,this.Ht},t.Jt=function(){return new t(0)},t.Yt=function(){return new t(-1)},t}(),Wr=function(){function t(t,e){this.referenceDelegate=t,this.R=e}return t.prototype.allocateTargetId=function(t){var e=this;return this.Xt(t).next((function(n){var r=new zr(n.highestTargetId);return n.highestTargetId=r.next(),e.Zt(t,n).next((function(){return n.highestTargetId}))}))},t.prototype.getLastRemoteSnapshotVersion=function(t){return this.Xt(t).next((function(t){return N.fromTimestamp(new S(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))}))},t.prototype.getHighestSequenceNumber=function(t){return this.Xt(t).next((function(t){return t.highestListenSequenceNumber}))},t.prototype.setTargetsMetadata=function(t,e,n){var r=this;return this.Xt(t).next((function(i){return i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),r.Zt(t,i)}))},t.prototype.addTargetData=function(t,e){var n=this;return this.te(t,e).next((function(){return n.Xt(t).next((function(r){return r.targetCount+=1,n.ee(e,r),n.Zt(t,r)}))}))},t.prototype.updateTargetData=function(t,e){return this.te(t,e)},t.prototype.removeTargetData=function(t,e){var n=this;return this.removeMatchingKeysForTargetId(t,e.targetId).next((function(){return Hr(t).delete(e.targetId)})).next((function(){return n.Xt(t)})).next((function(e){return g(e.targetCount>0),e.targetCount-=1,n.Zt(t,e)}))},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return Hr(t).$t((function(s,a){var u=Dr(a);u.sequenceNumber<=e&&null===n.get(u.targetId)&&(i++,o.push(r.removeTargetData(t,u)))})).next((function(){return ir.waitFor(o)})).next((function(){return i}))},t.prototype.forEachTarget=function(t,e){return Hr(t).$t((function(t,n){var r=Dr(n);e(r)}))},t.prototype.Xt=function(t){return Yr(t).get(Yn.key).next((function(t){return g(null!==t),t}))},t.prototype.Zt=function(t,e){return Yr(t).put(Yn.key,e)},t.prototype.te=function(t,e){return Hr(t).put(Ar(this.R,e))},t.prototype.ee=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},t.prototype.getTargetCount=function(t){return this.Xt(t).next((function(t){return t.targetCount}))},t.prototype.getTargetData=function(t,e){var n=lt(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return Hr(t).$t({range:r,index:Wn.queryTargetsIndexName},(function(t,n,r){var o=Dr(n);dt(e,o.target)&&(i=o,r.done())})).next((function(){return i}))},t.prototype.addMatchingKeys=function(t,e,n){var r=this,i=[],o=$r(t);return e.forEach((function(e){var s=On(e.path);i.push(o.put(new Hn(n,s))),i.push(r.referenceDelegate.addReference(t,n,e))})),ir.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){var r=this,i=$r(t);return ir.forEach(e,(function(e){var o=On(e.path);return ir.waitFor([i.delete([n,o]),r.referenceDelegate.removeReference(t,n,e)])}))},t.prototype.removeMatchingKeysForTargetId=function(t,e){var n=$r(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=$r(t),i=je();return r.$t({range:n,kt:!0},(function(t,e,n){var r=Fn(t[1]),o=new z(r);i=i.add(o)})).next((function(){return i}))},t.prototype.containsKey=function(t,e){var n=On(e.path),r=IDBKeyRange.bound([n],[T(n)],!1,!0),i=0;return $r(t).$t({index:Hn.documentTargetsIndex,kt:!0,range:r},(function(t,e,n){var r=t[0];t[1],0!==r&&(i++,n.done())})).next((function(){return i>0}))},t.prototype.lt=function(t,e){return Hr(t).get(e).next((function(t){return t?Dr(t):null}))},t}();function Hr(t){return yr(t,Wn.store)}function Yr(t){return yr(t,Yn.store)}function $r(t){return yr(t,Hn.store)}function Xr(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){if(t.code!==c.FAILED_PRECONDITION||t.message!==er)throw t;return d("LocalStore","Unexpectedly lost primary lease"),[2]}))}))}function Jr(t,e){var n=t[0],r=t[1],i=e[0],o=e[1],s=I(n,i);return 0===s?I(r,o):s}var Zr=function(){function t(t){this.ne=t,this.buffer=new Le(Jr),this.se=0}return t.prototype.ie=function(){return++this.se},t.prototype.re=function(t){var e=[t,this.ie()];if(this.buffer.size<this.ne)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();Jr(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(t.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!1,configurable:!0}),t}(),ti=function(){function t(t,e){this.garbageCollector=t,this.asyncQueue=e,this.oe=!1,this.ce=null}return t.prototype.start=function(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.ue(t)},t.prototype.stop=function(){this.ce&&(this.ce.cancel(),this.ce=null)},Object.defineProperty(t.prototype,"started",{get:function(){return null!==this.ce},enumerable:!1,configurable:!0}),t.prototype.ue=function(t){var e=this,n=this.oe?3e5:6e4;d("LruGarbageCollector","Garbage collection scheduled in "+n+"ms"),this.ce=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",n,(function(){return(0,s.__awaiter)(e,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:this.ce=null,this.oe=!0,n.label=1;case 1:return n.trys.push([1,3,,7]),[4,t.collectGarbage(this.garbageCollector)];case 2:return n.sent(),[3,7];case 3:return cr(e=n.sent())?(d("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e),[3,6]):[3,4];case 4:return[4,Xr(e)];case 5:n.sent(),n.label=6;case 6:return[3,7];case 7:return[4,this.ue(t)];case 8:return n.sent(),[2]}}))}))}))},t}(),ei=function(){function t(t,e){this.ae=t,this.params=e}return t.prototype.calculateTargetCount=function(t,e){return this.ae.he(t).next((function(t){return Math.floor(e/100*t)}))},t.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return ir.resolve(u.o);var r=new Zr(e);return this.ae.forEachTarget(t,(function(t){return r.re(t.sequenceNumber)})).next((function(){return n.ae.le(t,(function(t){return r.re(t)}))})).next((function(){return r.maxValue}))},t.prototype.removeTargets=function(t,e,n){return this.ae.removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){return this.ae.removeOrphanedDocuments(t,e)},t.prototype.collect=function(t,e){var n=this;return-1===this.params.cacheSizeCollectionThreshold?(d("LruGarbageCollector","Garbage collection skipped; disabled"),ir.resolve(Fr)):this.getCacheSize(t).next((function(r){return r<n.params.cacheSizeCollectionThreshold?(d("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+n.params.cacheSizeCollectionThreshold),Fr):n.fe(t,e)}))},t.prototype.getCacheSize=function(t){return this.ae.getCacheSize(t)},t.prototype.fe=function(t,e){var n,r,o,s,a,u,c,h=this,f=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((function(e){return e>h.params.maximumSequenceNumbersToCollect?(d("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+h.params.maximumSequenceNumbersToCollect+" from "+e),r=h.params.maximumSequenceNumbersToCollect):r=e,s=Date.now(),h.nthSequenceNumber(t,r)})).next((function(r){return n=r,a=Date.now(),h.removeTargets(t,n,e)})).next((function(e){return o=e,u=Date.now(),h.removeOrphanedDocuments(t,n)})).next((function(t){return c=Date.now(),l()<=i.LogLevel.DEBUG&&d("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(s-f)+"ms\n\tDetermined least recently used "+r+" in "+(a-s)+"ms\n\tRemoved "+o+" targets in "+(u-a)+"ms\n\tRemoved "+t+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-f)+"ms"),ir.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:o,documentsRemoved:t})}))},t}(),ni=function(){function t(t,e){this.db=t,this.garbageCollector=function(t,e){return new ei(t,e)}(this,e)}return t.prototype.he=function(t){var e=this.de(t);return this.db.getTargetCache().getTargetCount(t).next((function(t){return e.next((function(e){return t+e}))}))},t.prototype.de=function(t){var e=0;return this.le(t,(function(t){e++})).next((function(){return e}))},t.prototype.forEachTarget=function(t,e){return this.db.getTargetCache().forEachTarget(t,e)},t.prototype.le=function(t,e){return this.we(t,(function(t,n){return e(n)}))},t.prototype.addReference=function(t,e,n){return ri(t,n)},t.prototype.removeReference=function(t,e,n){return ri(t,n)},t.prototype.removeTargets=function(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)},t.prototype.markPotentiallyOrphaned=function(t,e){return ri(t,e)},t.prototype._e=function(t,e){return function(t,e){var n=!1;return Qr(t).Ot((function(r){return jr(t,r,e).next((function(t){return t&&(n=!0),ir.resolve(!t)}))})).next((function(){return n}))}(t,e)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],o=0;return this.we(t,(function(s,a){if(a<=e){var u=n._e(t,s).next((function(e){if(!e)return o++,r.getEntry(t,s).next((function(){return r.removeEntry(s),$r(t).delete([0,On(s.path)])}))}));i.push(u)}})).next((function(){return ir.waitFor(i)})).next((function(){return r.apply(t)})).next((function(){return o}))},t.prototype.removeTarget=function(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)},t.prototype.updateLimboDocument=function(t,e){return ri(t,e)},t.prototype.we=function(t,e){var n,r=$r(t),i=u.o;return r.$t({index:Hn.documentTargetsIndex},(function(t,r){var o=t[0],s=(t[1],r.path),a=r.sequenceNumber;0===o?(i!==u.o&&e(new z(Fn(n)),i),i=a,n=s):i=u.o})).next((function(){i!==u.o&&e(new z(Fn(n)),i)}))},t.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},t}();function ri(t,e){return $r(t).put(function(t,e){return new Hn(0,On(t.path),e)}(e,t.currentSequenceNumber))}var ii=function(){function t(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}return t.prototype.get=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],s=o[0],a=o[1];if(this.equalsFn(s,t))return a}},t.prototype.has=function(t){return void 0!==this.get(t)},t.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(this.equalsFn(r[i][0],t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},t.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},t.prototype.forEach=function(t){A(this.inner,(function(e,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],s=o[0],a=o[1];t(s,a)}}))},t.prototype.isEmpty=function(){return k(this.inner)},t}(),oi=function(){function t(){this.changes=new ii((function(t){return t.toString()}),(function(t,e){return t.isEqual(e)})),this.changesApplied=!1}return t.prototype.getReadTime=function(t){var e=this.changes.get(t);return e?e.readTime:N.min()},t.prototype.addEntry=function(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})},t.prototype.removeEntry=function(t,e){void 0===e&&(e=null),this.assertNotApplied(),this.changes.set(t,{document:ct.newInvalidDocument(t),readTime:e})},t.prototype.getEntry=function(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?ir.resolve(n.document):this.getFromCache(t,e)},t.prototype.getEntries=function(t,e){return this.getAllFromCache(t,e)},t.prototype.apply=function(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)},t.prototype.assertNotApplied=function(){},t}(),si=function(){function t(t,e){this.R=t,this.Ut=e}return t.prototype.addEntry=function(t,e,n){return ci(t).put(hi(e),n)},t.prototype.removeEntry=function(t,e){var n=ci(t),r=hi(e);return n.delete(r)},t.prototype.updateMetadata=function(t,e){var n=this;return this.getMetadata(t).next((function(r){return r.byteSize+=e,n.me(t,r)}))},t.prototype.getEntry=function(t,e){var n=this;return ci(t).get(hi(e)).next((function(t){return n.ye(e,t)}))},t.prototype.ge=function(t,e){var n=this;return ci(t).get(hi(e)).next((function(t){return{document:n.ye(e,t),size:Ur(t)}}))},t.prototype.getEntries=function(t,e){var n=this,r=Me();return this.pe(t,e,(function(t,e){var i=n.ye(t,e);r=r.insert(t,i)})).next((function(){return r}))},t.prototype.Ee=function(t,e){var n=this,r=Me(),i=new xe(z.comparator);return this.pe(t,e,(function(t,e){var o=n.ye(t,e);r=r.insert(t,o),i=i.insert(t,Ur(e))})).next((function(){return{documents:r,Te:i}}))},t.prototype.pe=function(t,e,n){if(e.isEmpty())return ir.resolve();var r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator(),o=i.getNext();return ci(t).$t({range:r},(function(t,e,r){for(var s=z.fromSegments(t);o&&z.comparator(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.Ct(o.path.toArray()):r.done()})).next((function(){for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))},t.prototype.getDocumentsMatchingQuery=function(t,e,n){var r=this,i=Me(),o=e.path.length+1,s={};if(n.isEqual(N.min())){var a=e.path.toArray();s.range=IDBKeyRange.lowerBound(a)}else{var u=e.path.toArray(),c=Ir(n);s.range=IDBKeyRange.lowerBound([u,c],!0),s.index=Qn.collectionReadTimeIndex}return ci(t).$t(s,(function(t,n,s){if(t.length===o){var a=wr(r.R,n);e.path.isPrefixOf(a.key.path)?Gt(e,a)&&(i=i.insert(a.key,a)):s.done()}})).next((function(){return i}))},t.prototype.newChangeBuffer=function(t){return new ai(this,!!t&&t.trackRemovals)},t.prototype.getSize=function(t){return this.getMetadata(t).next((function(t){return t.byteSize}))},t.prototype.getMetadata=function(t){return ui(t).get(zn.key).next((function(t){return g(!!t),t}))},t.prototype.me=function(t,e){return ui(t).put(zn.key,e)},t.prototype.ye=function(t,e){if(e){var n=wr(this.R,e);if(!n.isNoDocument()||!n.version.isEqual(N.min()))return n}return ct.newInvalidDocument(t)},t}(),ai=function(t){function e(e,n){var r=this;return(r=t.call(this)||this).Ie=e,r.trackRemovals=n,r.Ae=new ii((function(t){return t.toString()}),(function(t,e){return t.isEqual(e)})),r}return(0,s.__extends)(e,t),e.prototype.applyChanges=function(t){var e=this,n=[],r=0,i=new Le((function(t,e){return I(t.canonicalString(),e.canonicalString())}));return this.changes.forEach((function(o,s){var a=e.Ae.get(o);if(s.document.isValidDocument()){var u=br(e.Ie.R,s.document,e.getReadTime(o));i=i.add(o.path.popLast());var c=Ur(u);r+=c-a,n.push(e.Ie.addEntry(t,o,u))}else if(r-=a,e.trackRemovals){var h=br(e.Ie.R,ct.newNoDocument(o,N.min()),e.getReadTime(o));n.push(e.Ie.addEntry(t,o,h))}else n.push(e.Ie.removeEntry(t,o))})),i.forEach((function(r){n.push(e.Ie.Ut.addToCollectionParentIndex(t,r))})),n.push(this.Ie.updateMetadata(t,r)),ir.waitFor(n)},e.prototype.getFromCache=function(t,e){var n=this;return this.Ie.ge(t,e).next((function(t){return n.Ae.set(e,t.size),t.document}))},e.prototype.getAllFromCache=function(t,e){var n=this;return this.Ie.Ee(t,e).next((function(t){var e=t.documents;return t.Te.forEach((function(t,e){n.Ae.set(t,e)})),e}))},e}(oi);function ui(t){return yr(t,zn.store)}function ci(t){return yr(t,Qn.store)}function hi(t){return t.path.toArray()}var fi=function(){function t(t){this.R=t}return t.prototype.Rt=function(t,e,n,r){var i=this;g(n<r&&n>=0&&r<=11);var o=new or("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore(qn.store)}(t),function(t){t.createObjectStore(Un.store,{keyPath:Un.keyPath}),t.createObjectStore(Bn.store,{keyPath:Bn.keyPath,autoIncrement:!0}).createIndex(Bn.userMutationsIndex,Bn.userMutationsKeyPath,{unique:!0}),t.createObjectStore(jn.store)}(t),li(t),function(t){t.createObjectStore(Qn.store)}(t));var s=ir.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore(Hn.store),t.deleteObjectStore(Wn.store),t.deleteObjectStore(Yn.store)}(t),li(t)),s=s.next((function(){return function(t){var e=t.store(Yn.store),n=new Yn(0,0,N.min().toTimestamp(),0);return e.put(Yn.key,n)}(o)}))),n<4&&r>=4&&(0!==n&&(s=s.next((function(){return function(t,e){return e.store(Bn.store).Nt().next((function(n){t.deleteObjectStore(Bn.store),t.createObjectStore(Bn.store,{keyPath:Bn.keyPath,autoIncrement:!0}).createIndex(Bn.userMutationsIndex,Bn.userMutationsKeyPath,{unique:!0});var r=e.store(Bn.store),i=n.map((function(t){return r.put(t)}));return ir.waitFor(i)}))}(t,o)}))),s=s.next((function(){!function(t){t.createObjectStore(Xn.store,{keyPath:Xn.keyPath})}(t)}))),n<5&&r>=5&&(s=s.next((function(){return i.Re(o)}))),n<6&&r>=6&&(s=s.next((function(){return function(t){t.createObjectStore(zn.store)}(t),i.be(o)}))),n<7&&r>=7&&(s=s.next((function(){return i.ve(o)}))),n<8&&r>=8&&(s=s.next((function(){return i.Pe(t,o)}))),n<9&&r>=9&&(s=s.next((function(){!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){var e=t.objectStore(Qn.store);e.createIndex(Qn.readTimeIndex,Qn.readTimeIndexPath,{unique:!1}),e.createIndex(Qn.collectionReadTimeIndex,Qn.collectionReadTimeIndexPath,{unique:!1})}(e)}))),n<10&&r>=10&&(s=s.next((function(){return i.Ve(o)}))),n<11&&r>=11&&(s=s.next((function(){!function(t){t.createObjectStore(Jn.store,{keyPath:Jn.keyPath})}(t),function(t){t.createObjectStore(Zn.store,{keyPath:Zn.keyPath})}(t)}))),s},t.prototype.be=function(t){var e=0;return t.store(Qn.store).$t((function(t,n){e+=Ur(n)})).next((function(){var n=new zn(e);return t.store(zn.store).put(zn.key,n)}))},t.prototype.Re=function(t){var e=this,n=t.store(Un.store),r=t.store(Bn.store);return n.Nt().next((function(n){return ir.forEach(n,(function(n){var i=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return r.Nt(Bn.userMutationsIndex,i).next((function(r){return ir.forEach(r,(function(r){g(r.userId===n.userId);var i=Nr(e.R,r);return qr(t,n.userId,i).next((function(){}))}))}))}))}))},t.prototype.ve=function(t){var e=t.store(Hn.store),n=t.store(Qn.store);return t.store(Yn.store).get(Yn.key).next((function(t){var r=[];return n.$t((function(n,i){var o=new C(n),s=function(t){return[0,On(t)]}(o);r.push(e.get(s).next((function(n){return n?ir.resolve():function(n){return e.put(new Hn(0,On(n),t.highestListenSequenceNumber))}(o)})))})).next((function(){return ir.waitFor(r)}))}))},t.prototype.Pe=function(t,e){t.createObjectStore($n.store,{keyPath:$n.keyPath});var n=e.store($n.store),r=new Or,i=function(t){if(r.add(t)){var e=t.lastSegment(),i=t.popLast();return n.put({collectionId:e,parent:On(i)})}};return e.store(Qn.store).$t({kt:!0},(function(t,e){var n=new C(t);return i(n.popLast())})).next((function(){return e.store(jn.store).$t({kt:!0},(function(t,e){t[0];var n=t[1],r=(t[2],Fn(n));return i(r.popLast())}))}))},t.prototype.Ve=function(t){var e=this,n=t.store(Wn.store);return n.$t((function(t,r){var i=Dr(r),o=Ar(e.R,i);return n.put(o)}))},t}();function li(t){t.createObjectStore(Hn.store,{keyPath:Hn.keyPath}).createIndex(Hn.documentTargetsIndex,Hn.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Wn.store,{keyPath:Wn.keyPath}).createIndex(Wn.queryTargetsIndexName,Wn.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Yn.store)}var di="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",pi=function(){function t(e,n,r,i,o,s,a,u,f,l){if(this.allowTabSynchronization=e,this.persistenceKey=n,this.clientId=r,this.Se=o,this.window=s,this.document=a,this.De=f,this.Ce=l,this.Ne=null,this.xe=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Fe=null,this.inForeground=!1,this.ke=null,this.$e=null,this.Oe=Number.NEGATIVE_INFINITY,this.Me=function(t){return Promise.resolve()},!t.yt())throw new h(c.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ni(this,i),this.Le=n+"main",this.R=new _r(u),this.Be=new sr(this.Le,11,new fi(this.R)),this.qe=new Wr(this.referenceDelegate,this.R),this.Ut=new Pr,this.Ue=function(t,e){return new si(t,e)}(this.R,this.Ut),this.Qe=new xr,this.window&&this.window.localStorage?this.Ke=this.window.localStorage:(this.Ke=null,!1===l&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}return t.prototype.start=function(){var t=this;return this.je().then((function(){if(!t.isPrimary&&!t.allowTabSynchronization)throw new h(c.FAILED_PRECONDITION,di);return t.We(),t.Ge(),t.ze(),t.runTransaction("getHighestListenSequenceNumber","readonly",(function(e){return t.qe.getHighestSequenceNumber(e)}))})).then((function(e){t.Ne=new u(e,t.De)})).then((function(){t.xe=!0})).catch((function(e){return t.Be&&t.Be.close(),Promise.reject(e)}))},t.prototype.He=function(t){var e=this;return this.Me=function(n){return(0,s.__awaiter)(e,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){return this.started?[2,t(n)]:[2]}))}))},t(this.isPrimary)},t.prototype.setDatabaseDeletedListener=function(t){var e=this;this.Be.vt((function(n){return(0,s.__awaiter)(e,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return null===n.newVersion?[4,t()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}))},t.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.Se.enqueueAndForget((function(){return(0,s.__awaiter)(e,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return this.started?[4,this.je()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))})))},t.prototype.je=function(){var t=this;return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(function(e){return vi(e).put(new Xn(t.clientId,Date.now(),t.networkEnabled,t.inForeground)).next((function(){if(t.isPrimary)return t.Je(e).next((function(e){e||(t.isPrimary=!1,t.Se.enqueueRetryable((function(){return t.Me(!1)})))}))})).next((function(){return t.Ye(e)})).next((function(n){return t.isPrimary&&!n?t.Xe(e).next((function(){return!1})):!!n&&t.Ze(e).next((function(){return!0}))}))})).catch((function(e){if(cr(e))return d("IndexedDbPersistence","Failed to extend owner lease: ",e),t.isPrimary;if(!t.allowTabSynchronization)throw e;return d("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((function(e){t.isPrimary!==e&&t.Se.enqueueRetryable((function(){return t.Me(e)})),t.isPrimary=e}))},t.prototype.Je=function(t){var e=this;return yi(t).get(qn.key).next((function(t){return ir.resolve(e.tn(t))}))},t.prototype.en=function(t){return vi(t).delete(this.clientId)},t.prototype.nn=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t,e,n,r,i=this;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return!this.isPrimary||this.sn(this.Oe,18e5)?[3,2]:(this.Oe=Date.now(),[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(function(t){var e=yr(t,Xn.store);return e.Nt().next((function(t){var n=i.rn(t,18e5),r=t.filter((function(t){return-1===n.indexOf(t)}));return ir.forEach(r,(function(t){return e.delete(t.clientId)})).next((function(){return r}))}))})).catch((function(){return[]}))]);case 1:if(t=o.sent(),this.Ke)for(e=0,n=t;e<n.length;e++)r=n[e],this.Ke.removeItem(this.on(r.clientId));o.label=2;case 2:return[2]}}))}))},t.prototype.ze=function(){var t=this;this.$e=this.Se.enqueueAfterDelay("client_metadata_refresh",4e3,(function(){return t.je().then((function(){return t.nn()})).then((function(){return t.ze()}))}))},t.prototype.tn=function(t){return!!t&&t.ownerId===this.clientId},t.prototype.Ye=function(t){var e=this;return this.Ce?ir.resolve(!0):yi(t).get(qn.key).next((function(n){if(null!==n&&e.sn(n.leaseTimestampMs,5e3)&&!e.cn(n.ownerId)){if(e.tn(n)&&e.networkEnabled)return!0;if(!e.tn(n)){if(!n.allowTabSynchronization)throw new h(c.FAILED_PRECONDITION,di);return!1}}return!(!e.networkEnabled||!e.inForeground)||vi(t).Nt().next((function(t){return void 0===e.rn(t,5e3).find((function(t){if(e.clientId!==t.clientId){var n=!e.networkEnabled&&t.networkEnabled,r=!e.inForeground&&t.inForeground,i=e.networkEnabled===t.networkEnabled;if(n||r&&i)return!0}return!1}))}))})).next((function(t){return e.isPrimary!==t&&d("IndexedDbPersistence","Client "+(t?"is":"is not")+" eligible for a primary lease."),t}))},t.prototype.shutdown=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t=this;return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return this.xe=!1,this.un(),this.$e&&(this.$e.cancel(),this.$e=null),this.an(),this.hn(),[4,this.Be.runTransaction("shutdown","readwrite",[qn.store,Xn.store],(function(e){var n=new pr(e,u.o);return t.Xe(n).next((function(){return t.en(n)}))}))];case 1:return e.sent(),this.Be.close(),this.ln(),[2]}}))}))},t.prototype.rn=function(t,e){var n=this;return t.filter((function(t){return n.sn(t.updateTimeMs,e)&&!n.cn(t.clientId)}))},t.prototype.fn=function(){var t=this;return this.runTransaction("getActiveClients","readonly",(function(e){return vi(e).Nt().next((function(e){return t.rn(e,18e5).map((function(t){return t.clientId}))}))}))},Object.defineProperty(t.prototype,"started",{get:function(){return this.xe},enumerable:!1,configurable:!0}),t.prototype.getMutationQueue=function(t){return Br.Kt(t,this.R,this.Ut,this.referenceDelegate)},t.prototype.getTargetCache=function(){return this.qe},t.prototype.getRemoteDocumentCache=function(){return this.Ue},t.prototype.getIndexManager=function(){return this.Ut},t.prototype.getBundleCache=function(){return this.Qe},t.prototype.runTransaction=function(t,e,n){var r=this;d("IndexedDbPersistence","Starting transaction:",t);var i,o="readonly"===e?"readonly":"readwrite";return this.Be.runTransaction(t,o,tr,(function(o){return i=new pr(o,r.Ne?r.Ne.next():u.o),"readwrite-primary"===e?r.Je(i).next((function(t){return!!t||r.Ye(i)})).next((function(e){if(!e)throw p("Failed to obtain primary lease for action '"+t+"'."),r.isPrimary=!1,r.Se.enqueueRetryable((function(){return r.Me(!1)})),new h(c.FAILED_PRECONDITION,er);return n(i)})).next((function(t){return r.Ze(i).next((function(){return t}))})):r.dn(i).next((function(){return n(i)}))})).then((function(t){return i.raiseOnCommittedEvent(),t}))},t.prototype.dn=function(t){var e=this;return yi(t).get(qn.key).next((function(t){if(null!==t&&e.sn(t.leaseTimestampMs,5e3)&&!e.cn(t.ownerId)&&!e.tn(t)&&!(e.Ce||e.allowTabSynchronization&&t.allowTabSynchronization))throw new h(c.FAILED_PRECONDITION,di)}))},t.prototype.Ze=function(t){var e=new qn(this.clientId,this.allowTabSynchronization,Date.now());return yi(t).put(qn.key,e)},t.yt=function(){return sr.yt()},t.prototype.Xe=function(t){var e=this,n=yi(t);return n.get(qn.key).next((function(t){return e.tn(t)?(d("IndexedDbPersistence","Releasing primary lease."),n.delete(qn.key)):ir.resolve()}))},t.prototype.sn=function(t,e){var n=Date.now();return!(t<n-e||t>n&&(p("Detected an update time that is in the future: "+t+" > "+n),1))},t.prototype.We=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ke=function(){t.Se.enqueueAndForget((function(){return t.inForeground="visible"===t.document.visibilityState,t.je()}))},this.document.addEventListener("visibilitychange",this.ke),this.inForeground="visible"===this.document.visibilityState)},t.prototype.an=function(){this.ke&&(this.document.removeEventListener("visibilitychange",this.ke),this.ke=null)},t.prototype.Ge=function(){var t,e=this;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Fe=function(){e.un(),e.Se.enqueueAndForget((function(){return e.shutdown()}))},this.window.addEventListener("pagehide",this.Fe))},t.prototype.hn=function(){this.Fe&&(this.window.removeEventListener("pagehide",this.Fe),this.Fe=null)},t.prototype.cn=function(t){var e;try{var n=null!==(null===(e=this.Ke)||void 0===e?void 0:e.getItem(this.on(t)));return d("IndexedDbPersistence","Client '"+t+"' "+(n?"is":"is not")+" zombied in LocalStorage"),n}catch(t){return p("IndexedDbPersistence","Failed to get zombied client id.",t),!1}},t.prototype.un=function(){if(this.Ke)try{this.Ke.setItem(this.on(this.clientId),String(Date.now()))}catch(t){p("Failed to set zombie client id.",t)}},t.prototype.ln=function(){if(this.Ke)try{this.Ke.removeItem(this.on(this.clientId))}catch(t){}},t.prototype.on=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},t}();function yi(t){return yr(t,qn.store)}function vi(t){return yr(t,Xn.store)}function mi(t,e){var n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}var gi=function(t,e){this.progress=t,this.wn=e},_i=function(){function t(t,e,n){this.Ue=t,this._n=e,this.Ut=n}return t.prototype.mn=function(t,e){var n=this;return this._n.getAllMutationBatchesAffectingDocumentKey(t,e).next((function(r){return n.yn(t,e,r)}))},t.prototype.yn=function(t,e,n){return this.Ue.getEntry(t,e).next((function(t){for(var e=0,r=n;e<r.length;e++)r[e].applyToLocalView(t);return t}))},t.prototype.gn=function(t,e){t.forEach((function(t,n){for(var r=0,i=e;r<i.length;r++)i[r].applyToLocalView(n)}))},t.prototype.pn=function(t,e){var n=this;return this.Ue.getEntries(t,e).next((function(e){return n.En(t,e).next((function(){return e}))}))},t.prototype.En=function(t,e){var n=this;return this._n.getAllMutationBatchesAffectingDocumentKeys(t,e).next((function(t){return n.gn(e,t)}))},t.prototype.getDocumentsMatchingQuery=function(t,e,n){return function(t){return z.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.Tn(t,e.path):Ft(e)?this.In(t,e,n):this.An(t,e,n)},t.prototype.Tn=function(t,e){return this.mn(t,new z(e)).next((function(t){var e=Ve();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))},t.prototype.In=function(t,e,n){var r=this,i=e.collectionGroup,o=Ve();return this.Ut.getCollectionParents(t,i).next((function(s){return ir.forEach(s,(function(s){var a=function(t,e){return new xt(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,s.child(i));return r.An(t,a,n).next((function(t){t.forEach((function(t,e){o=o.insert(t,e)}))}))})).next((function(){return o}))}))},t.prototype.An=function(t,e,n){var r,i,o=this;return this.Ue.getDocumentsMatchingQuery(t,e,n).next((function(n){return r=n,o._n.getAllMutationBatchesAffectingQuery(t,e)})).next((function(e){return i=e,o.Rn(t,i,r).next((function(t){r=t;for(var e=0,n=i;e<n.length;e++)for(var o=n[e],s=0,a=o.mutations;s<a.length;s++){var u=a[s],c=u.key,h=r.get(c);null==h&&(h=ct.newInvalidDocument(c),r=r.insert(c,h)),pe(u,h,o.localWriteTime),h.isFoundDocument()||(r=r.remove(c))}}))})).next((function(){return r.forEach((function(t,n){Gt(e,n)||(r=r.remove(t))})),r}))},t.prototype.Rn=function(t,e,n){for(var r=je(),i=0,o=e;i<o.length;i++)for(var s=0,a=o[i].mutations;s<a.length;s++){var u=a[s];u instanceof _e&&null===n.get(u.key)&&(r=r.add(u.key))}var c=n;return this.Ue.getEntries(t,r).next((function(t){return t.forEach((function(t,e){e.isFoundDocument()&&(c=c.insert(t,e))})),c}))},t}(),wi=function(){function t(t,e,n,r){this.targetId=t,this.fromCache=e,this.bn=n,this.vn=r}return t.Pn=function(e,n){for(var r=je(),i=je(),o=0,s=n.docChanges;o<s.length;o++){var a=s[o];switch(a.type){case 0:r=r.add(a.doc.key);break;case 1:i=i.add(a.doc.key)}}return new t(e,n.fromCache,r,i)},t}(),bi=function(){function t(){}return t.prototype.Vn=function(t){this.Sn=t},t.prototype.getDocumentsMatchingQuery=function(t,e,n,r){var o=this;return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||n.isEqual(N.min())?this.Dn(t,e):this.Sn.pn(t,r).next((function(s){var a=o.Cn(e,s);return(Lt(e)||Ot(e))&&o.Nn(e.limitType,a,r,n)?o.Dn(t,e):(l()<=i.LogLevel.DEBUG&&d("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),Kt(e)),o.Sn.getDocumentsMatchingQuery(t,e,n).next((function(t){return a.forEach((function(e){t=t.insert(e.key,e)})),t})))}))},t.prototype.Cn=function(t,e){var n=new Le(Qt(t));return e.forEach((function(e,r){Gt(t,r)&&(n=n.add(r))})),n},t.prototype.Nn=function(t,e,n,r){if(n.size!==e.size)return!0;var i="F"===t?e.last():e.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)},t.prototype.Dn=function(t,e){return l()<=i.LogLevel.DEBUG&&d("QueryEngine","Using full collection scan to execute query:",Kt(e)),this.Sn.getDocumentsMatchingQuery(t,e,N.min())},t}(),Ii=function(){function t(t,e,n,r){this.persistence=t,this.xn=e,this.R=r,this.Fn=new xe(I),this.kn=new ii((function(t){return lt(t)}),dt),this.$n=N.min(),this._n=t.getMutationQueue(n),this.On=t.getRemoteDocumentCache(),this.qe=t.getTargetCache(),this.Mn=new _i(this.On,this._n,this.persistence.getIndexManager()),this.Qe=t.getBundleCache(),this.xn.Vn(this.Mn)}return t.prototype.collectGarbage=function(t){var e=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",(function(n){return t.collect(n,e.Fn)}))},t}();function Ei(t,e,n,r){return new Ii(t,e,n,r)}function Ti(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return n=_(t),r=n._n,i=n.Mn,[4,n.persistence.runTransaction("Handle user change","readonly",(function(t){var o;return n._n.getAllMutationBatches(t).next((function(s){return o=s,r=n.persistence.getMutationQueue(e),i=new _i(n.On,r,n.persistence.getIndexManager()),r.getAllMutationBatches(t)})).next((function(e){for(var n=[],r=[],s=je(),a=0,u=o;a<u.length;a++){var c=u[a];n.push(c.batchId);for(var h=0,f=c.mutations;h<f.length;h++){var l=f[h];s=s.add(l.key)}}for(var d=0,p=e;d<p.length;d++){var y=p[d];r.push(y.batchId);for(var v=0,m=y.mutations;v<m.length;v++){var g=m[v];s=s.add(g.key)}}return i.pn(t,s).next((function(t){return{Ln:t,removedBatchIds:n,addedBatchIds:r}}))}))}))];case 1:return o=s.sent(),[2,(n._n=r,n.Mn=i,n.xn.Vn(n.Mn),o)]}}))}))}function Si(t,e){var n=_(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(function(t){var r=e.batch.keys(),i=n.On.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){var i=n.batch,o=i.keys(),s=ir.resolve();return o.forEach((function(t){s=s.next((function(){return r.getEntry(e,t)})).next((function(e){var o=n.docVersions.get(t);g(null!==o),e.version.compareTo(o)<0&&(i.applyToRemoteDocument(e,n),e.isValidDocument()&&r.addEntry(e,n.commitVersion))}))})),s.next((function(){return t._n.removeMutationBatch(e,i)}))}(n,t,e,i).next((function(){return i.apply(t)})).next((function(){return n._n.performConsistencyCheck(t)})).next((function(){return n.Mn.pn(t,r)}))}))}function Ni(t){var e=_(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(function(t){return e.qe.getLastRemoteSnapshotVersion(t)}))}function Di(t,e){var n=_(t),r=e.snapshotVersion,i=n.Fn;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(function(t){var o=n.On.newChangeBuffer({trackRemovals:!0});i=n.Fn;var s=[];e.targetChanges.forEach((function(e,o){var a=i.get(o);if(a){s.push(n.qe.removeMatchingKeys(t,e.removedDocuments,o).next((function(){return n.qe.addMatchingKeys(t,e.addedDocuments,o)})));var u=e.resumeToken;if(u.approximateByteSize()>0){var c=a.withResumeToken(u,r).withSequenceNumber(t.currentSequenceNumber);i=i.insert(o,c),function(t,e,n){return g(e.resumeToken.approximateByteSize()>0),0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(a,c,e)&&s.push(n.qe.updateTargetData(t,c))}}}));var a=Me();if(e.documentUpdates.forEach((function(r,i){e.resolvedLimboDocuments.has(r)&&s.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),s.push(Ai(t,o,e.documentUpdates,r,void 0).next((function(t){a=t}))),!r.isEqual(N.min())){var u=n.qe.getLastRemoteSnapshotVersion(t).next((function(e){return n.qe.setTargetsMetadata(t,t.currentSequenceNumber,r)}));s.push(u)}return ir.waitFor(s).next((function(){return o.apply(t)})).next((function(){return n.Mn.En(t,a)})).next((function(){return a}))})).then((function(t){return n.Fn=i,t}))}function Ai(t,e,n,r,i){var o=je();return n.forEach((function(t){return o=o.add(t)})),e.getEntries(t,o).next((function(t){var o=Me();return n.forEach((function(n,s){var a=t.get(n),u=(null==i?void 0:i.get(n))||r;s.isNoDocument()&&s.version.isEqual(N.min())?(e.removeEntry(n,u),o=o.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(e.addEntry(s,u),o=o.insert(n,s)):d("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)})),o}))}function ki(t,e){var n=_(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(function(t){return void 0===e&&(e=-1),n._n.getNextMutationBatchAfterBatchId(t,e)}))}function xi(t,e){var n=_(t);return n.persistence.runTransaction("Allocate target","readwrite",(function(t){var r;return n.qe.getTargetData(t,e).next((function(i){return i?(r=i,ir.resolve(r)):n.qe.allocateTargetId(t).next((function(i){return r=new gr(e,i,0,t.currentSequenceNumber),n.qe.addTargetData(t,r).next((function(){return r}))}))}))})).then((function(t){var r=n.Fn.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Fn=n.Fn.insert(t.targetId,t),n.kn.set(e,t.targetId)),t}))}function Ci(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,a;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:r=_(t),i=r.Fn.get(e),o=n?"readwrite":"readwrite-primary",s.label=1;case 1:return s.trys.push([1,4,,5]),n?[3,3]:[4,r.persistence.runTransaction("Release target",o,(function(t){return r.persistence.referenceDelegate.removeTarget(t,i)}))];case 2:s.sent(),s.label=3;case 3:return[3,5];case 4:if(!cr(a=s.sent()))throw a;return d("LocalStore","Failed to update sequence numbers for target "+e+": "+a),[3,5];case 5:return r.Fn=r.Fn.remove(e),r.kn.delete(i.target),[2]}}))}))}function Ri(t,e,n){var r=_(t),i=N.min(),o=je();return r.persistence.runTransaction("Execute query","readonly",(function(t){return function(t,e,n){var r=_(t),i=r.kn.get(n);return void 0!==i?ir.resolve(r.Fn.get(i)):r.qe.getTargetData(e,n)}(r,t,qt(e)).next((function(e){if(e)return i=e.lastLimboFreeSnapshotVersion,r.qe.getMatchingKeysForTargetId(t,e.targetId).next((function(t){o=t}))})).next((function(){return r.xn.getDocumentsMatchingQuery(t,e,n?i:N.min(),n?o:je())})).next((function(t){return{documents:t,Bn:o}}))}))}function Li(t,e){var n=_(t),r=_(n.qe),i=n.Fn.get(e);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",(function(t){return r.lt(t,e).next((function(t){return t?t.target:null}))}))}function Oi(t){var e=_(t);return e.persistence.runTransaction("Get new document changes","readonly",(function(t){return function(t,e,n){var r=_(t),i=Me(),o=Ir(n),s=ci(e),a=IDBKeyRange.lowerBound(o,!0);return s.$t({index:Qn.readTimeIndex,range:a},(function(t,e){var n=wr(r.R,e);i=i.insert(n.key,n),o=e.readTime})).next((function(){return{wn:i,readTime:Er(o)}}))}(e.On,t,e.$n)})).then((function(t){var n=t.wn,r=t.readTime;return e.$n=r,n}))}function Pi(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){return[2,(e=_(t)).persistence.runTransaction("Synchronize last document change read time","readonly",(function(t){return function(t){var e=ci(t),n=N.min();return e.$t({index:Qn.readTimeIndex,reverse:!0},(function(t,e,r){e.readTime&&(n=Er(e.readTime)),r.done()})).next((function(){return n}))}(t)})).then((function(t){e.$n=t}))]}))}))}function Mi(t,e,n,r){return(0,s.__awaiter)(this,void 0,void 0,(function(){var i,o,a,u,c,h,f,l,d,p;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:for(i=_(t),o=je(),a=Me(),u=Ue(),c=0,h=n;c<h.length;c++)f=h[c],l=e.qn(f.metadata.name),f.document&&(o=o.add(l)),a=a.insert(l,e.Un(f)),u=u.insert(l,e.Qn(f.metadata.readTime));return d=i.On.newChangeBuffer({trackRemovals:!0}),[4,xi(i,function(t){return qt(Rt(C.fromString("__bundle__/docs/"+t)))}(r))];case 1:return p=s.sent(),[2,i.persistence.runTransaction("Apply bundle documents","readwrite",(function(t){return Ai(t,d,a,N.min(),u).next((function(e){return d.apply(t),e})).next((function(e){return i.qe.removeMatchingKeysForTargetId(t,p.targetId).next((function(){return i.qe.addMatchingKeys(t,o,p.targetId)})).next((function(){return i.Mn.En(t,e)})).next((function(){return e}))}))}))]}}))}))}function Fi(t,e,n){return void 0===n&&(n=je()),(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return[4,xi(t,qt(kr(e.bundledQuery)))];case 1:return r=o.sent(),[2,(i=_(t)).persistence.runTransaction("Save named query","readwrite",(function(t){var o=an(e.readTime);if(r.snapshotVersion.compareTo(o)>=0)return i.Qe.saveNamedQuery(t,e);var s=r.withResumeToken(P.EMPTY_BYTE_STRING,o);return i.Fn=i.Fn.insert(s.targetId,s),i.qe.updateTargetData(t,s).next((function(){return i.qe.removeMatchingKeysForTargetId(t,r.targetId)})).next((function(){return i.qe.addMatchingKeys(t,n,r.targetId)})).next((function(){return i.Qe.saveNamedQuery(t,e)}))}))]}}))}))}var Vi=function(){function t(t){this.R=t,this.Kn=new Map,this.jn=new Map}return t.prototype.getBundleMetadata=function(t,e){return ir.resolve(this.Kn.get(e))},t.prototype.saveBundleMetadata=function(t,e){var n;return this.Kn.set(e.id,{id:(n=e).id,version:n.version,createTime:an(n.createTime)}),ir.resolve()},t.prototype.getNamedQuery=function(t,e){return ir.resolve(this.jn.get(e))},t.prototype.saveNamedQuery=function(t,e){return this.jn.set(e.name,function(t){return{name:t.name,query:kr(t.bundledQuery),readTime:an(t.readTime)}}(e)),ir.resolve()},t}(),qi=function(){function t(){this.Wn=new Le(Ui.Gn),this.zn=new Le(Ui.Hn)}return t.prototype.isEmpty=function(){return this.Wn.isEmpty()},t.prototype.addReference=function(t,e){var n=new Ui(t,e);this.Wn=this.Wn.add(n),this.zn=this.zn.add(n)},t.prototype.Jn=function(t,e){var n=this;t.forEach((function(t){return n.addReference(t,e)}))},t.prototype.removeReference=function(t,e){this.Yn(new Ui(t,e))},t.prototype.Xn=function(t,e){var n=this;t.forEach((function(t){return n.removeReference(t,e)}))},t.prototype.Zn=function(t){var e=this,n=new z(new C([])),r=new Ui(n,t),i=new Ui(n,t+1),o=[];return this.zn.forEachInRange([r,i],(function(t){e.Yn(t),o.push(t.key)})),o},t.prototype.ts=function(){var t=this;this.Wn.forEach((function(e){return t.Yn(e)}))},t.prototype.Yn=function(t){this.Wn=this.Wn.delete(t),this.zn=this.zn.delete(t)},t.prototype.es=function(t){var e=new z(new C([])),n=new Ui(e,t),r=new Ui(e,t+1),i=je();return this.zn.forEachInRange([n,r],(function(t){i=i.add(t.key)})),i},t.prototype.containsKey=function(t){var e=new Ui(t,0),n=this.Wn.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)},t}(),Ui=function(){function t(t,e){this.key=t,this.ns=e}return t.Gn=function(t,e){return z.comparator(t.key,e.key)||I(t.ns,e.ns)},t.Hn=function(t,e){return I(t.ns,e.ns)||z.comparator(t.key,e.key)},t}(),Bi=function(){function t(t,e){this.Ut=t,this.referenceDelegate=e,this._n=[],this.ss=1,this.rs=new Le(Ui.Gn)}return t.prototype.checkEmpty=function(t){return ir.resolve(0===this._n.length)},t.prototype.addMutationBatch=function(t,e,n,r){var i=this.ss;this.ss++,this._n.length>0&&this._n[this._n.length-1];var o=new vr(i,e,n,r);this._n.push(o);for(var s=0,a=r;s<a.length;s++){var u=a[s];this.rs=this.rs.add(new Ui(u.key,i)),this.Ut.addToCollectionParentIndex(t,u.key.path.popLast())}return ir.resolve(o)},t.prototype.lookupMutationBatch=function(t,e){return ir.resolve(this.os(e))},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=e+1,r=this.cs(n),i=r<0?0:r;return ir.resolve(this._n.length>i?this._n[i]:null)},t.prototype.getHighestUnacknowledgedBatchId=function(){return ir.resolve(0===this._n.length?-1:this.ss-1)},t.prototype.getAllMutationBatches=function(t){return ir.resolve(this._n.slice())},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=new Ui(e,0),i=new Ui(e,Number.POSITIVE_INFINITY),o=[];return this.rs.forEachInRange([r,i],(function(t){var e=n.os(t.ns);o.push(e)})),ir.resolve(o)},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new Le(I);return e.forEach((function(t){var e=new Ui(t,0),i=new Ui(t,Number.POSITIVE_INFINITY);n.rs.forEachInRange([e,i],(function(t){r=r.add(t.ns)}))})),ir.resolve(this.us(r))},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var n=e.path,r=n.length+1,i=n;z.isDocumentKey(i)||(i=i.child(""));var o=new Ui(new z(i),0),s=new Le(I);return this.rs.forEachWhile((function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(s=s.add(t.ns)),!0)}),o),ir.resolve(this.us(s))},t.prototype.us=function(t){var e=this,n=[];return t.forEach((function(t){var r=e.os(t);null!==r&&n.push(r)})),n},t.prototype.removeMutationBatch=function(t,e){var n=this;g(0===this.hs(e.batchId,"removed")),this._n.shift();var r=this.rs;return ir.forEach(e.mutations,(function(i){var o=new Ui(i.key,e.batchId);return r=r.delete(o),n.referenceDelegate.markPotentiallyOrphaned(t,i.key)})).next((function(){n.rs=r}))},t.prototype.Gt=function(t){},t.prototype.containsKey=function(t,e){var n=new Ui(e,0),r=this.rs.firstAfterOrEqual(n);return ir.resolve(e.isEqual(r&&r.key))},t.prototype.performConsistencyCheck=function(t){return this._n.length,ir.resolve()},t.prototype.hs=function(t,e){return this.cs(t)},t.prototype.cs=function(t){return 0===this._n.length?0:t-this._n[0].batchId},t.prototype.os=function(t){var e=this.cs(t);return e<0||e>=this._n.length?null:this._n[e]},t}(),ji=function(){function t(t,e){this.Ut=t,this.ls=e,this.docs=new xe(z.comparator),this.size=0}return t.prototype.addEntry=function(t,e,n){var r=e.key,i=this.docs.get(r),o=i?i.size:0,s=this.ls(e);return this.docs=this.docs.insert(r,{document:e.clone(),size:s,readTime:n}),this.size+=s-o,this.Ut.addToCollectionParentIndex(t,r.path.popLast())},t.prototype.removeEntry=function(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)},t.prototype.getEntry=function(t,e){var n=this.docs.get(e);return ir.resolve(n?n.document.clone():ct.newInvalidDocument(e))},t.prototype.getEntries=function(t,e){var n=this,r=Me();return e.forEach((function(t){var e=n.docs.get(t);r=r.insert(t,e?e.document.clone():ct.newInvalidDocument(t))})),ir.resolve(r)},t.prototype.getDocumentsMatchingQuery=function(t,e,n){for(var r=Me(),i=new z(e.path.child("")),o=this.docs.getIteratorFrom(i);o.hasNext();){var s=o.getNext(),a=s.key,u=s.value,c=u.document,h=u.readTime;if(!e.path.isPrefixOf(a.path))break;h.compareTo(n)<=0||Gt(e,c)&&(r=r.insert(c.key,c.clone()))}return ir.resolve(r)},t.prototype.fs=function(t,e){return ir.forEach(this.docs,(function(t){return e(t)}))},t.prototype.newChangeBuffer=function(t){return new Ki(this)},t.prototype.getSize=function(t){return ir.resolve(this.size)},t}(),Ki=function(t){function e(e){var n=this;return(n=t.call(this)||this).Ie=e,n}return(0,s.__extends)(e,t),e.prototype.applyChanges=function(t){var e=this,n=[];return this.changes.forEach((function(r,i){i.document.isValidDocument()?n.push(e.Ie.addEntry(t,i.document,e.getReadTime(r))):e.Ie.removeEntry(r)})),ir.waitFor(n)},e.prototype.getFromCache=function(t,e){return this.Ie.getEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.Ie.getEntries(t,e)},e}(oi),Gi=function(){function t(t){this.persistence=t,this.ds=new ii((function(t){return lt(t)}),dt),this.lastRemoteSnapshotVersion=N.min(),this.highestTargetId=0,this.ws=0,this._s=new qi,this.targetCount=0,this.ys=zr.Jt()}return t.prototype.forEachTarget=function(t,e){return this.ds.forEach((function(t,n){return e(n)})),ir.resolve()},t.prototype.getLastRemoteSnapshotVersion=function(t){return ir.resolve(this.lastRemoteSnapshotVersion)},t.prototype.getHighestSequenceNumber=function(t){return ir.resolve(this.ws)},t.prototype.allocateTargetId=function(t){return this.highestTargetId=this.ys.next(),ir.resolve(this.highestTargetId)},t.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.ws&&(this.ws=e),ir.resolve()},t.prototype.te=function(t){this.ds.set(t.target,t);var e=t.targetId;e>this.highestTargetId&&(this.ys=new zr(e),this.highestTargetId=e),t.sequenceNumber>this.ws&&(this.ws=t.sequenceNumber)},t.prototype.addTargetData=function(t,e){return this.te(e),this.targetCount+=1,ir.resolve()},t.prototype.updateTargetData=function(t,e){return this.te(e),ir.resolve()},t.prototype.removeTargetData=function(t,e){return this.ds.delete(e.target),this._s.Zn(e.targetId),this.targetCount-=1,ir.resolve()},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return this.ds.forEach((function(s,a){a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r.ds.delete(s),o.push(r.removeMatchingKeysForTargetId(t,a.targetId)),i++)})),ir.waitFor(o).next((function(){return i}))},t.prototype.getTargetCount=function(t){return ir.resolve(this.targetCount)},t.prototype.getTargetData=function(t,e){var n=this.ds.get(e)||null;return ir.resolve(n)},t.prototype.addMatchingKeys=function(t,e,n){return this._s.Jn(e,n),ir.resolve()},t.prototype.removeMatchingKeys=function(t,e,n){this._s.Xn(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach((function(e){i.push(r.markPotentiallyOrphaned(t,e))})),ir.waitFor(i)},t.prototype.removeMatchingKeysForTargetId=function(t,e){return this._s.Zn(e),ir.resolve()},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=this._s.es(e);return ir.resolve(n)},t.prototype.containsKey=function(t,e){return ir.resolve(this._s.containsKey(e))},t}(),Qi=function(){function t(t,e){var n=this;this.gs={},this.Ne=new u(0),this.xe=!1,this.xe=!0,this.referenceDelegate=t(this),this.qe=new Gi(this),this.Ut=new Lr,this.Ue=function(t,e){return new ji(t,(function(t){return n.referenceDelegate.ps(t)}))}(this.Ut),this.R=new _r(e),this.Qe=new Vi(this.R)}return t.prototype.start=function(){return Promise.resolve()},t.prototype.shutdown=function(){return this.xe=!1,Promise.resolve()},Object.defineProperty(t.prototype,"started",{get:function(){return this.xe},enumerable:!1,configurable:!0}),t.prototype.setDatabaseDeletedListener=function(){},t.prototype.setNetworkEnabled=function(){},t.prototype.getIndexManager=function(){return this.Ut},t.prototype.getMutationQueue=function(t){var e=this.gs[t.toKey()];return e||(e=new Bi(this.Ut,this.referenceDelegate),this.gs[t.toKey()]=e),e},t.prototype.getTargetCache=function(){return this.qe},t.prototype.getRemoteDocumentCache=function(){return this.Ue},t.prototype.getBundleCache=function(){return this.Qe},t.prototype.runTransaction=function(t,e,n){var r=this;d("MemoryPersistence","Starting transaction:",t);var i=new zi(this.Ne.next());return this.referenceDelegate.Es(),n(i).next((function(t){return r.referenceDelegate.Ts(i).next((function(){return t}))})).toPromise().then((function(t){return i.raiseOnCommittedEvent(),t}))},t.prototype.Is=function(t,e){return ir.or(Object.values(this.gs).map((function(n){return function(){return n.containsKey(t,e)}})))},t}(),zi=function(t){function e(e){var n=this;return(n=t.call(this)||this).currentSequenceNumber=e,n}return(0,s.__extends)(e,t),e}(nr),Wi=function(){function t(t){this.persistence=t,this.As=new qi,this.Rs=null}return t.bs=function(e){return new t(e)},Object.defineProperty(t.prototype,"vs",{get:function(){if(this.Rs)return this.Rs;throw m()},enumerable:!1,configurable:!0}),t.prototype.addReference=function(t,e,n){return this.As.addReference(n,e),this.vs.delete(n.toString()),ir.resolve()},t.prototype.removeReference=function(t,e,n){return this.As.removeReference(n,e),this.vs.add(n.toString()),ir.resolve()},t.prototype.markPotentiallyOrphaned=function(t,e){return this.vs.add(e.toString()),ir.resolve()},t.prototype.removeTarget=function(t,e){var n=this;this.As.Zn(e.targetId).forEach((function(t){return n.vs.add(t.toString())}));var r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(t,e.targetId).next((function(t){t.forEach((function(t){return n.vs.add(t.toString())}))})).next((function(){return r.removeTargetData(t,e)}))},t.prototype.Es=function(){this.Rs=new Set},t.prototype.Ts=function(t){var e=this,n=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ir.forEach(this.vs,(function(r){var i=z.fromPath(r);return e.Ps(t,i).next((function(t){t||n.removeEntry(i)}))})).next((function(){return e.Rs=null,n.apply(t)}))},t.prototype.updateLimboDocument=function(t,e){var n=this;return this.Ps(t,e).next((function(t){t?n.vs.delete(e.toString()):n.vs.add(e.toString())}))},t.prototype.ps=function(t){return 0},t.prototype.Ps=function(t,e){var n=this;return ir.or([function(){return ir.resolve(n.As.containsKey(e))},function(){return n.persistence.getTargetCache().containsKey(t,e)},function(){return n.persistence.Is(t,e)}])},t}(),Hi=function(){function t(t){this.uid=t}return t.prototype.isAuthenticated=function(){return null!=this.uid},t.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},t.prototype.isEqual=function(t){return t.uid===this.uid},t}();function Yi(t,e){return"firestore_clients_"+t+"_"+e}function $i(t,e,n){var r="firestore_mutations_"+t+"_"+n;return e.isAuthenticated()&&(r+="_"+e.uid),r}function Xi(t,e){return"firestore_targets_"+t+"_"+e}Hi.UNAUTHENTICATED=new Hi(null),Hi.GOOGLE_CREDENTIALS=new Hi("google-credentials-uid"),Hi.FIRST_PARTY=new Hi("first-party-uid");var Ji=function(){function t(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}return t.Vs=function(e,n,r){var i,o=JSON.parse(r),s="object"==typeof o&&-1!==["pending","acknowledged","rejected"].indexOf(o.state)&&(void 0===o.error||"object"==typeof o.error);return s&&o.error&&(s="string"==typeof o.error.message&&"string"==typeof o.error.code)&&(i=new h(o.error.code,o.error.message)),s?new t(e,n,o.state,i):(p("SharedClientState","Failed to parse mutation state for ID '"+n+"': "+r),null)},t.prototype.Ss=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),Zi=function(){function t(t,e,n){this.targetId=t,this.state=e,this.error=n}return t.Vs=function(e,n){var r,i=JSON.parse(n),o="object"==typeof i&&-1!==["not-current","current","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error);return o&&i.error&&(o="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(r=new h(i.error.code,i.error.message)),o?new t(e,i.state,r):(p("SharedClientState","Failed to parse target state for ID '"+e+"': "+n),null)},t.prototype.Ss=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),to=function(){function t(t,e){this.clientId=t,this.activeTargetIds=e}return t.Vs=function(e,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,o=Ge(),s=0;i&&s<r.activeTargetIds.length;++s)i=Q(r.activeTargetIds[s]),o=o.add(r.activeTargetIds[s]);return i?new t(e,o):(p("SharedClientState","Failed to parse client data for instance '"+e+"': "+n),null)},t}(),eo=function(){function t(t,e){this.clientId=t,this.onlineState=e}return t.Vs=function(e){var n=JSON.parse(e);return"object"==typeof n&&-1!==["Unknown","Online","Offline"].indexOf(n.onlineState)&&"string"==typeof n.clientId?new t(n.clientId,n.onlineState):(p("SharedClientState","Failed to parse online state: "+e),null)},t}(),no=function(){function t(){this.activeTargetIds=Ge()}return t.prototype.Ds=function(t){this.activeTargetIds=this.activeTargetIds.add(t)},t.prototype.Cs=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},t.prototype.Ss=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},t}(),ro=function(){function t(t,e,n,r,i){this.window=t,this.Se=e,this.persistenceKey=n,this.Ns=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.xs=this.Fs.bind(this),this.ks=new xe(I),this.started=!1,this.$s=[];var o=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Os=Yi(this.persistenceKey,this.Ns),this.Ms=function(t){return"firestore_sequence_number_"+t}(this.persistenceKey),this.ks=this.ks.insert(this.Ns,new no),this.Ls=new RegExp("^firestore_clients_"+o+"_([^_]*)$"),this.Bs=new RegExp("^firestore_mutations_"+o+"_(\\d+)(?:_(.*))?$"),this.qs=new RegExp("^firestore_targets_"+o+"_(\\d+)$"),this.Us=function(t){return"firestore_online_state_"+t}(this.persistenceKey),this.Qs=function(t){return"firestore_bundle_loaded_"+t}(this.persistenceKey),this.window.addEventListener("storage",this.xs)}return t.yt=function(t){return!(!t||!t.localStorage)},t.prototype.start=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t,e,n,r,i,o,a,u,c,h,f,l=this;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return[4,this.syncEngine.fn()];case 1:for(t=s.sent(),e=0,n=t;e<n.length;e++)(r=n[e])!==this.Ns&&(i=this.getItem(Yi(this.persistenceKey,r)))&&(o=to.Vs(r,i))&&(this.ks=this.ks.insert(o.clientId,o));for(this.Ks(),(a=this.storage.getItem(this.Us))&&(u=this.js(a))&&this.Ws(u),c=0,h=this.$s;c<h.length;c++)f=h[c],this.Fs(f);return this.$s=[],this.window.addEventListener("pagehide",(function(){return l.shutdown()})),this.started=!0,[2]}}))}))},t.prototype.writeSequenceNumber=function(t){this.setItem(this.Ms,JSON.stringify(t))},t.prototype.getAllActiveQueryTargets=function(){return this.Gs(this.ks)},t.prototype.isActiveQueryTarget=function(t){var e=!1;return this.ks.forEach((function(n,r){r.activeTargetIds.has(t)&&(e=!0)})),e},t.prototype.addPendingMutation=function(t){this.zs(t,"pending")},t.prototype.updateMutationState=function(t,e,n){this.zs(t,e,n),this.Hs(t)},t.prototype.addLocalQueryTarget=function(t){var e="not-current";if(this.isActiveQueryTarget(t)){var n=this.storage.getItem(Xi(this.persistenceKey,t));if(n){var r=Zi.Vs(t,n);r&&(e=r.state)}}return this.Js.Ds(t),this.Ks(),e},t.prototype.removeLocalQueryTarget=function(t){this.Js.Cs(t),this.Ks()},t.prototype.isLocalQueryTarget=function(t){return this.Js.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){this.removeItem(Xi(this.persistenceKey,t))},t.prototype.updateQueryState=function(t,e,n){this.Ys(t,e,n)},t.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach((function(t){r.Hs(t)})),this.currentUser=t,n.forEach((function(t){r.addPendingMutation(t)}))},t.prototype.setOnlineState=function(t){this.Xs(t)},t.prototype.notifyBundleLoaded=function(){this.Zs()},t.prototype.shutdown=function(){this.started&&(this.window.removeEventListener("storage",this.xs),this.removeItem(this.Os),this.started=!1)},t.prototype.getItem=function(t){var e=this.storage.getItem(t);return d("SharedClientState","READ",t,e),e},t.prototype.setItem=function(t,e){d("SharedClientState","SET",t,e),this.storage.setItem(t,e)},t.prototype.removeItem=function(t){d("SharedClientState","REMOVE",t),this.storage.removeItem(t)},t.prototype.Fs=function(t){var e=this,n=t;if(n.storageArea===this.storage){if(d("SharedClientState","EVENT",n.key,n.newValue),n.key===this.Os)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Se.enqueueRetryable((function(){return(0,s.__awaiter)(e,void 0,void 0,(function(){var t,e,r,i,o,a;return(0,s.__generator)(this,(function(s){if(this.started){if(null!==n.key)if(this.Ls.test(n.key)){if(null==n.newValue)return t=this.ti(n.key),[2,this.ei(t,null)];if(e=this.ni(n.key,n.newValue))return[2,this.ei(e.clientId,e)]}else if(this.Bs.test(n.key)){if(null!==n.newValue&&(r=this.si(n.key,n.newValue)))return[2,this.ii(r)]}else if(this.qs.test(n.key)){if(null!==n.newValue&&(i=this.ri(n.key,n.newValue)))return[2,this.oi(i)]}else if(n.key===this.Us){if(null!==n.newValue&&(o=this.js(n.newValue)))return[2,this.Ws(o)]}else if(n.key===this.Ms)(a=function(t){var e=u.o;if(null!=t)try{var n=JSON.parse(t);g("number"==typeof n),e=n}catch(t){p("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(n.newValue))!==u.o&&this.sequenceNumberHandler(a);else if(n.key===this.Qs)return[2,this.syncEngine.ci()]}else this.$s.push(n);return[2]}))}))}))}},Object.defineProperty(t.prototype,"Js",{get:function(){return this.ks.get(this.Ns)},enumerable:!1,configurable:!0}),t.prototype.Ks=function(){this.setItem(this.Os,this.Js.Ss())},t.prototype.zs=function(t,e,n){var r=new Ji(this.currentUser,t,e,n),i=$i(this.persistenceKey,this.currentUser,t);this.setItem(i,r.Ss())},t.prototype.Hs=function(t){var e=$i(this.persistenceKey,this.currentUser,t);this.removeItem(e)},t.prototype.Xs=function(t){var e={clientId:this.Ns,onlineState:t};this.storage.setItem(this.Us,JSON.stringify(e))},t.prototype.Ys=function(t,e,n){var r=Xi(this.persistenceKey,t),i=new Zi(t,e,n);this.setItem(r,i.Ss())},t.prototype.Zs=function(){this.setItem(this.Qs,"value-not-used")},t.prototype.ti=function(t){var e=this.Ls.exec(t);return e?e[1]:null},t.prototype.ni=function(t,e){var n=this.ti(t);return to.Vs(n,e)},t.prototype.si=function(t,e){var n=this.Bs.exec(t),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return Ji.Vs(new Hi(i),r,e)},t.prototype.ri=function(t,e){var n=this.qs.exec(t),r=Number(n[1]);return Zi.Vs(r,e)},t.prototype.js=function(t){return eo.Vs(t)},t.prototype.ii=function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){return t.user.uid===this.currentUser.uid?[2,this.syncEngine.ui(t.batchId,t.state,t.error)]:(d("SharedClientState","Ignoring mutation for non-active user "+t.user.uid),[2])}))}))},t.prototype.oi=function(t){return this.syncEngine.ai(t.targetId,t.state,t.error)},t.prototype.ei=function(t,e){var n=this,r=e?this.ks.insert(t,e):this.ks.remove(t),i=this.Gs(this.ks),o=this.Gs(r),s=[],a=[];return o.forEach((function(t){i.has(t)||s.push(t)})),i.forEach((function(t){o.has(t)||a.push(t)})),this.syncEngine.hi(s,a).then((function(){n.ks=r}))},t.prototype.Ws=function(t){this.ks.get(t.clientId)&&this.onlineStateHandler(t.onlineState)},t.prototype.Gs=function(t){var e=Ge();return t.forEach((function(t,n){e=e.unionWith(n.activeTargetIds)})),e},t}(),io=function(){function t(){this.li=new no,this.fi={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}return t.prototype.addPendingMutation=function(t){},t.prototype.updateMutationState=function(t,e,n){},t.prototype.addLocalQueryTarget=function(t){return this.li.Ds(t),this.fi[t]||"not-current"},t.prototype.updateQueryState=function(t,e,n){this.fi[t]=e},t.prototype.removeLocalQueryTarget=function(t){this.li.Cs(t)},t.prototype.isLocalQueryTarget=function(t){return this.li.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){delete this.fi[t]},t.prototype.getAllActiveQueryTargets=function(){return this.li.activeTargetIds},t.prototype.isActiveQueryTarget=function(t){return this.li.activeTargetIds.has(t)},t.prototype.start=function(){return this.li=new no,Promise.resolve()},t.prototype.handleUserChange=function(t,e,n){},t.prototype.setOnlineState=function(t){},t.prototype.shutdown=function(){},t.prototype.writeSequenceNumber=function(t){},t.prototype.notifyBundleLoaded=function(){},t}(),oo=function(){function t(){}return t.prototype.di=function(t){},t.prototype.shutdown=function(){},t}(),so=function(){function t(){var t=this;this.wi=function(){return t._i()},this.mi=function(){return t.yi()},this.gi=[],this.pi()}return t.prototype.di=function(t){this.gi.push(t)},t.prototype.shutdown=function(){window.removeEventListener("online",this.wi),window.removeEventListener("offline",this.mi)},t.prototype.pi=function(){window.addEventListener("online",this.wi),window.addEventListener("offline",this.mi)},t.prototype._i=function(){d("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(var t=0,e=this.gi;t<e.length;t++)(0,e[t])(0)},t.prototype.yi=function(){d("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(var t=0,e=this.gi;t<e.length;t++)(0,e[t])(1)},t.yt=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},t}(),ao={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"},uo=function(){function t(t){this.Ei=t.Ei,this.Ti=t.Ti}return t.prototype.Ii=function(t){this.Ai=t},t.prototype.Ri=function(t){this.bi=t},t.prototype.onMessage=function(t){this.vi=t},t.prototype.close=function(){this.Ti()},t.prototype.send=function(t){this.Ei(t)},t.prototype.Pi=function(){this.Ai()},t.prototype.Vi=function(t){this.bi(t)},t.prototype.Si=function(t){this.vi(t)},t}(),co=function(t){function e(e){var n=this;return(n=t.call(this,e)||this).forceLongPolling=e.forceLongPolling,n.autoDetectLongPolling=e.autoDetectLongPolling,n.useFetchStreams=e.useFetchStreams,n}return(0,s.__extends)(e,t),e.prototype.ki=function(t,e,n,r){return new Promise((function(i,s){var a=new o.JJ;a.listenOnce(o.tw.COMPLETE,(function(){try{switch(a.getLastErrorCode()){case o.jK.NO_ERROR:var e=a.getResponseJson();d("Connection","XHR received:",JSON.stringify(e)),i(e);break;case o.jK.TIMEOUT:d("Connection",'RPC "'+t+'" timed out'),s(new h(c.DEADLINE_EXCEEDED,"Request time out"));break;case o.jK.HTTP_ERROR:var n=a.getStatus();if(d("Connection",'RPC "'+t+'" failed with status:',n,"response text:",a.getResponseText()),n>0){var r=a.getResponseJson().error;if(r&&r.status&&r.message){var u=function(t){var e=t.toLowerCase().replace(/_/g,"-");return Object.values(c).indexOf(e)>=0?e:c.UNKNOWN}(r.status);s(new h(u,r.message))}else s(new h(c.UNKNOWN,"Server responded with status "+a.getStatus()))}else s(new h(c.UNAVAILABLE,"Connection failed."));break;default:m()}}finally{d("Connection",'RPC "'+t+'" completed.')}}));var u=JSON.stringify(r);a.send(e,"POST",u,n,15)}))},e.prototype.Oi=function(t,e){var n=[this.Di,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=(0,o.UE)(),s=(0,o.FJ)(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new o.zI({})),this.Fi(a.initMessageHeaders,e),(0,r.isMobileCordova)()||(0,r.isReactNative)()||(0,r.isElectron)()||(0,r.isIE)()||(0,r.isUWP)()||(0,r.isBrowserExtension)()||(a.httpHeadersOverwriteParam="$httpHeaders");var u=n.join("");d("Connection","Creating WebChannel: "+u,a);var f=i.createWebChannel(u,a),l=!1,p=!1,v=new uo({Ei:function(t){p?d("Connection","Not sending because WebChannel is closed:",t):(l||(d("Connection","Opening WebChannel transport."),f.open(),l=!0),d("Connection","WebChannel sending:",t),f.send(t))},Ti:function(){return f.close()}}),m=function(t,e,n){t.listen(e,(function(t){try{n(t)}catch(t){setTimeout((function(){throw t}),0)}}))};return m(f,o.ii.EventType.OPEN,(function(){p||d("Connection","WebChannel transport opened.")})),m(f,o.ii.EventType.CLOSE,(function(){p||(p=!0,d("Connection","WebChannel transport closed"),v.Vi())})),m(f,o.ii.EventType.ERROR,(function(t){p||(p=!0,y("Connection","WebChannel transport errored:",t),v.Vi(new h(c.UNAVAILABLE,"The operation could not be completed")))})),m(f,o.ii.EventType.MESSAGE,(function(t){var e;if(!p){var n=t.data[0];g(!!n);var r=n,i=r.error||(null===(e=r[0])||void 0===e?void 0:e.error);if(i){d("Connection","WebChannel received error:",i);var o=i.status,s=function(t){var e=Ee[t];if(void 0!==e)return ke(e)}(o),a=i.message;void 0===s&&(s=c.INTERNAL,a="Unknown error status: "+o+" with message "+i.message),p=!0,v.Vi(new h(s,a)),f.close()}else d("Connection","WebChannel received:",n),v.Si(n)}})),m(s,o.ju.STAT_EVENT,(function(t){t.stat===o.kN.PROXY?d("Connection","Detected buffering proxy"):t.stat===o.kN.NOPROXY&&d("Connection","Detected no buffering proxy")})),setTimeout((function(){v.Pi()}),0),v},e}(function(){function t(t){this.databaseInfo=t,this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.Di=e+"://"+t.host,this.Ci="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}return t.prototype.Ni=function(t,e,n,r){var i=this.xi(t,e);d("RestConnection","Sending: ",i,n);var o={};return this.Fi(o,r),this.ki(t,i,o,n).then((function(t){return d("RestConnection","Received: ",t),t}),(function(e){throw y("RestConnection",t+" failed with error: ",e,"url: ",i,"request:",n),e}))},t.prototype.$i=function(t,e,n,r){return this.Ni(t,e,n,r)},t.prototype.Fi=function(t,e){if(t["X-Goog-Api-Client"]="gl-js/ fire/8.6.8",t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n])},t.prototype.xi=function(t,e){var n=ao[t];return this.Di+"/v1/"+e+":"+n},t}());function ho(){return"undefined"!=typeof window?window:null}function fo(){return"undefined"!=typeof document?document:null}function lo(t){return new nn(t,!0)}var po=function(){function t(t,e,n,r,i){void 0===n&&(n=1e3),void 0===r&&(r=1.5),void 0===i&&(i=6e4),this.Se=t,this.timerId=e,this.Mi=n,this.Li=r,this.Bi=i,this.qi=0,this.Ui=null,this.Qi=Date.now(),this.reset()}return t.prototype.reset=function(){this.qi=0},t.prototype.Ki=function(){this.qi=this.Bi},t.prototype.ji=function(t){var e=this;this.cancel();var n=Math.floor(this.qi+this.Wi()),r=Math.max(0,Date.now()-this.Qi),i=Math.max(0,n-r);i>0&&d("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.qi+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.Ui=this.Se.enqueueAfterDelay(this.timerId,i,(function(){return e.Qi=Date.now(),t()})),this.qi*=this.Li,this.qi<this.Mi&&(this.qi=this.Mi),this.qi>this.Bi&&(this.qi=this.Bi)},t.prototype.Gi=function(){null!==this.Ui&&(this.Ui.skipDelay(),this.Ui=null)},t.prototype.cancel=function(){null!==this.Ui&&(this.Ui.cancel(),this.Ui=null)},t.prototype.Wi=function(){return(Math.random()-.5)*this.qi},t}(),yo=function(){function t(t,e,n,r,i,o){this.Se=t,this.zi=n,this.Hi=r,this.Ji=i,this.listener=o,this.state=0,this.Yi=0,this.Xi=null,this.stream=null,this.Zi=new po(t,e)}return t.prototype.tr=function(){return 1===this.state||2===this.state||4===this.state},t.prototype.er=function(){return 2===this.state},t.prototype.start=function(){3!==this.state?this.auth():this.nr()},t.prototype.stop=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return this.tr()?[4,this.close(0)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.sr=function(){this.state=0,this.Zi.reset()},t.prototype.ir=function(){var t=this;this.er()&&null===this.Xi&&(this.Xi=this.Se.enqueueAfterDelay(this.zi,6e4,(function(){return t.rr()})))},t.prototype.cr=function(t){this.ur(),this.stream.send(t)},t.prototype.rr=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){return this.er()?[2,this.close(0)]:[2]}))}))},t.prototype.ur=function(){this.Xi&&(this.Xi.cancel(),this.Xi=null)},t.prototype.close=function(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return this.ur(),this.Zi.cancel(),this.Yi++,3!==t?this.Zi.reset():e&&e.code===c.RESOURCE_EXHAUSTED?(p(e.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.Zi.Ki()):e&&e.code===c.UNAUTHENTICATED&&this.Ji.invalidateToken(),null!==this.stream&&(this.ar(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.Ri(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.ar=function(){},t.prototype.auth=function(){var t=this;this.state=1;var e=this.hr(this.Yi),n=this.Yi;this.Ji.getToken().then((function(e){t.Yi===n&&t.lr(e)}),(function(n){e((function(){var e=new h(c.UNKNOWN,"Fetching auth token failed: "+n.message);return t.dr(e)}))}))},t.prototype.lr=function(t){var e=this,n=this.hr(this.Yi);this.stream=this.wr(t),this.stream.Ii((function(){n((function(){return e.state=2,e.listener.Ii()}))})),this.stream.Ri((function(t){n((function(){return e.dr(t)}))})),this.stream.onMessage((function(t){n((function(){return e.onMessage(t)}))}))},t.prototype.nr=function(){var t=this;this.state=4,this.Zi.ji((function(){return(0,s.__awaiter)(t,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){return this.state=0,this.start(),[2]}))}))}))},t.prototype.dr=function(t){return d("PersistentStream","close with error: "+t),this.stream=null,this.close(3,t)},t.prototype.hr=function(t){var e=this;return function(n){e.Se.enqueueAndForget((function(){return e.Yi===t?n():(d("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())}))}},t}(),vo=function(t){function e(e,n,r,i,o){var s=this;return(s=t.call(this,e,"listen_stream_connection_backoff","listen_stream_idle",n,r,o)||this).R=i,s}return(0,s.__extends)(e,t),e.prototype.wr=function(t){return this.Hi.Oi("Listen",t)},e.prototype.onMessage=function(t){this.Zi.reset();var e=function(t,e){var n;if("targetChange"in e){e.targetChange;var r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:m()}(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],o=function(t,e){return t.I?(g(void 0===e||"string"==typeof e),P.fromBase64String(e||"")):(g(void 0===e||e instanceof Uint8Array),P.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),s=(a=e.targetChange.cause)&&function(t){var e=void 0===t.code?c.UNKNOWN:ke(t.code);return new h(e,t.message||"")}(a);n=new Ye(r,i,o,s||null)}else if("documentChange"in e){e.documentChange,(r=e.documentChange).document,r.document.name,r.document.updateTime,i=fn(t,r.document.name),o=an(r.document.updateTime);var a=new at({mapValue:{fields:r.document.fields}}),u=(s=ct.newFoundDocument(i,o,a),r.targetIds||[]),f=r.removedTargetIds||[];n=new We(u,f,s.key,s)}else if("documentDelete"in e)e.documentDelete,(r=e.documentDelete).document,i=fn(t,r.document),o=r.readTime?an(r.readTime):N.min(),a=ct.newNoDocument(i,o),s=r.removedTargetIds||[],n=new We([],s,a.key,a);else if("documentRemove"in e)e.documentRemove,(r=e.documentRemove).document,i=fn(t,r.document),o=r.removedTargetIds||[],n=new We([],o,i,null);else{if(!("filter"in e))return m();e.filter;var l=e.filter;l.targetId,r=l.count||0,i=new De(r),o=l.targetId,n=new He(o,i)}return n}(this.R,t),n=function(t){if(!("targetChange"in t))return N.min();var e=t.targetChange;return e.targetIds&&e.targetIds.length?N.min():e.readTime?an(e.readTime):N.min()}(t);return this.listener._r(e,n)},e.prototype.mr=function(t){var e={};e.database=pn(this.R),e.addTarget=function(t,e){var n,r=e.target;return(n=pt(r)?{documents:wn(t,r)}:{query:bn(t,r)}).targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=on(t,e.resumeToken):e.snapshotVersion.compareTo(N.min())>0&&(n.readTime=rn(t,e.snapshotVersion.toTimestamp())),n}(this.R,t);var n=function(t,e){var n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return m()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.R,t);n&&(e.labels=n),this.cr(e)},e.prototype.yr=function(t){var e={};e.database=pn(this.R),e.removeTarget=t,this.cr(e)},e}(yo),mo=function(t){function e(e,n,r,i,o){var s=this;return(s=t.call(this,e,"write_stream_connection_backoff","write_stream_idle",n,r,o)||this).R=i,s.gr=!1,s}return(0,s.__extends)(e,t),Object.defineProperty(e.prototype,"pr",{get:function(){return this.gr},enumerable:!1,configurable:!0}),e.prototype.start=function(){this.gr=!1,this.lastStreamToken=void 0,t.prototype.start.call(this)},e.prototype.ar=function(){this.gr&&this.Er([])},e.prototype.wr=function(t){return this.Hi.Oi("Write",t)},e.prototype.onMessage=function(t){if(g(!!t.streamToken),this.lastStreamToken=t.streamToken,this.gr){this.Zi.reset();var e=function(t,e){return t&&t.length>0?(g(void 0!==e),t.map((function(t){return function(t,e){var n=t.updateTime?an(t.updateTime):an(e);return n.isEqual(N.min())&&(n=an(e)),new ce(n,t.transformResults||[])}(t,e)}))):[]}(t.writeResults,t.commitTime),n=an(t.commitTime);return this.listener.Tr(n,e)}return g(!t.writeResults||0===t.writeResults.length),this.gr=!0,this.listener.Ir()},e.prototype.Ar=function(){var t={};t.database=pn(this.R),this.cr(t)},e.prototype.Er=function(t){var e=this,n={streamToken:this.lastStreamToken,writes:t.map((function(t){return gn(e.R,t)}))};this.cr(n)},e}(yo),go=function(t){function e(e,n,r){var i=this;return(i=t.call(this)||this).credentials=e,i.Hi=n,i.R=r,i.Rr=!1,i}return(0,s.__extends)(e,t),e.prototype.br=function(){if(this.Rr)throw new h(c.FAILED_PRECONDITION,"The client has already been terminated.")},e.prototype.Ni=function(t,e,n){var r=this;return this.br(),this.credentials.getToken().then((function(i){return r.Hi.Ni(t,e,n,i)})).catch((function(t){throw"FirebaseError"===t.name?(t.code===c.UNAUTHENTICATED&&r.credentials.invalidateToken(),t):new h(c.UNKNOWN,t.toString())}))},e.prototype.$i=function(t,e,n){var r=this;return this.br(),this.credentials.getToken().then((function(i){return r.Hi.$i(t,e,n,i)})).catch((function(t){throw"FirebaseError"===t.name?(t.code===c.UNAUTHENTICATED&&r.credentials.invalidateToken(),t):new h(c.UNKNOWN,t.toString())}))},e.prototype.terminate=function(){this.Rr=!0},e}((function(){})),_o=function(){function t(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.vr=0,this.Pr=null,this.Vr=!0}return t.prototype.Sr=function(){var t=this;0===this.vr&&(this.Dr("Unknown"),this.Pr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(function(){return t.Pr=null,t.Cr("Backend didn't respond within 10 seconds."),t.Dr("Offline"),Promise.resolve()})))},t.prototype.Nr=function(t){"Online"===this.state?this.Dr("Unknown"):(this.vr++,this.vr>=1&&(this.Fr(),this.Cr("Connection failed 1 times. Most recent error: "+t.toString()),this.Dr("Offline")))},t.prototype.set=function(t){this.Fr(),this.vr=0,"Online"===t&&(this.Vr=!1),this.Dr(t)},t.prototype.Dr=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},t.prototype.Cr=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.Vr?(p(e),this.Vr=!1):d("OnlineStateTracker",e)},t.prototype.Fr=function(){null!==this.Pr&&(this.Pr.cancel(),this.Pr=null)},t}(),wo=function(t,e,n,r,i){var o=this;this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.kr=[],this.$r=new Map,this.Or=new Set,this.Mr=[],this.Lr=i,this.Lr.di((function(t){n.enqueueAndForget((function(){return(0,s.__awaiter)(o,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return ko(this)?(d("RemoteStore","Restarting streams for network reachability change."),[4,function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return(e=_(t)).Or.add(4),[4,Io(e)];case 1:return n.sent(),e.Br.set("Unknown"),e.Or.delete(4),[4,bo(e)];case 2:return n.sent(),[2]}}))}))}(this)]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}))})),this.Br=new _o(n,r)};function bo(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e,n;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:if(!ko(t))return[3,4];e=0,n=t.Mr,r.label=1;case 1:return e<n.length?[4,(0,n[e])(!0)]:[3,4];case 2:r.sent(),r.label=3;case 3:return e++,[3,1];case 4:return[2]}}))}))}function Io(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e,n;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:e=0,n=t.Mr,r.label=1;case 1:return e<n.length?[4,(0,n[e])(!1)]:[3,4];case 2:r.sent(),r.label=3;case 3:return e++,[3,1];case 4:return[2]}}))}))}function Eo(t,e){var n=_(t);n.$r.has(e.targetId)||(n.$r.set(e.targetId,e),Ao(n)?Do(n):Go(n).er()&&So(n,e))}function To(t,e){var n=_(t),r=Go(n);n.$r.delete(e),r.er()&&No(n,e),0===n.$r.size&&(r.er()?r.ir():ko(n)&&n.Br.set("Unknown"))}function So(t,e){t.qr.U(e.targetId),Go(t).mr(e)}function No(t,e){t.qr.U(e),Go(t).yr(e)}function Do(t){t.qr=new Xe({getRemoteKeysForTarget:function(e){return t.remoteSyncer.getRemoteKeysForTarget(e)},lt:function(e){return t.$r.get(e)||null}}),Go(t).start(),t.Br.Sr()}function Ao(t){return ko(t)&&!Go(t).tr()&&t.$r.size>0}function ko(t){return 0===_(t).Or.size}function xo(t){t.qr=void 0}function Co(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){return t.$r.forEach((function(e,n){So(t,e)})),[2]}))}))}function Ro(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(n){return xo(t),Ao(t)?(t.Br.Nr(e),Do(t)):t.Br.set("Unknown"),[2]}))}))}function Lo(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i,o;return(0,s.__generator)(this,(function(a){switch(a.label){case 0:if(t.Br.set("Online"),!(e instanceof Ye&&2===e.state&&e.cause))return[3,6];a.label=1;case 1:return a.trys.push([1,3,,5]),[4,function(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:n=e.cause,r=0,i=e.targetIds,s.label=1;case 1:return r<i.length?(o=i[r],t.$r.has(o)?[4,t.remoteSyncer.rejectListen(o,n)]:[3,3]):[3,5];case 2:s.sent(),t.$r.delete(o),t.qr.removeTarget(o),s.label=3;case 3:s.label=4;case 4:return r++,[3,1];case 5:return[2]}}))}))}(t,e)];case 2:return a.sent(),[3,5];case 3:return r=a.sent(),d("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),r),[4,Oo(t,r)];case 4:return a.sent(),[3,5];case 5:return[3,13];case 6:if(e instanceof We?t.qr.X(e):e instanceof He?t.qr.rt(e):t.qr.et(e),n.isEqual(N.min()))return[3,13];a.label=7;case 7:return a.trys.push([7,11,,13]),[4,Ni(t.localStore)];case 8:return i=a.sent(),n.compareTo(i)>=0?[4,function(t,e){var n=t.qr.ut(e);return n.targetChanges.forEach((function(n,r){if(n.resumeToken.approximateByteSize()>0){var i=t.$r.get(r);i&&t.$r.set(r,i.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((function(e){var n=t.$r.get(e);if(n){t.$r.set(e,n.withResumeToken(P.EMPTY_BYTE_STRING,n.snapshotVersion)),No(t,e);var r=new gr(n.target,e,1,n.sequenceNumber);So(t,r)}})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)]:[3,10];case 9:a.sent(),a.label=10;case 10:return[3,13];case 11:return d("RemoteStore","Failed to raise snapshot:",o=a.sent()),[4,Oo(t,o)];case 12:return a.sent(),[3,13];case 13:return[2]}}))}))}function Oo(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r=this;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:if(!cr(e))throw e;return t.Or.add(1),[4,Io(t)];case 1:return i.sent(),t.Br.set("Offline"),n||(n=function(){return Ni(t.localStore)}),t.asyncQueue.enqueueRetryable((function(){return(0,s.__awaiter)(r,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return d("RemoteStore","Retrying IndexedDB access"),[4,n()];case 1:return e.sent(),t.Or.delete(1),[4,bo(t)];case 2:return e.sent(),[2]}}))}))})),[2]}}))}))}function Po(t,e){return e().catch((function(n){return Oo(t,n,e)}))}function Mo(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e,n,r,i,o;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:e=_(t),n=Qo(e),r=e.kr.length>0?e.kr[e.kr.length-1].batchId:-1,s.label=1;case 1:if(!function(t){return ko(t)&&t.kr.length<10}(e))return[3,7];s.label=2;case 2:return s.trys.push([2,4,,6]),[4,ki(e.localStore,r)];case 3:return null===(i=s.sent())?(0===e.kr.length&&n.ir(),[3,7]):(r=i.batchId,function(t,e){t.kr.push(e);var n=Qo(t);n.er()&&n.pr&&n.Er(e.mutations)}(e,i),[3,6]);case 4:return o=s.sent(),[4,Oo(e,o)];case 5:return s.sent(),[3,6];case 6:return[3,1];case 7:return Fo(e)&&Vo(e),[2]}}))}))}function Fo(t){return ko(t)&&!Qo(t).tr()&&t.kr.length>0}function Vo(t){Qo(t).start()}function qo(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){return Qo(t).Ar(),[2]}))}))}function Uo(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e,n,r,i;return(0,s.__generator)(this,(function(o){for(e=Qo(t),n=0,r=t.kr;n<r.length;n++)i=r[n],e.Er(i.mutations);return[2]}))}))}function Bo(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return r=t.kr.shift(),i=mr.from(r,e,n),[4,Po(t,(function(){return t.remoteSyncer.applySuccessfulWrite(i)}))];case 1:return o.sent(),[4,Mo(t)];case 2:return o.sent(),[2]}}))}))}function jo(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return e&&Qo(t).pr?[4,function(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return Ae(r=e.code)&&r!==c.ABORTED?(n=t.kr.shift(),Qo(t).sr(),[4,Po(t,(function(){return t.remoteSyncer.rejectFailedWrite(n.batchId,e)}))]):[3,3];case 1:return i.sent(),[4,Mo(t)];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))}(t,e)]:[3,2];case 1:n.sent(),n.label=2;case 2:return Fo(t)&&Vo(t),[2]}}))}))}function Ko(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return n=_(t),e?(n.Or.delete(2),[4,bo(n)]):[3,2];case 1:return r.sent(),[3,5];case 2:return e?[3,4]:(n.Or.add(2),[4,Io(n)]);case 3:r.sent(),n.Br.set("Unknown"),r.label=4;case 4:r.label=5;case 5:return[2]}}))}))}function Go(t){var e=this;return t.Ur||(t.Ur=function(t,e,n){var r=_(t);return r.br(),new vo(e,r.Hi,r.credentials,r.R,n)}(t.datastore,t.asyncQueue,{Ii:Co.bind(null,t),Ri:Ro.bind(null,t),_r:Lo.bind(null,t)}),t.Mr.push((function(n){return(0,s.__awaiter)(e,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return n?(t.Ur.sr(),Ao(t)?Do(t):t.Br.set("Unknown"),[3,3]):[3,1];case 1:return[4,t.Ur.stop()];case 2:e.sent(),xo(t),e.label=3;case 3:return[2]}}))}))}))),t.Ur}function Qo(t){var e=this;return t.Qr||(t.Qr=function(t,e,n){var r=_(t);return r.br(),new mo(e,r.Hi,r.credentials,r.R,n)}(t.datastore,t.asyncQueue,{Ii:qo.bind(null,t),Ri:jo.bind(null,t),Ir:Uo.bind(null,t),Tr:Bo.bind(null,t)}),t.Mr.push((function(n){return(0,s.__awaiter)(e,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return n?(t.Qr.sr(),[4,Mo(t)]):[3,2];case 1:return e.sent(),[3,4];case 2:return[4,t.Qr.stop()];case 3:e.sent(),t.kr.length>0&&(d("RemoteStore","Stopping write stream with "+t.kr.length+" pending writes"),t.kr=[]),e.label=4;case 4:return[2]}}))}))}))),t.Qr}var zo=function(){function t(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new rr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((function(t){}))}return t.createAndSchedule=function(e,n,r,i,o){var s=new t(e,n,Date.now()+r,i,o);return s.start(r),s},t.prototype.start=function(t){var e=this;this.timerHandle=setTimeout((function(){return e.handleDelayElapsed()}),t)},t.prototype.skipDelay=function(){return this.handleDelayElapsed()},t.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new h(c.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},t.prototype.handleDelayElapsed=function(){var t=this;this.asyncQueue.enqueueAndForget((function(){return null!==t.timerHandle?(t.clearTimeout(),t.op().then((function(e){return t.deferred.resolve(e)}))):Promise.resolve()}))},t.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},t}();function Wo(t,e){if(p("AsyncQueue",e+": "+t),cr(t))return new h(c.UNAVAILABLE,e+": "+t);throw t}var Ho=function(){function t(t){this.comparator=t?function(e,n){return t(e,n)||z.comparator(e.key,n.key)}:function(t,e){return z.comparator(t.key,e.key)},this.keyedMap=Ve(),this.sortedSet=new xe(this.comparator)}return t.emptySet=function(e){return new t(e.comparator)},t.prototype.has=function(t){return null!=this.keyedMap.get(t)},t.prototype.get=function(t){return this.keyedMap.get(t)},t.prototype.first=function(){return this.sortedSet.minKey()},t.prototype.last=function(){return this.sortedSet.maxKey()},t.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},t.prototype.indexOf=function(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(t.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!1,configurable:!0}),t.prototype.forEach=function(t){this.sortedSet.inorderTraversal((function(e,n){return t(e),!1}))},t.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},t.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(!i.isEqual(o))return!1}return!0},t.prototype.toString=function(){var t=[];return this.forEach((function(e){t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},t.prototype.copy=function(e,n){var r=new t;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=n,r},t}(),Yo=function(){function t(){this.Kr=new xe(z.comparator)}return t.prototype.track=function(t){var e=t.doc.key,n=this.Kr.get(e);n?0!==t.type&&3===n.type?this.Kr=this.Kr.insert(e,t):3===t.type&&1!==n.type?this.Kr=this.Kr.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Kr=this.Kr.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Kr=this.Kr.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Kr=this.Kr.remove(e):1===t.type&&2===n.type?this.Kr=this.Kr.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Kr=this.Kr.insert(e,{type:2,doc:t.doc}):m():this.Kr=this.Kr.insert(e,t)},t.prototype.jr=function(){var t=[];return this.Kr.inorderTraversal((function(e,n){t.push(n)})),t},t}(),$o=function(){function t(t,e,n,r,i,o,s,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=s,this.excludesMetadataChanges=a}return t.fromInitialDocuments=function(e,n,r,i){var o=[];return n.forEach((function(t){o.push({type:0,doc:t})})),new t(e,n,Ho.emptySet(n),o,r,i,!0,!1)},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!1,configurable:!0}),t.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Bt(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},t}(),Xo=function(){this.Wr=void 0,this.listeners=[]},Jo=function(){this.queries=new ii((function(t){return jt(t)}),Bt),this.onlineState="Unknown",this.Gr=new Set};function Zo(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o,a,u,c;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(n=_(t),r=e.query,i=!1,(o=n.queries.get(r))||(i=!0,o=new Xo),!i)return[3,4];s.label=1;case 1:return s.trys.push([1,3,,4]),a=o,[4,n.onListen(r)];case 2:return a.Wr=s.sent(),[3,4];case 3:return u=s.sent(),c=Wo(u,"Initialization of query '"+Kt(e.query)+"' failed"),[2,void e.onError(c)];case 4:return n.queries.set(r,o),o.listeners.push(e),e.zr(n.onlineState),o.Wr&&e.Hr(o.Wr)&&rs(n),[2]}}))}))}function ts(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o,a;return(0,s.__generator)(this,(function(s){return n=_(t),r=e.query,i=!1,(o=n.queries.get(r))&&(a=o.listeners.indexOf(e))>=0&&(o.listeners.splice(a,1),i=0===o.listeners.length),i?[2,(n.queries.delete(r),n.onUnlisten(r))]:[2]}))}))}function es(t,e){for(var n=_(t),r=!1,i=0,o=e;i<o.length;i++){var s=o[i],a=s.query,u=n.queries.get(a);if(u){for(var c=0,h=u.listeners;c<h.length;c++)h[c].Hr(s)&&(r=!0);u.Wr=s}}r&&rs(n)}function ns(t,e,n){var r=_(t),i=r.queries.get(e);if(i)for(var o=0,s=i.listeners;o<s.length;o++)s[o].onError(n);r.queries.delete(e)}function rs(t){t.Gr.forEach((function(t){t.next()}))}var is=function(){function t(t,e,n){this.query=t,this.Jr=e,this.Yr=!1,this.Xr=null,this.onlineState="Unknown",this.options=n||{}}return t.prototype.Hr=function(t){if(!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];3!==i.type&&e.push(i)}t=new $o(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}var o=!1;return this.Yr?this.Zr(t)&&(this.Jr.next(t),o=!0):this.eo(t,this.onlineState)&&(this.no(t),o=!0),this.Xr=t,o},t.prototype.onError=function(t){this.Jr.error(t)},t.prototype.zr=function(t){this.onlineState=t;var e=!1;return this.Xr&&!this.Yr&&this.eo(this.Xr,t)&&(this.no(this.Xr),e=!0),e},t.prototype.eo=function(t,e){if(!t.fromCache)return!0;var n="Offline"!==e;return!(this.options.so&&n||t.docs.isEmpty()&&"Offline"!==e)},t.prototype.Zr=function(t){if(t.docChanges.length>0)return!0;var e=this.Xr&&this.Xr.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges},t.prototype.no=function(t){t=$o.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.Yr=!0,this.Jr.next(t)},t}(),os=function(){function t(t,e){this.payload=t,this.byteLength=e}return t.prototype.io=function(){return"metadata"in this.payload},t}(),ss=function(){function t(t){this.R=t}return t.prototype.qn=function(t){return fn(this.R,t)},t.prototype.Un=function(t){return t.metadata.exists?mn(this.R,t.document,!1):ct.newNoDocument(this.qn(t.metadata.name),this.Qn(t.metadata.readTime))},t.prototype.Qn=function(t){return an(t)},t}(),as=function(){function t(t,e,n){this.ro=t,this.localStore=e,this.R=n,this.queries=[],this.documents=[],this.progress=us(t)}return t.prototype.oo=function(t){this.progress.bytesLoaded+=t.byteLength;var e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null},t.prototype.co=function(t){for(var e=new Map,n=new ss(this.R),r=0,i=t;r<i.length;r++){var o=i[r];if(o.metadata.queries)for(var s=n.qn(o.metadata.name),a=0,u=o.metadata.queries;a<u.length;a++){var c=u[a],h=(e.get(c)||je()).add(s);e.set(c,h)}}return e},t.prototype.complete=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t,e,n,r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return[4,Mi(this.localStore,new ss(this.R),this.documents,this.ro.id)];case 1:t=o.sent(),e=this.co(this.documents),n=0,r=this.queries,o.label=2;case 2:return n<r.length?(i=r[n],[4,Fi(this.localStore,i,e.get(i.name))]):[3,5];case 3:o.sent(),o.label=4;case 4:return n++,[3,2];case 5:return[2,(this.progress.taskState="Success",new gi(Object.assign({},this.progress),t))]}}))}))},t}();function us(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}var cs=function(t){this.key=t},hs=function(t){this.key=t},fs=function(){function t(t,e){this.query=t,this.uo=e,this.ao=null,this.current=!1,this.ho=je(),this.mutatedKeys=je(),this.lo=Qt(t),this.fo=new Ho(this.lo)}return Object.defineProperty(t.prototype,"wo",{get:function(){return this.uo},enumerable:!1,configurable:!0}),t.prototype._o=function(t,e){var n=this,r=e?e.mo:new Yo,i=e?e.fo:this.fo,o=e?e.mutatedKeys:this.mutatedKeys,s=i,a=!1,u=Lt(this.query)&&i.size===this.query.limit?i.last():null,c=Ot(this.query)&&i.size===this.query.limit?i.first():null;if(t.inorderTraversal((function(t,e){var h=i.get(t),f=Gt(n.query,e)?e:null,l=!!h&&n.mutatedKeys.has(h.key),d=!!f&&(f.hasLocalMutations||n.mutatedKeys.has(f.key)&&f.hasCommittedMutations),p=!1;h&&f?h.data.isEqual(f.data)?l!==d&&(r.track({type:3,doc:f}),p=!0):n.yo(h,f)||(r.track({type:2,doc:f}),p=!0,(u&&n.lo(f,u)>0||c&&n.lo(f,c)<0)&&(a=!0)):!h&&f?(r.track({type:0,doc:f}),p=!0):h&&!f&&(r.track({type:1,doc:h}),p=!0,(u||c)&&(a=!0)),p&&(f?(s=s.add(f),o=d?o.add(t):o.delete(t)):(s=s.delete(t),o=o.delete(t)))})),Lt(this.query)||Ot(this.query))for(;s.size>this.query.limit;){var h=Lt(this.query)?s.last():s.first();s=s.delete(h.key),o=o.delete(h.key),r.track({type:1,doc:h})}return{fo:s,mo:r,Nn:a,mutatedKeys:o}},t.prototype.yo=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},t.prototype.applyChanges=function(t,e,n){var r=this,i=this.fo;this.fo=t.fo,this.mutatedKeys=t.mutatedKeys;var o=t.mo.jr();o.sort((function(t,e){return function(t,e){var n=function(t){switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return m()}};return n(t)-n(e)}(t.type,e.type)||r.lo(t.doc,e.doc)})),this.po(n);var s=e?this.Eo():[],a=0===this.ho.size&&this.current?1:0,u=a!==this.ao;return this.ao=a,0!==o.length||u?{snapshot:new $o(this.query,t.fo,i,o,t.mutatedKeys,0===a,u,!1),To:s}:{To:s}},t.prototype.zr=function(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({fo:this.fo,mo:new Yo,mutatedKeys:this.mutatedKeys,Nn:!1},!1)):{To:[]}},t.prototype.Io=function(t){return!this.uo.has(t)&&!!this.fo.has(t)&&!this.fo.get(t).hasLocalMutations},t.prototype.po=function(t){var e=this;t&&(t.addedDocuments.forEach((function(t){return e.uo=e.uo.add(t)})),t.modifiedDocuments.forEach((function(t){})),t.removedDocuments.forEach((function(t){return e.uo=e.uo.delete(t)})),this.current=t.current)},t.prototype.Eo=function(){var t=this;if(!this.current)return[];var e=this.ho;this.ho=je(),this.fo.forEach((function(e){t.Io(e.key)&&(t.ho=t.ho.add(e.key))}));var n=[];return e.forEach((function(e){t.ho.has(e)||n.push(new hs(e))})),this.ho.forEach((function(t){e.has(t)||n.push(new cs(t))})),n},t.prototype.Ao=function(t){this.uo=t.Bn,this.ho=je();var e=this._o(t.documents);return this.applyChanges(e,!0)},t.prototype.Ro=function(){return $o.fromInitialDocuments(this.query,this.fo,this.mutatedKeys,0===this.ao)},t}(),ls=function(t,e,n){this.query=t,this.targetId=e,this.view=n},ds=function(t){this.key=t,this.bo=!1},ps=function(){function t(t,e,n,r,i,o){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=o,this.vo={},this.Po=new ii((function(t){return jt(t)}),Bt),this.Vo=new Map,this.So=new Set,this.Do=new xe(z.comparator),this.Co=new Map,this.No=new qi,this.xo={},this.Fo=new Map,this.ko=zr.Yt(),this.onlineState="Unknown",this.$o=void 0}return Object.defineProperty(t.prototype,"isPrimaryClient",{get:function(){return!0===this.$o},enumerable:!1,configurable:!0}),t}();function ys(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o,a,u;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return n=Gs(t),(o=n.Po.get(e))?(r=o.targetId,n.sharedClientState.addLocalQueryTarget(r),i=o.view.Ro(),[3,4]):[3,1];case 1:return[4,xi(n.localStore,qt(e))];case 2:return a=s.sent(),u=n.sharedClientState.addLocalQueryTarget(a.targetId),r=a.targetId,[4,vs(n,e,r,"current"===u)];case 3:i=s.sent(),n.isPrimaryClient&&Eo(n.remoteStore,a),s.label=4;case 4:return[2,i]}}))}))}function vs(t,e,n,r){return(0,s.__awaiter)(this,void 0,void 0,(function(){var i,o,a,u,c,h;return(0,s.__generator)(this,(function(f){switch(f.label){case 0:return t.Oo=function(e,n,r){return function(t,e,n,r){return(0,s.__awaiter)(this,void 0,void 0,(function(){var i,o,a;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return(i=e.view._o(n)).Nn?[4,Ri(t.localStore,e.query,!1).then((function(t){var n=t.documents;return e.view._o(n,i)}))]:[3,2];case 1:i=s.sent(),s.label=2;case 2:return o=r&&r.targetChanges.get(e.targetId),a=e.view.applyChanges(i,t.isPrimaryClient,o),[2,(ks(t,e.targetId,a.To),a.snapshot)]}}))}))}(t,e,n,r)},[4,Ri(t.localStore,e,!0)];case 1:return i=f.sent(),o=new fs(e,i.Bn),a=o._o(i.documents),u=ze.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState),c=o.applyChanges(a,t.isPrimaryClient,u),ks(t,n,c.To),h=new ls(e,n,o),[2,(t.Po.set(e,h),t.Vo.has(n)?t.Vo.get(n).push(e):t.Vo.set(n,[e]),c.snapshot)]}}))}))}function ms(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return n=_(t),r=n.Po.get(e),(i=n.Vo.get(r.targetId)).length>1?[2,(n.Vo.set(r.targetId,i.filter((function(t){return!Bt(t,e)}))),void n.Po.delete(e))]:n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)?[3,2]:[4,Ci(n.localStore,r.targetId,!1).then((function(){n.sharedClientState.clearQueryState(r.targetId),To(n.remoteStore,r.targetId),Ds(n,r.targetId)})).catch(Xr)]):[3,3];case 1:o.sent(),o.label=2;case 2:return[3,5];case 3:return Ds(n,r.targetId),[4,Ci(n.localStore,r.targetId,!0)];case 4:o.sent(),o.label=5;case 5:return[2]}}))}))}function gs(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,a;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:r=Qs(t),s.label=1;case 1:return s.trys.push([1,5,,6]),[4,function(t,e){var n,r=_(t),i=S.now(),o=e.reduce((function(t,e){return t.add(e.key)}),je());return r.persistence.runTransaction("Locally write mutations","readwrite",(function(t){return r.Mn.pn(t,o).next((function(o){n=o;for(var s=[],a=0,u=e;a<u.length;a++){var c=u[a],h=ye(c,n.get(c.key));null!=h&&s.push(new _e(c.key,h,ut(h.value.mapValue),he.exists(!0)))}return r._n.addMutationBatch(t,i,s,e)}))})).then((function(t){return t.applyToLocalDocumentSet(n),{batchId:t.batchId,changes:n}}))}(r.localStore,e)];case 2:return i=s.sent(),r.sharedClientState.addPendingMutation(i.batchId),function(t,e,n){var r=t.xo[t.currentUser.toKey()];r||(r=new xe(I)),r=r.insert(e,n),t.xo[t.currentUser.toKey()]=r}(r,i.batchId,n),[4,Rs(r,i.changes)];case 3:return s.sent(),[4,Mo(r.remoteStore)];case 4:return s.sent(),[3,6];case 5:return o=s.sent(),a=Wo(o,"Failed to persist write"),n.reject(a),[3,6];case 6:return[2]}}))}))}function _s(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:n=_(t),i.label=1;case 1:return i.trys.push([1,4,,6]),[4,Di(n.localStore,e)];case 2:return r=i.sent(),e.targetChanges.forEach((function(t,e){var r=n.Co.get(e);r&&(g(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.bo=!0:t.modifiedDocuments.size>0?g(r.bo):t.removedDocuments.size>0&&(g(r.bo),r.bo=!1))})),[4,Rs(n,r,e)];case 3:return i.sent(),[3,6];case 4:return[4,Xr(i.sent())];case 5:return i.sent(),[3,6];case 6:return[2]}}))}))}function ws(t,e,n){var r=_(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){var i=[];r.Po.forEach((function(t,n){var r=n.view.zr(e);r.snapshot&&i.push(r.snapshot)})),function(t,e){var n=_(t);n.onlineState=e;var r=!1;n.queries.forEach((function(t,n){for(var i=0,o=n.listeners;i<o.length;i++)o[i].zr(e)&&(r=!0)})),r&&rs(n)}(r.eventManager,e),i.length&&r.vo._r(i),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}function bs(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,a,u,c;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return(r=_(t)).sharedClientState.updateQueryState(e,"rejected",n),i=r.Co.get(e),(o=i&&i.key)?(a=(a=new xe(z.comparator)).insert(o,ct.newNoDocument(o,N.min())),u=je().add(o),c=new Qe(N.min(),new Map,new Le(I),a,u),[4,_s(r,c)]):[3,2];case 1:return s.sent(),r.Do=r.Do.remove(o),r.Co.delete(e),Cs(r),[3,4];case 2:return[4,Ci(r.localStore,e,!1).then((function(){return Ds(r,e,n)})).catch(Xr)];case 3:s.sent(),s.label=4;case 4:return[2]}}))}))}function Is(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:n=_(t),r=e.batch.batchId,o.label=1;case 1:return o.trys.push([1,4,,6]),[4,Si(n.localStore,e)];case 2:return i=o.sent(),Ns(n,r,null),Ss(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),[4,Rs(n,i)];case 3:return o.sent(),[3,6];case 4:return[4,Xr(o.sent())];case 5:return o.sent(),[3,6];case 6:return[2]}}))}))}function Es(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:r=_(t),o.label=1;case 1:return o.trys.push([1,4,,6]),[4,function(t,e){var n=_(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(function(t){var r;return n._n.lookupMutationBatch(t,e).next((function(e){return g(null!==e),r=e.keys(),n._n.removeMutationBatch(t,e)})).next((function(){return n._n.performConsistencyCheck(t)})).next((function(){return n.Mn.pn(t,r)}))}))}(r.localStore,e)];case 2:return i=o.sent(),Ns(r,e,n),Ss(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),[4,Rs(r,i)];case 3:return o.sent(),[3,6];case 4:return[4,Xr(o.sent())];case 5:return o.sent(),[3,6];case 6:return[2]}}))}))}function Ts(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o,a;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:ko((n=_(t)).remoteStore)||d("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,function(t){var e=_(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(function(t){return e._n.getHighestUnacknowledgedBatchId(t)}))}(n.localStore)];case 2:return-1===(r=s.sent())?[2,void e.resolve()]:((i=n.Fo.get(r)||[]).push(e),n.Fo.set(r,i),[3,4]);case 3:return o=s.sent(),a=Wo(o,"Initialization of waitForPendingWrites() operation failed"),e.reject(a),[3,4];case 4:return[2]}}))}))}function Ss(t,e){(t.Fo.get(e)||[]).forEach((function(t){t.resolve()})),t.Fo.delete(e)}function Ns(t,e,n){var r=_(t),i=r.xo[r.currentUser.toKey()];if(i){var o=i.get(e);o&&(n?o.reject(n):o.resolve(),i=i.remove(e)),r.xo[r.currentUser.toKey()]=i}}function Ds(t,e,n){void 0===n&&(n=null),t.sharedClientState.removeLocalQueryTarget(e);for(var r=0,i=t.Vo.get(e);r<i.length;r++){var o=i[r];t.Po.delete(o),n&&t.vo.Mo(o,n)}t.Vo.delete(e),t.isPrimaryClient&&t.No.Zn(e).forEach((function(e){t.No.containsKey(e)||As(t,e)}))}function As(t,e){t.So.delete(e.path.canonicalString());var n=t.Do.get(e);null!==n&&(To(t.remoteStore,n),t.Do=t.Do.remove(e),t.Co.delete(n),Cs(t))}function ks(t,e,n){for(var r=0,i=n;r<i.length;r++){var o=i[r];o instanceof cs?(t.No.addReference(o.key,e),xs(t,o)):o instanceof hs?(d("SyncEngine","Document no longer in limbo: "+o.key),t.No.removeReference(o.key,e),t.No.containsKey(o.key)||As(t,o.key)):m()}}function xs(t,e){var n=e.key,r=n.path.canonicalString();t.Do.get(n)||t.So.has(r)||(d("SyncEngine","New document in limbo: "+n),t.So.add(r),Cs(t))}function Cs(t){for(;t.So.size>0&&t.Do.size<t.maxConcurrentLimboResolutions;){var e=t.So.values().next().value;t.So.delete(e);var n=new z(C.fromString(e)),r=t.ko.next();t.Co.set(r,new ds(n)),t.Do=t.Do.insert(n,r),Eo(t.remoteStore,new gr(qt(Rt(n.path)),r,2,u.o))}}function Rs(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,a;return(0,s.__generator)(this,(function(u){switch(u.label){case 0:return r=_(t),i=[],o=[],a=[],r.Po.isEmpty()?[3,3]:(r.Po.forEach((function(t,s){a.push(r.Oo(s,e,n).then((function(t){if(t){r.isPrimaryClient&&r.sharedClientState.updateQueryState(s.targetId,t.fromCache?"not-current":"current"),i.push(t);var e=wi.Pn(s.targetId,t);o.push(e)}})))})),[4,Promise.all(a)]);case 1:return u.sent(),r.vo._r(i),[4,function(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o,a,u,c,h,f;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:n=_(t),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(function(t){return ir.forEach(e,(function(e){return ir.forEach(e.bn,(function(r){return n.persistence.referenceDelegate.addReference(t,e.targetId,r)})).next((function(){return ir.forEach(e.vn,(function(r){return n.persistence.referenceDelegate.removeReference(t,e.targetId,r)}))}))}))}))];case 2:return s.sent(),[3,4];case 3:if(!cr(r=s.sent()))throw r;return d("LocalStore","Failed to update sequence numbers: "+r),[3,4];case 4:for(i=0,o=e;i<o.length;i++)a=o[i],u=a.targetId,a.fromCache||(c=n.Fn.get(u),h=c.snapshotVersion,f=c.withLastLimboFreeSnapshotVersion(h),n.Fn=n.Fn.insert(u,f));return[2]}}))}))}(r.localStore,o)];case 2:u.sent(),u.label=3;case 3:return[2]}}))}))}function Ls(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return(n=_(t)).currentUser.isEqual(e)?[3,3]:(d("SyncEngine","User change. New user:",e.toKey()),[4,Ti(n.localStore,e)]);case 1:return r=i.sent(),n.currentUser=e,function(t,e){t.Fo.forEach((function(t){t.forEach((function(t){t.reject(new h(c.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.Fo.clear()}(n),n.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),[4,Rs(n,r.Ln)];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))}function Os(t,e){var n=_(t),r=n.Co.get(e);if(r&&r.bo)return je().add(r.key);var i=je(),o=n.Vo.get(e);if(!o)return i;for(var s=0,a=o;s<a.length;s++){var u=a[s],c=n.Po.get(u);i=i.unionWith(c.view.wo)}return i}function Ps(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return[4,Ri((n=_(t)).localStore,e.query,!0)];case 1:return r=o.sent(),i=e.view.Ao(r),[2,(n.isPrimaryClient&&ks(n,e.targetId,i.To),i)]}}))}))}function Ms(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){return[2,Oi((e=_(t)).localStore).then((function(t){return Rs(e,t)}))]}))}))}function Fs(t,e,n,r){return(0,s.__awaiter)(this,void 0,void 0,(function(){var i,o;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return[4,function(t,e){var n=_(t),r=_(n._n);return n.persistence.runTransaction("Lookup mutation documents","readonly",(function(t){return r.jt(t,e).next((function(e){return e?n.Mn.pn(t,e):ir.resolve(null)}))}))}((i=_(t)).localStore,e)];case 1:return null===(o=s.sent())?[3,6]:"pending"!==n?[3,3]:[4,Mo(i.remoteStore)];case 2:return s.sent(),[3,4];case 3:"acknowledged"===n||"rejected"===n?(Ns(i,e,r||null),Ss(i,e),function(t,e){_(_(t)._n).Gt(e)}(i.localStore,e)):m(),s.label=4;case 4:return[4,Rs(i,o)];case 5:return s.sent(),[3,7];case 6:d("SyncEngine","Cannot apply mutation batch with id: "+e),s.label=7;case 7:return[2]}}))}))}function Vs(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o,a,u,c,h;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return Gs(n=_(t)),Qs(n),!0!==e||!0===n.$o?[3,3]:(r=n.sharedClientState.getAllActiveQueryTargets(),[4,qs(n,r.toArray())]);case 1:return i=s.sent(),n.$o=!0,[4,Ko(n.remoteStore,!0)];case 2:for(s.sent(),o=0,a=i;o<a.length;o++)u=a[o],Eo(n.remoteStore,u);return[3,7];case 3:return!1!==e||!1===n.$o?[3,7]:(c=[],h=Promise.resolve(),n.Vo.forEach((function(t,e){n.sharedClientState.isLocalQueryTarget(e)?c.push(e):h=h.then((function(){return Ds(n,e),Ci(n.localStore,e,!0)})),To(n.remoteStore,e)})),[4,h]);case 4:return s.sent(),[4,qs(n,c)];case 5:return s.sent(),function(t){var e=_(t);e.Co.forEach((function(t,n){To(e.remoteStore,n)})),e.No.ts(),e.Co=new Map,e.Do=new xe(z.comparator)}(n),n.$o=!1,[4,Ko(n.remoteStore,!1)];case 6:s.sent(),s.label=7;case 7:return[2]}}))}))}function qs(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o,a,u,c,h,f,l,d,p,y,v;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:n=_(t),r=[],i=[],o=0,a=e,s.label=1;case 1:return o<a.length?(u=a[o],c=void 0,(h=n.Vo.get(u))&&0!==h.length?[4,xi(n.localStore,qt(h[0]))]:[3,7]):[3,13];case 2:c=s.sent(),f=0,l=h,s.label=3;case 3:return f<l.length?(d=l[f],p=n.Po.get(d),[4,Ps(n,p)]):[3,6];case 4:(y=s.sent()).snapshot&&i.push(y.snapshot),s.label=5;case 5:return f++,[3,3];case 6:return[3,11];case 7:return[4,Li(n.localStore,u)];case 8:return v=s.sent(),[4,xi(n.localStore,v)];case 9:return c=s.sent(),[4,vs(n,Us(v),u,!1)];case 10:s.sent(),s.label=11;case 11:r.push(c),s.label=12;case 12:return o++,[3,1];case 13:return[2,(n.vo._r(i),r)]}}))}))}function Us(t){return Ct(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Bs(t){var e=_(t);return _(_(e.localStore).persistence).fn()}function js(t,e,n,r){return(0,s.__awaiter)(this,void 0,void 0,(function(){var i,o,a;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return(i=_(t)).$o?(d("SyncEngine","Ignoring unexpected query state notification."),[3,8]):[3,1];case 1:if(!i.Vo.has(e))return[3,8];switch(n){case"current":case"not-current":return[3,2];case"rejected":return[3,5]}return[3,7];case 2:return[4,Oi(i.localStore)];case 3:return o=s.sent(),a=Qe.createSynthesizedRemoteEventForCurrentChange(e,"current"===n),[4,Rs(i,o,a)];case 4:return s.sent(),[3,8];case 5:return[4,Ci(i.localStore,e,!0)];case 6:return s.sent(),Ds(i,e,r),[3,8];case 7:m(),s.label=8;case 8:return[2]}}))}))}function Ks(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,a,u,c,h,f,l,p;return(0,s.__generator)(this,(function(y){switch(y.label){case 0:if(!(r=Gs(t)).$o)return[3,10];i=0,o=e,y.label=1;case 1:return i<o.length?(a=o[i],r.Vo.has(a)?(d("SyncEngine","Adding an already active target "+a),[3,5]):[4,Li(r.localStore,a)]):[3,6];case 2:return u=y.sent(),[4,xi(r.localStore,u)];case 3:return c=y.sent(),[4,vs(r,Us(u),c.targetId,!1)];case 4:y.sent(),Eo(r.remoteStore,c),y.label=5;case 5:return i++,[3,1];case 6:h=function(t){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return r.Vo.has(t)?[4,Ci(r.localStore,t,!1).then((function(){To(r.remoteStore,t),Ds(r,t)})).catch(Xr)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))},f=0,l=n,y.label=7;case 7:return f<l.length?(p=l[f],[5,h(p)]):[3,10];case 8:y.sent(),y.label=9;case 9:return f++,[3,7];case 10:return[2]}}))}))}function Gs(t){var e=_(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=_s.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Os.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=bs.bind(null,e),e.vo._r=es.bind(null,e.eventManager),e.vo.Mo=ns.bind(null,e.eventManager),e}function Qs(t){var e=_(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Is.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Es.bind(null,e),e}function zs(t,e,n){var r=_(t);(function(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,a,u,c;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return s.trys.push([0,14,,15]),[4,e.getMetadata()];case 1:return r=s.sent(),[4,function(t,e){var n=_(t),r=an(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(function(t){return n.Qe.getBundleMetadata(t,e.id)})).then((function(t){return!!t&&t.createTime.compareTo(r)>=0}))}(t.localStore,r)];case 2:return s.sent()?[4,e.close()]:[3,4];case 3:return[2,(s.sent(),void n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r)))];case 4:return n._updateProgress(us(r)),i=new as(r,t.localStore,e.R),[4,e.Lo()];case 5:o=s.sent(),s.label=6;case 6:return o?[4,i.oo(o)]:[3,10];case 7:return(a=s.sent())&&n._updateProgress(a),[4,e.Lo()];case 8:o=s.sent(),s.label=9;case 9:return[3,6];case 10:return[4,i.complete()];case 11:return u=s.sent(),[4,Rs(t,u.wn,void 0)];case 12:return s.sent(),[4,function(t,e){var n=_(t);return n.persistence.runTransaction("Save bundle","readwrite",(function(t){return n.Qe.saveBundleMetadata(t,e)}))}(t.localStore,r)];case 13:return s.sent(),n._completeWith(u.progress),[3,15];case 14:return y("SyncEngine","Loading bundle failed with "+(c=s.sent())),n._failWith(c),[3,15];case 15:return[2]}}))}))})(r,e,n).then((function(){r.sharedClientState.notifyBundleLoaded()}))}var Ws=function(){function t(){this.synchronizeTabs=!1}return t.prototype.initialize=function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return this.R=lo(t.databaseInfo.databaseId),this.sharedClientState=this.Bo(t),this.persistence=this.qo(t),[4,this.persistence.start()];case 1:return e.sent(),this.gcScheduler=this.Uo(t),this.localStore=this.Qo(t),[2]}}))}))},t.prototype.Uo=function(t){return null},t.prototype.Qo=function(t){return Ei(this.persistence,new bi,t.initialUser,this.R)},t.prototype.qo=function(t){return new Qi(Wi.bs,this.R)},t.prototype.Bo=function(t){return new io},t.prototype.terminate=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return this.gcScheduler&&this.gcScheduler.stop(),[4,this.sharedClientState.shutdown()];case 1:return t.sent(),[4,this.persistence.shutdown()];case 2:return t.sent(),[2]}}))}))},t}(),Hs=function(t){function e(e,n,r){var i=this;return(i=t.call(this)||this).Ko=e,i.cacheSizeBytes=n,i.forceOwnership=r,i.synchronizeTabs=!1,i}return(0,s.__extends)(e,t),e.prototype.initialize=function(e){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.prototype.initialize.call(this,e)];case 1:return n.sent(),[4,Pi(this.localStore)];case 2:return n.sent(),[4,this.Ko.initialize(this,e)];case 3:return n.sent(),[4,Qs(this.Ko.syncEngine)];case 4:return n.sent(),[4,Mo(this.Ko.remoteStore)];case 5:return n.sent(),[2]}}))}))},e.prototype.Qo=function(t){return Ei(this.persistence,new bi,t.initialUser,this.R)},e.prototype.Uo=function(t){var e=this.persistence.referenceDelegate.garbageCollector;return new ti(e,t.asyncQueue)},e.prototype.qo=function(t){var e=mi(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Vr.withCacheSize(this.cacheSizeBytes):Vr.DEFAULT;return new pi(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,ho(),fo(),this.R,this.sharedClientState,!!this.forceOwnership)},e.prototype.Bo=function(t){return new io},e}(Ws),Ys=function(t){function e(e,n){var r=this;return(r=t.call(this,e,n,!1)||this).Ko=e,r.cacheSizeBytes=n,r.synchronizeTabs=!0,r}return(0,s.__extends)(e,t),e.prototype.initialize=function(e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r=this;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,t.prototype.initialize.call(this,e)];case 1:return i.sent(),n=this.Ko.syncEngine,this.sharedClientState instanceof ro?(this.sharedClientState.syncEngine={ui:Fs.bind(null,n),ai:js.bind(null,n),hi:Ks.bind(null,n),fn:Bs.bind(null,n),ci:Ms.bind(null,n)},[4,this.sharedClientState.start()]):[3,3];case 2:i.sent(),i.label=3;case 3:return[4,this.persistence.He((function(t){return(0,s.__awaiter)(r,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return[4,Vs(this.Ko.syncEngine,t)];case 1:return e.sent(),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop()),[2]}}))}))}))];case 4:return i.sent(),[2]}}))}))},e.prototype.Bo=function(t){var e=ho();if(!ro.yt(e))throw new h(c.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=mi(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new ro(e,t.asyncQueue,n,t.clientId,t.initialUser)},e}(Hs),$s=function(){function t(){}return t.prototype.initialize=function(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n=this;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return this.localStore?[3,2]:(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=function(t){return ws(n.syncEngine,t,1)},this.remoteStore.remoteSyncer.handleCredentialChange=Ls.bind(null,this.syncEngine),[4,Ko(this.remoteStore,this.syncEngine.isPrimaryClient)]);case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},t.prototype.createEventManager=function(t){return new Jo},t.prototype.createDatastore=function(t){var e,n=lo(t.databaseInfo.databaseId),r=(e=t.databaseInfo,new co(e));return function(t,e,n){return new go(t,e,n)}(t.credentials,r,n)},t.prototype.createRemoteStore=function(t){var e,n,r,i,o,s=this;return e=this.localStore,n=this.datastore,r=t.asyncQueue,i=function(t){return ws(s.syncEngine,t,0)},o=so.yt()?new so:new oo,new wo(e,n,r,i,o)},t.prototype.createSyncEngine=function(t,e){return function(t,e,n,r,i,o,s){var a=new ps(t,e,n,r,i,o);return s&&(a.$o=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)},t.prototype.terminate=function(){return function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return e=_(t),d("RemoteStore","RemoteStore shutting down."),e.Or.add(5),[4,Io(e)];case 1:return n.sent(),e.Lr.shutdown(),e.Br.set("Unknown"),[2]}}))}))}(this.remoteStore)},t}();function Xs(t,e){void 0===e&&(e=10240);var n=0;return{read:function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r;return(0,s.__generator)(this,(function(i){return n<t.byteLength?(r={value:t.slice(n,n+e),done:!1},[2,(n+=e,r)]):[2,{done:!0}]}))}))},cancel:function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){return[2]}))}))},releaseLock:function(){},closed:Promise.reject("unimplemented")}}var Js=function(){function t(t){this.observer=t,this.muted=!1}return t.prototype.next=function(t){this.observer.next&&this.jo(this.observer.next,t)},t.prototype.error=function(t){this.observer.error?this.jo(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)},t.prototype.Wo=function(){this.muted=!0},t.prototype.jo=function(t,e){var n=this;this.muted||setTimeout((function(){n.muted||t(e)}),0)},t}(),Zs=function(){function t(t,e){var n=this;this.Go=t,this.R=e,this.metadata=new rr,this.buffer=new Uint8Array,this.zo=new TextDecoder("utf-8"),this.Ho().then((function(t){t&&t.io()?n.metadata.resolve(t.payload.metadata):n.metadata.reject(new Error("The first element of the bundle is not a metadata, it is\n             "+JSON.stringify(null==t?void 0:t.payload)))}),(function(t){return n.metadata.reject(t)}))}return t.prototype.close=function(){return this.Go.cancel()},t.prototype.getMetadata=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){return[2,this.metadata.promise]}))}))},t.prototype.Lo=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.getMetadata()];case 1:return[2,(t.sent(),this.Ho())]}}))}))},t.prototype.Ho=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t,e,n,r;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,this.Jo()];case 1:return null===(t=i.sent())?[2,null]:(e=this.zo.decode(t),n=Number(e),isNaN(n)&&this.Yo("length string ("+e+") is not valid number"),[4,this.Xo(n)]);case 2:return r=i.sent(),[2,new os(JSON.parse(r),t.length+n)]}}))}))},t.prototype.Zo=function(){return this.buffer.findIndex((function(t){return t==="{".charCodeAt(0)}))},t.prototype.Jo=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t,e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return this.Zo()<0?[4,this.tc()]:[3,3];case 1:if(n.sent())return[3,3];n.label=2;case 2:return[3,0];case 3:return 0===this.buffer.length?[2,null]:((t=this.Zo())<0&&this.Yo("Reached the end of bundle when a length string is expected."),e=this.buffer.slice(0,t),[2,(this.buffer=this.buffer.slice(t),e)])}}))}))},t.prototype.Xo=function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return this.buffer.length<t?[4,this.tc()]:[3,3];case 1:n.sent()&&this.Yo("Reached the end of bundle when more is expected."),n.label=2;case 2:return[3,0];case 3:return e=this.zo.decode(this.buffer.slice(0,t)),[2,(this.buffer=this.buffer.slice(t),e)]}}))}))},t.prototype.Yo=function(t){throw this.Go.cancel(),new Error("Invalid bundle format: "+t)},t.prototype.tc=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t,e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return[4,this.Go.read()];case 1:return(t=n.sent()).done||((e=new Uint8Array(this.buffer.length+t.value.length)).set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e),[2,t.done]}}))}))},t}(),ta=function(){function t(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}return t.prototype.lookup=function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e,n=this;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new h(c.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,function(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o,a,u;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return n=_(t),r=pn(n.R)+"/documents",i={documents:e.map((function(t){return hn(n.R,t)}))},[4,n.$i("BatchGetDocuments",r,i)];case 1:return o=s.sent(),a=new Map,o.forEach((function(t){var e=function(t,e){return"found"in e?function(t,e){g(!!e.found),e.found.name,e.found.updateTime;var n=fn(t,e.found.name),r=an(e.found.updateTime),i=new at({mapValue:{fields:e.found.fields}});return ct.newFoundDocument(n,r,i)}(t,e):"missing"in e?function(t,e){g(!!e.missing),g(!!e.readTime);var n=fn(t,e.missing),r=an(e.readTime);return ct.newNoDocument(n,r)}(t,e):m()}(n.R,t);a.set(e.key.toString(),e)})),u=[],[2,(e.forEach((function(t){var e=a.get(t.toString());g(!!e),u.push(e)})),u)]}}))}))}(this.datastore,t)];case 1:return[2,((e=r.sent()).forEach((function(t){return n.recordVersion(t)})),e)]}}))}))},t.prototype.set=function(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())},t.prototype.update=function(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())},t.prototype.delete=function(t){this.write(new Se(t,this.precondition(t))),this.writtenDocs.add(t.toString())},t.prototype.commit=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t,e=this;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;return t=this.readVersions,this.mutations.forEach((function(e){t.delete(e.key.toString())})),t.forEach((function(t,n){var r=z.fromPath(n);e.mutations.push(new Ne(r,e.precondition(r)))})),[4,function(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return n=_(t),r=pn(n.R)+"/documents",i={writes:e.map((function(t){return gn(n.R,t)}))},[4,n.Ni("Commit",r,i)];case 1:return o.sent(),[2]}}))}))}(this.datastore,this.mutations)];case 1:return n.sent(),this.committed=!0,[2]}}))}))},t.prototype.recordVersion=function(t){var e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw m();e=N.min()}var n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new h(c.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)},t.prototype.precondition=function(t){var e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?he.updateTime(e):he.none()},t.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(N.min()))throw new h(c.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return he.updateTime(e)}return he.exists(!0)},t.prototype.write=function(t){this.ensureCommitNotCalled(),this.mutations.push(t)},t.prototype.ensureCommitNotCalled=function(){},t}(),ea=function(){function t(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.ec=5,this.Zi=new po(this.asyncQueue,"transaction_retry")}return t.prototype.run=function(){this.nc()},t.prototype.nc=function(){var t=this;this.Zi.ji((function(){return(0,s.__awaiter)(t,void 0,void 0,(function(){var t,e,n=this;return(0,s.__generator)(this,(function(r){return t=new ta(this.datastore),(e=this.sc(t))&&e.then((function(e){n.asyncQueue.enqueueAndForget((function(){return t.commit().then((function(){n.deferred.resolve(e)})).catch((function(t){n.ic(t)}))}))})).catch((function(t){n.ic(t)})),[2]}))}))}))},t.prototype.sc=function(t){try{var e=this.updateFunction(t);return!K(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}},t.prototype.ic=function(t){var e=this;this.ec>0&&this.rc(t)?(this.ec-=1,this.asyncQueue.enqueueAndForget((function(){return e.nc(),Promise.resolve()}))):this.deferred.reject(t)},t.prototype.rc=function(t){if("FirebaseError"===t.name){var e=t.code;return"aborted"===e||"failed-precondition"===e||!Ae(e)}return!1},t}(),na=function(){function t(t,e,n){var r=this;this.credentials=t,this.asyncQueue=e,this.databaseInfo=n,this.user=Hi.UNAUTHENTICATED,this.clientId=b.u(),this.credentialListener=function(){return Promise.resolve()},this.credentials.setChangeListener(e,(function(t){return(0,s.__awaiter)(r,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return d("FirestoreClient","Received user=",t.uid),[4,this.credentialListener(t)];case 1:return e.sent(),this.user=t,[2]}}))}))}))}return t.prototype.getConfiguration=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){return[2,{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}]}))}))},t.prototype.setCredentialChangeListener=function(t){this.credentialListener=t},t.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new h(c.FAILED_PRECONDITION,"The client has already been terminated.")},t.prototype.terminate=function(){var t=this;this.asyncQueue.enterRestrictedMode();var e=new rr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((function(){return(0,s.__awaiter)(t,void 0,void 0,(function(){var t,n;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return r.trys.push([0,5,,6]),this.onlineComponents?[4,this.onlineComponents.terminate()]:[3,2];case 1:r.sent(),r.label=2;case 2:return this.offlineComponents?[4,this.offlineComponents.terminate()]:[3,4];case 3:r.sent(),r.label=4;case 4:return this.credentials.removeChangeListener(),e.resolve(),[3,6];case 5:return t=r.sent(),n=Wo(t,"Failed to shutdown persistence"),e.reject(n),[3,6];case 6:return[2]}}))}))})),e.promise},t}();function ra(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r,i=this;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return t.asyncQueue.verifyOperationInProgress(),d("FirestoreClient","Initializing OfflineComponentProvider"),[4,t.getConfiguration()];case 1:return n=o.sent(),[4,e.initialize(n)];case 2:return o.sent(),r=n.initialUser,t.setCredentialChangeListener((function(t){return(0,s.__awaiter)(i,void 0,void 0,(function(){return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return r.isEqual(t)?[3,2]:[4,Ti(e.localStore,t)];case 1:n.sent(),r=t,n.label=2;case 2:return[2]}}))}))})),e.persistence.setDatabaseDeletedListener((function(){return t.terminate()})),t.offlineComponents=e,[2]}}))}))}function ia(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return t.asyncQueue.verifyOperationInProgress(),[4,oa(t)];case 1:return n=i.sent(),d("FirestoreClient","Initializing OnlineComponentProvider"),[4,t.getConfiguration()];case 2:return r=i.sent(),[4,e.initialize(n,r)];case 3:return i.sent(),t.setCredentialChangeListener((function(t){return function(t,e){return(0,s.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return(n=_(t)).asyncQueue.verifyOperationInProgress(),d("RemoteStore","RemoteStore received new credentials"),r=ko(n),n.Or.add(3),[4,Io(n)];case 1:return i.sent(),r&&n.Br.set("Unknown"),[4,n.remoteSyncer.handleCredentialChange(e)];case 2:return i.sent(),n.Or.delete(3),[4,bo(n)];case 3:return i.sent(),[2]}}))}))}(e.remoteStore,t)})),t.onlineComponents=e,[2]}}))}))}function oa(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return t.offlineComponents?[3,2]:(d("FirestoreClient","Using default OfflineComponentProvider"),[4,ra(t,new Ws)]);case 1:e.sent(),e.label=2;case 2:return[2,t.offlineComponents]}}))}))}function sa(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return t.onlineComponents?[3,2]:(d("FirestoreClient","Using default OnlineComponentProvider"),[4,ia(t,new $s)]);case 1:e.sent(),e.label=2;case 2:return[2,t.onlineComponents]}}))}))}function aa(t){return oa(t).then((function(t){return t.persistence}))}function ua(t){return oa(t).then((function(t){return t.localStore}))}function ca(t){return sa(t).then((function(t){return t.remoteStore}))}function ha(t){return sa(t).then((function(t){return t.syncEngine}))}function fa(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e,n;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return[4,sa(t)];case 1:return e=r.sent(),[2,((n=e.eventManager).onListen=ys.bind(null,e.syncEngine),n.onUnlisten=ms.bind(null,e.syncEngine),n)]}}))}))}function la(t,e,n){var r=this;void 0===n&&(n={});var i=new rr;return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(r,void 0,void 0,(function(){var r;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return r=function(t,e,n,r,i){var o=new Js({next:function(o){e.enqueueAndForget((function(){return ts(t,s)}));var a=o.docs.has(n);!a&&o.fromCache?i.reject(new h(c.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&o.fromCache&&r&&"server"===r.source?i.reject(new h(c.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(o)},error:function(t){return i.reject(t)}}),s=new is(Rt(n.path),o,{includeMetadataChanges:!0,so:!0});return Zo(t,s)},[4,fa(t)];case 1:return[2,r.apply(void 0,[o.sent(),t.asyncQueue,e,n,i])]}}))}))})),i.promise}function da(t,e,n){var r=this;void 0===n&&(n={});var i=new rr;return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(r,void 0,void 0,(function(){var r;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return r=function(t,e,n,r,i){var o=new Js({next:function(n){e.enqueueAndForget((function(){return ts(t,s)})),n.fromCache&&"server"===r.source?i.reject(new h(c.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:function(t){return i.reject(t)}}),s=new is(n,o,{includeMetadataChanges:!0,so:!0});return Zo(t,s)},[4,fa(t)];case 1:return[2,r.apply(void 0,[o.sent(),t.asyncQueue,e,n,i])]}}))}))})),i.promise}var pa=function(t,e,n,r,i,o,s,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=o,this.autoDetectLongPolling=s,this.useFetchStreams=a},ya=function(){function t(t,e){this.projectId=t,this.database=e||"(default)"}return Object.defineProperty(t.prototype,"isDefaultDatabase",{get:function(){return"(default)"===this.database},enumerable:!1,configurable:!0}),t.prototype.isEqual=function(e){return e instanceof t&&e.projectId===this.projectId&&e.database===this.database},t}(),va=new Map,ma=function(t,e){this.user=e,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization="Bearer "+t},ga=function(){function t(){this.changeListener=null}return t.prototype.getToken=function(){return Promise.resolve(null)},t.prototype.invalidateToken=function(){},t.prototype.setChangeListener=function(t,e){this.changeListener=e,t.enqueueRetryable((function(){return e(Hi.UNAUTHENTICATED)}))},t.prototype.removeChangeListener=function(){this.changeListener=null},t}(),_a=function(){function t(t){this.token=t,this.changeListener=null}return t.prototype.getToken=function(){return Promise.resolve(this.token)},t.prototype.invalidateToken=function(){},t.prototype.setChangeListener=function(t,e){var n=this;this.changeListener=e,t.enqueueRetryable((function(){return e(n.token.user)}))},t.prototype.removeChangeListener=function(){this.changeListener=null},t}(),wa=function(){function t(t){var e=this;this.currentUser=Hi.UNAUTHENTICATED,this.oc=new rr,this.cc=0,this.forceRefresh=!1,this.auth=null,this.asyncQueue=null,this.uc=function(){e.cc++,e.currentUser=e.ac(),e.oc.resolve(),e.changeListener&&e.asyncQueue.enqueueRetryable((function(){return e.changeListener(e.currentUser)}))};var n=function(t){d("FirebaseCredentialsProvider","Auth detected"),e.auth=t,e.auth.addAuthTokenListener(e.uc)};t.onInit((function(t){return n(t)})),setTimeout((function(){if(!e.auth){var r=t.getImmediate({optional:!0});r?n(r):(d("FirebaseCredentialsProvider","Auth not yet detected"),e.oc.resolve())}}),0)}return t.prototype.getToken=function(){var t=this,e=this.cc,n=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(n).then((function(n){return t.cc!==e?(d("FirebaseCredentialsProvider","getToken aborted due to token change."),t.getToken()):n?(g("string"==typeof n.accessToken),new ma(n.accessToken,t.currentUser)):null})):Promise.resolve(null)},t.prototype.invalidateToken=function(){this.forceRefresh=!0},t.prototype.setChangeListener=function(t,e){var n=this;this.asyncQueue=t,this.asyncQueue.enqueueRetryable((function(){return(0,s.__awaiter)(n,void 0,void 0,(function(){return(0,s.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.oc.promise];case 1:return t.sent(),[4,e(this.currentUser)];case 2:return t.sent(),this.changeListener=e,[2]}}))}))}))},t.prototype.removeChangeListener=function(){this.auth&&this.auth.removeAuthTokenListener(this.uc),this.changeListener=function(){return Promise.resolve()}},t.prototype.ac=function(){var t=this.auth&&this.auth.getUid();return g(null===t||"string"==typeof t),new Hi(t)},t}(),ba=function(){function t(t,e,n){this.hc=t,this.lc=e,this.fc=n,this.type="FirstParty",this.user=Hi.FIRST_PARTY}return Object.defineProperty(t.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.lc},e=this.hc.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),this.fc&&(t["X-Goog-Iam-Authorization-Token"]=this.fc),t},enumerable:!1,configurable:!0}),t}(),Ia=function(){function t(t,e,n){this.hc=t,this.lc=e,this.fc=n}return t.prototype.getToken=function(){return Promise.resolve(new ba(this.hc,this.lc,this.fc))},t.prototype.setChangeListener=function(t,e){t.enqueueRetryable((function(){return e(Hi.FIRST_PARTY)}))},t.prototype.removeChangeListener=function(){},t.prototype.invalidateToken=function(){},t}();function Ea(t,e,n){if(!n)throw new h(c.INVALID_ARGUMENT,"Function "+t+"() cannot be called with an empty "+e+".")}function Ta(t,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new h(c.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function Sa(t,e,n,r){if(!0===e&&!0===r)throw new h(c.INVALID_ARGUMENT,t+" and "+n+" cannot be used together.")}function Na(t){if(!z.isDocumentKey(t))throw new h(c.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+t+" has "+t.length+".")}function Da(t){if(z.isDocumentKey(t))throw new h(c.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t+" has "+t.length+".")}function Aa(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";var e=function(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&e.length>1)return e[1]}return null}(t);return e?"a custom "+e+" object":"an object"}return"function"==typeof t?"a function":m()}function ka(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new h(c.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Aa(t);throw new h(c.INVALID_ARGUMENT,"Expected type '"+e.name+"', but it was: "+n)}return t}function xa(t,e){if(e<=0)throw new h(c.INVALID_ARGUMENT,"Function "+t+"() requires a positive number, but it was: "+e+".")}var Ca=function(){function t(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new h(c.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new h(c.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Sa("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}return t.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams},t}(),Ra=function(){function t(t,e){this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Ca({}),this._settingsFrozen=!1,t instanceof ya?(this._databaseId=t,this._credentials=new ga):(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new h(c.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ya(t.options.projectId)}(t),this._credentials=new wa(e))}return Object.defineProperty(t.prototype,"app",{get:function(){if(!this._app)throw new h(c.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_initialized",{get:function(){return this._settingsFrozen},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_terminated",{get:function(){return void 0!==this._terminateTask},enumerable:!1,configurable:!0}),t.prototype._setSettings=function(t){if(this._settingsFrozen)throw new h(c.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Ca(t),void 0!==t.credentials&&(this._credentials=function(t){if(!t)return new ga;switch(t.type){case"gapi":var e=t.client;return g(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Ia(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new h(c.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(t.credentials))},t.prototype._getSettings=function(){return this._settings},t.prototype._freezeSettings=function(){return this._settingsFrozen=!0,this._settings},t.prototype._delete=function(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask},t.prototype.toJSON=function(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}},t.prototype._terminate=function(){return this,(t=va.get(this))&&(d("ComponentProvider","Removing Datastore"),va.delete(this),t.terminate()),Promise.resolve();var t},t}(),La=function(){function t(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}return Object.defineProperty(t.prototype,"_path",{get:function(){return this._key.path},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new Pa(this.firestore,this.converter,this._key.path.popLast())},enumerable:!1,configurable:!0}),t.prototype.withConverter=function(e){return new t(this.firestore,e,this._key)},t}(),Oa=function(){function t(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}return t.prototype.withConverter=function(e){return new t(this.firestore,e,this._query)},t}(),Pa=function(t){function e(e,n,r){var i=this;return(i=t.call(this,e,n,Rt(r))||this)._path=r,i.type="collection",i}return(0,s.__extends)(e,t),Object.defineProperty(e.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){var t=this._path.popLast();return t.isEmpty()?null:new La(this.firestore,null,new z(t))},enumerable:!1,configurable:!0}),e.prototype.withConverter=function(t){return new e(this.firestore,t,this._path)},e}(Oa);function Ma(t,e){for(var n,i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];if(t=(0,r.getModularInstance)(t),Ea("collection","path",e),t instanceof Ra)return Da(n=C.fromString.apply(C,(0,s.__spreadArray)([e],i))),new Pa(t,null,n);if(!(t instanceof La||t instanceof Pa))throw new h(c.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return Da(n=C.fromString.apply(C,(0,s.__spreadArray)([t.path],i)).child(C.fromString(e))),new Pa(t.firestore,null,n)}function Fa(t,e){for(var n,i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];if(t=(0,r.getModularInstance)(t),1===arguments.length&&(e=b.u()),Ea("doc","path",e),t instanceof Ra)return Na(n=C.fromString.apply(C,(0,s.__spreadArray)([e],i))),new La(t,null,new z(n));if(!(t instanceof La||t instanceof Pa))throw new h(c.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return Na(n=t._path.child(C.fromString.apply(C,(0,s.__spreadArray)([e],i)))),new La(t.firestore,t instanceof Pa?t.converter:null,new z(n))}function Va(t,e){return t=(0,r.getModularInstance)(t),e=(0,r.getModularInstance)(e),(t instanceof La||t instanceof Pa)&&(e instanceof La||e instanceof Pa)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function qa(t,e){return t=(0,r.getModularInstance)(t),e=(0,r.getModularInstance)(e),t instanceof Oa&&e instanceof Oa&&t.firestore===e.firestore&&Bt(t._query,e._query)&&t.converter===e.converter}var Ua=function(){function t(){var t=this;this.dc=Promise.resolve(),this.wc=[],this._c=!1,this.mc=[],this.yc=null,this.gc=!1,this.Ec=[],this.Zi=new po(this,"async_queue_retry"),this.Tc=function(){var e=fo();e&&d("AsyncQueue","Visibility state changed to "+e.visibilityState),t.Zi.Gi()};var e=fo();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Tc)}return Object.defineProperty(t.prototype,"isShuttingDown",{get:function(){return this._c},enumerable:!1,configurable:!0}),t.prototype.enqueueAndForget=function(t){this.enqueue(t)},t.prototype.enqueueAndForgetEvenWhileRestricted=function(t){this.Ic(),this.Ac(t)},t.prototype.enterRestrictedMode=function(){if(!this._c){this._c=!0;var t=fo();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Tc)}},t.prototype.enqueue=function(t){return this.Ic(),this._c?new Promise((function(t){})):this.Ac(t)},t.prototype.enqueueRetryable=function(t){var e=this;this.enqueueAndForget((function(){return e.wc.push(t),e.Rc()}))},t.prototype.Rc=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t,e=this;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:if(0===this.wc.length)return[3,5];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.wc[0]()];case 2:return n.sent(),this.wc.shift(),this.Zi.reset(),[3,4];case 3:if(!cr(t=n.sent()))throw t;return d("AsyncQueue","Operation failed with retryable error: "+t),[3,4];case 4:this.wc.length>0&&this.Zi.ji((function(){return e.Rc()})),n.label=5;case 5:return[2]}}))}))},t.prototype.Ac=function(t){var e=this,n=this.dc.then((function(){return e.gc=!0,t().catch((function(t){throw e.yc=t,e.gc=!1,p("INTERNAL UNHANDLED ERROR: ",function(t){var e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t})).then((function(t){return e.gc=!1,t}))}));return this.dc=n,n},t.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.Ic(),this.Ec.indexOf(t)>-1&&(e=0);var i=zo.createAndSchedule(this,t,e,n,(function(t){return r.bc(t)}));return this.mc.push(i),i},t.prototype.Ic=function(){this.yc&&m()},t.prototype.verifyOperationInProgress=function(){},t.prototype.vc=function(){return(0,s.__awaiter)(this,void 0,void 0,(function(){var t;return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return[4,t=this.dc];case 1:e.sent(),e.label=2;case 2:if(t!==this.dc)return[3,0];e.label=3;case 3:return[2]}}))}))},t.prototype.Pc=function(t){for(var e=0,n=this.mc;e<n.length;e++)if(n[e].timerId===t)return!0;return!1},t.prototype.Vc=function(t){var e=this;return this.vc().then((function(){e.mc.sort((function(t,e){return t.targetTimeMs-e.targetTimeMs}));for(var n=0,r=e.mc;n<r.length;n++){var i=r[n];if(i.skipDelay(),"all"!==t&&i.timerId===t)break}return e.vc()}))},t.prototype.Sc=function(t){this.Ec.push(t)},t.prototype.bc=function(t){var e=this.mc.indexOf(t);this.mc.splice(e,1)},t}();function Ba(t){return function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=["next","error","complete"];r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(t)}var ja=function(){function t(){this._progressObserver={},this._taskCompletionResolver=new rr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}return t.prototype.onProgress=function(t,e,n){this._progressObserver={next:t,error:e,complete:n}},t.prototype.catch=function(t){return this._taskCompletionResolver.promise.catch(t)},t.prototype.then=function(t,e){return this._taskCompletionResolver.promise.then(t,e)},t.prototype._completeWith=function(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)},t.prototype._failWith=function(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)},t.prototype._updateProgress=function(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)},t}(),Ka=-1,Ga=function(t){function e(e,n){var r=this;return(r=t.call(this,e,n)||this).type="firestore",r._queue=new Ua,r._persistenceKey="name"in e?e.name:"[DEFAULT]",r}return(0,s.__extends)(e,t),e.prototype._terminate=function(){return this._firestoreClient||za(this),this._firestoreClient.terminate()},e}(Ra);function Qa(t){return t._firestoreClient||za(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function za(t){var e,n=t._freezeSettings(),r=function(t,e,n,r){return new pa(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new na(t._credentials,t._queue,r)}function Wa(t,e,n){var r=this,i=new rr;return t.asyncQueue.enqueue((function(){return(0,s.__awaiter)(r,void 0,void 0,(function(){var r;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return o.trys.push([0,3,,4]),[4,ra(t,n)];case 1:return o.sent(),[4,ia(t,e)];case 2:return o.sent(),i.resolve(),[3,4];case 3:if(!function(t){return"FirebaseError"===t.name?t.code===c.FAILED_PRECONDITION||t.code===c.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}(r=o.sent()))throw r;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+r),i.reject(r),[3,4];case 4:return[2]}}))}))})).then((function(){return i.promise}))}function Ha(t){if(t._initialized||t._terminated)throw new h(c.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var Ya=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0;n<t.length;++n)if(0===t[n].length)throw new h(c.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new L(t)}return t.prototype.isEqual=function(t){return this._internalPath.isEqual(t._internalPath)},t}(),$a=function(){function t(t){this._byteString=t}return t.fromBase64String=function(e){try{return new t(P.fromBase64String(e))}catch(e){throw new h(c.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}},t.fromUint8Array=function(e){return new t(P.fromUint8Array(e))},t.prototype.toBase64=function(){return this._byteString.toBase64()},t.prototype.toUint8Array=function(){return this._byteString.toUint8Array()},t.prototype.toString=function(){return"Bytes(base64: "+this.toBase64()+")"},t.prototype.isEqual=function(t){return this._byteString.isEqual(t._byteString)},t}(),Xa=function(t){this._methodName=t},Ja=function(){function t(t,e){if(!isFinite(t)||t<-90||t>90)throw new h(c.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new h(c.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}return Object.defineProperty(t.prototype,"latitude",{get:function(){return this._lat},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"longitude",{get:function(){return this._long},enumerable:!1,configurable:!0}),t.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},t.prototype.toJSON=function(){return{latitude:this._lat,longitude:this._long}},t.prototype._compareTo=function(t){return I(this._lat,t._lat)||I(this._long,t._long)},t}(),Za=/^__.*__$/,tu=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutation=function(t,e){return null!==this.fieldMask?new _e(t,this.data,this.fieldMask,e,this.fieldTransforms):new ge(t,this.data,e,this.fieldTransforms)},t}(),eu=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutation=function(t,e){return new _e(t,this.data,this.fieldMask,e,this.fieldTransforms)},t}();function nu(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw m()}}var ru=function(){function t(t,e,n,r,i,o){this.settings=t,this.databaseId=e,this.R=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Dc(),this.fieldTransforms=i||[],this.fieldMask=o||[]}return Object.defineProperty(t.prototype,"path",{get:function(){return this.settings.path},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Cc",{get:function(){return this.settings.Cc},enumerable:!1,configurable:!0}),t.prototype.Nc=function(e){return new t(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.R,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)},t.prototype.xc=function(t){var e,n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Nc({path:n,Fc:!1});return r.kc(t),r},t.prototype.$c=function(t){var e,n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Nc({path:n,Fc:!1});return r.Dc(),r},t.prototype.Oc=function(t){return this.Nc({path:void 0,Fc:!0})},t.prototype.Mc=function(t){return Eu(t,this.settings.methodName,this.settings.Lc||!1,this.path,this.settings.Bc)},t.prototype.contains=function(t){return void 0!==this.fieldMask.find((function(e){return t.isPrefixOf(e)}))||void 0!==this.fieldTransforms.find((function(e){return t.isPrefixOf(e.field)}))},t.prototype.Dc=function(){if(this.path)for(var t=0;t<this.path.length;t++)this.kc(this.path.get(t))},t.prototype.kc=function(t){if(0===t.length)throw this.Mc("Document fields must not be empty");if(nu(this.Cc)&&Za.test(t))throw this.Mc('Document fields cannot begin and end with "__"')},t}(),iu=function(){function t(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.R=n||lo(t)}return t.prototype.qc=function(t,e,n,r){return void 0===r&&(r=!1),new ru({Cc:t,methodName:e,Bc:n,path:L.emptyPath(),Fc:!1,Lc:r},this.databaseId,this.R,this.ignoreUndefinedProperties)},t}();function ou(t){var e=t._freezeSettings(),n=lo(t._databaseId);return new iu(t._databaseId,!!e.ignoreUndefinedProperties,n)}function su(t,e,n,r,i,o){void 0===o&&(o={});var s=t.qc(o.merge||o.mergeFields?2:0,e,n,i);_u("Data must be an object, but it was:",s,r);var a,u,f=mu(r,s);if(o.merge)a=new O(s.fieldMask),u=s.fieldTransforms;else if(o.mergeFields){for(var l=[],d=0,p=o.mergeFields;d<p.length;d++){var y=wu(e,p[d],n);if(!s.contains(y))throw new h(c.INVALID_ARGUMENT,"Field '"+y+"' is specified in your field mask but missing from your input data.");Tu(l,y)||l.push(y)}a=new O(l),u=s.fieldTransforms.filter((function(t){return a.covers(t.field)}))}else a=null,u=s.fieldTransforms;return new tu(new at(f),a,u)}var au=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,s.__extends)(e,t),e.prototype._toFieldTransform=function(t){if(2!==t.Cc)throw 1===t.Cc?t.Mc(this._methodName+"() can only appear at the top level of your update data"):t.Mc(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return t.fieldMask.push(t.path),null},e.prototype.isEqual=function(t){return t instanceof e},e}(Xa);function uu(t,e,n){return new ru({Cc:3,Bc:e.settings.Bc,methodName:t._methodName,Fc:n},e.databaseId,e.R,e.ignoreUndefinedProperties)}var cu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,s.__extends)(e,t),e.prototype._toFieldTransform=function(t){return new ue(t.path,new te)},e.prototype.isEqual=function(t){return t instanceof e},e}(Xa),hu=function(t){function e(e,n){var r=this;return(r=t.call(this,e)||this).Uc=n,r}return(0,s.__extends)(e,t),e.prototype._toFieldTransform=function(t){var e=uu(this,t,!0),n=this.Uc.map((function(t){return vu(t,e)})),r=new ee(n);return new ue(t.path,r)},e.prototype.isEqual=function(t){return this===t},e}(Xa),fu=function(t){function e(e,n){var r=this;return(r=t.call(this,e)||this).Uc=n,r}return(0,s.__extends)(e,t),e.prototype._toFieldTransform=function(t){var e=uu(this,t,!0),n=this.Uc.map((function(t){return vu(t,e)})),r=new re(n);return new ue(t.path,r)},e.prototype.isEqual=function(t){return this===t},e}(Xa),lu=function(t){function e(e,n){var r=this;return(r=t.call(this,e)||this).Qc=n,r}return(0,s.__extends)(e,t),e.prototype._toFieldTransform=function(t){var e=new oe(t.R,Yt(t.R,this.Qc));return new ue(t.path,e)},e.prototype.isEqual=function(t){return this===t},e}(Xa);function du(t,e,n,i){var o=t.qc(1,e,n);_u("Data must be an object, but it was:",o,i);var s=[],a=at.empty();A(i,(function(t,i){var u=Iu(e,t,n);i=(0,r.getModularInstance)(i);var c=o.$c(u);if(i instanceof au)s.push(u);else{var h=vu(i,c);null!=h&&(s.push(u),a.set(u,h))}}));var u=new O(s);return new eu(a,u,o.fieldTransforms)}function pu(t,e,n,i,o,s){var a=t.qc(1,e,n),u=[wu(e,i,n)],f=[o];if(s.length%2!=0)throw new h(c.INVALID_ARGUMENT,"Function "+e+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var l=0;l<s.length;l+=2)u.push(wu(e,s[l])),f.push(s[l+1]);for(var d=[],p=at.empty(),y=u.length-1;y>=0;--y)if(!Tu(d,u[y])){var v=u[y],m=f[y];m=(0,r.getModularInstance)(m);var g=a.$c(v);if(m instanceof au)d.push(v);else{var _=vu(m,g);null!=_&&(d.push(v),p.set(v,_))}}var w=new O(d);return new eu(p,w,a.fieldTransforms)}function yu(t,e,n,r){return void 0===r&&(r=!1),vu(n,t.qc(r?4:3,e))}function vu(t,e){if(gu(t=(0,r.getModularInstance)(t)))return _u("Unsupported field value:",e,t),mu(t,e);if(t instanceof Xa)return function(t,e){if(!nu(e.Cc))throw e.Mc(t._methodName+"() can only be used with update() and set()");if(!e.path)throw e.Mc(t._methodName+"() is not currently supported inside arrays");var n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Fc&&4!==e.Cc)throw e.Mc("Nested arrays are not supported");return function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var s=vu(o[i],e.Oc(r));null==s&&(s={nullValue:"NULL_VALUE"}),n.push(s),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,r.getModularInstance)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Yt(e.R,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){var n=S.fromDate(t);return{timestampValue:rn(e.R,n)}}if(t instanceof S)return n=new S(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)),{timestampValue:rn(e.R,n)};if(t instanceof Ja)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof $a)return{bytesValue:on(e.R,t._byteString)};if(t instanceof La){n=e.databaseId;var i=t.firestore._databaseId;if(!i.isEqual(n))throw e.Mc("Document reference is for database "+i.projectId+"/"+i.database+" but should be for database "+n.projectId+"/"+n.database);return{referenceValue:un(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Mc("Unsupported field value: "+Aa(t))}(t,e)}function mu(t,e){var n={};return k(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):A(t,(function(t,r){var i=vu(r,e.xc(t));null!=i&&(n[t]=i)})),{mapValue:{fields:n}}}function gu(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof S||t instanceof Ja||t instanceof $a||t instanceof La||t instanceof Xa)}function _u(t,e,n){if(!gu(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){var r=Aa(n);throw"an object"===r?e.Mc(t+" a custom object"):e.Mc(t+" "+r)}}function wu(t,e,n){if((e=(0,r.getModularInstance)(e))instanceof Ya)return e._internalPath;if("string"==typeof e)return Iu(t,e);throw Eu("Field path arguments must be of type string or FieldPath.",t,!1,void 0,n)}var bu=new RegExp("[~\\*/\\[\\]]");function Iu(t,e,n){if(e.search(bu)>=0)throw Eu("Invalid field path ("+e+"). Paths must not contain '~', '*', '/', '[', or ']'",t,!1,void 0,n);try{return(new(Ya.bind.apply(Ya,(0,s.__spreadArray)([void 0],e.split(".")))))._internalPath}catch(r){throw Eu("Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'",t,!1,void 0,n)}}function Eu(t,e,n,r,i){var o=r&&!r.isEmpty(),s=void 0!==i,a="Function "+e+"() called with invalid data";n&&(a+=" (via `toFirestore()`)");var u="";return(o||s)&&(u+=" (found",o&&(u+=" in field "+r),s&&(u+=" in document "+i),u+=")"),new h(c.INVALID_ARGUMENT,(a+=". ")+t+u)}function Tu(t,e){return t.some((function(t){return t.isEqual(e)}))}var Su=function(){function t(t,e,n,r,i){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=i}return Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ref",{get:function(){return new La(this._firestore,this._converter,this._key)},enumerable:!1,configurable:!0}),t.prototype.exists=function(){return null!==this._document},t.prototype.data=function(){if(this._document){if(this._converter){var t=new Nu(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}},t.prototype.get=function(t){if(this._document){var e=this._document.data.field(Du("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}},t}(),Nu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,s.__extends)(e,t),e.prototype.data=function(){return t.prototype.data.call(this)},e}(Su);function Du(t,e){return"string"==typeof e?Iu(t,e):e instanceof Ya?e._internalPath:e._delegate._internalPath}var Au=function(){function t(t,e){this.hasPendingWrites=t,this.fromCache=e}return t.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},t}(),ku=function(t){function e(e,n,r,i,o,s){var a=this;return(a=t.call(this,e,n,r,i,s)||this)._firestore=e,a._firestoreImpl=e,a.metadata=o,a}return(0,s.__extends)(e,t),e.prototype.exists=function(){return t.prototype.exists.call(this)},e.prototype.data=function(t){if(void 0===t&&(t={}),this._document){if(this._converter){var e=new xu(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}},e.prototype.get=function(t,e){if(void 0===e&&(e={}),this._document){var n=this._document.data.field(Du("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}},e}(Su),xu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,s.__extends)(e,t),e.prototype.data=function(e){return void 0===e&&(e={}),t.prototype.data.call(this,e)},e}(ku),Cu=function(){function t(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Au(r.hasPendingWrites,r.fromCache),this.query=n}return Object.defineProperty(t.prototype,"docs",{get:function(){var t=[];return this.forEach((function(e){return t.push(e)})),t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return 0===this.size},enumerable:!1,configurable:!0}),t.prototype.forEach=function(t,e){var n=this;this._snapshot.docs.forEach((function(r){t.call(e,new xu(n._firestore,n._userDataWriter,r.key,r,new Au(n._snapshot.mutatedKeys.has(r.key),n._snapshot.fromCache),n.query.converter))}))},t.prototype.docChanges=function(t){void 0===t&&(t={});var e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new h(c.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){var n=0;return t._snapshot.docChanges.map((function(e){var r=new xu(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Au(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);return e.doc,{type:"added",doc:r,oldIndex:-1,newIndex:n++}}))}var r=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((function(t){return e||3!==t.type})).map((function(e){var n=new xu(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Au(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter),i=-1,o=-1;return 0!==e.type&&(i=r.indexOf(e.doc.key),r=r.delete(e.doc.key)),1!==e.type&&(o=(r=r.add(e.doc)).indexOf(e.doc.key)),{type:Ru(e.type),doc:n,oldIndex:i,newIndex:o}}))}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},t}();function Ru(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return m()}}function Lu(t,e){return t instanceof ku&&e instanceof ku?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Cu&&e instanceof Cu&&t._firestore===e._firestore&&qa(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Ou(t){if(Ot(t)&&0===t.explicitOrderBy.length)throw new h(c.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var Pu=function(){};function Mu(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=0,i=e;r<i.length;r++){var o=i[r];t=o._apply(t)}return t}var Fu=function(t){function e(e,n,r){var i=this;return(i=t.call(this)||this).Kc=e,i.jc=n,i.Wc=r,i.type="where",i}return(0,s.__extends)(e,t),e.prototype._apply=function(t){var e=ou(t.firestore),n=function(t,e,n,r,i,o,s){var a;if(i.isKeyField()){if("array-contains"===o||"array-contains-any"===o)throw new h(c.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+o+"' queries on FieldPath.documentId().");if("in"===o||"not-in"===o){Gu(s,o);for(var u=[],f=0,l=s;f<l.length;f++){var d=l[f];u.push(Ku(r,t,d))}a={arrayValue:{values:u}}}else a=Ku(r,t,s)}else"in"!==o&&"not-in"!==o&&"array-contains-any"!==o||Gu(s,o),a=yu(n,"where",s,"in"===o||"not-in"===o);var p=yt.create(i,o,a);return function(t,e){if(e.g()){var n=Mt(t);if(null!==n&&!n.isEqual(e.field))throw new h(c.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '"+n.toString()+"' and '"+e.field.toString()+"'");var r=Pt(t);null!==r&&Qu(t,e.field,r)}var i=function(t,e){for(var n=0,r=t.filters;n<r.length;n++){var i=r[n];if(e.indexOf(i.op)>=0)return i.op}return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==i)throw i===e.op?new h(c.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+e.op.toString()+"' filter."):new h(c.INVALID_ARGUMENT,"Invalid query. You cannot use '"+e.op.toString()+"' filters with '"+i.toString()+"' filters.")}(t,p),p}(t._query,0,e,t.firestore._databaseId,this.Kc,this.jc,this.Wc);return new Oa(t.firestore,t.converter,function(t,e){var n=t.filters.concat([e]);return new xt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))},e}(Pu),Vu=function(t){function e(e,n){var r=this;return(r=t.call(this)||this).Kc=e,r.Gc=n,r.type="orderBy",r}return(0,s.__extends)(e,t),e.prototype._apply=function(t){var e=function(t,e,n){if(null!==t.startAt)throw new h(c.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new h(c.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r=new Nt(e,n);return function(t,e){if(null===Pt(t)){var n=Mt(t);null!==n&&Qu(t,n,e.field)}}(t,r),r}(t._query,this.Kc,this.Gc);return new Oa(t.firestore,t.converter,function(t,e){var n=t.explicitOrderBy.concat([e]);return new xt(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))},e}(Pu),qu=function(t){function e(e,n,r){var i=this;return(i=t.call(this)||this).type=e,i.zc=n,i.Hc=r,i}return(0,s.__extends)(e,t),e.prototype._apply=function(t){return new Oa(t.firestore,t.converter,Ut(t._query,this.zc,this.Hc))},e}(Pu),Uu=function(t){function e(e,n,r){var i=this;return(i=t.call(this)||this).type=e,i.Jc=n,i.Yc=r,i}return(0,s.__extends)(e,t),e.prototype._apply=function(t){var e=ju(t,this.type,this.Jc,this.Yc);return new Oa(t.firestore,t.converter,function(t,e){return new xt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))},e}(Pu),Bu=function(t){function e(e,n,r){var i=this;return(i=t.call(this)||this).type=e,i.Jc=n,i.Yc=r,i}return(0,s.__extends)(e,t),e.prototype._apply=function(t){var e=ju(t,this.type,this.Jc,this.Yc);return new Oa(t.firestore,t.converter,function(t,e){return new xt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))},e}(Pu);function ju(t,e,n,i){if(n[0]=(0,r.getModularInstance)(n[0]),n[0]instanceof Su)return function(t,e,n,r,i){if(!r)throw new h(c.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+n+"().");for(var o=[],s=0,a=Vt(t);s<a.length;s++){var u=a[s];if(u.field.isKeyField())o.push(tt(e,r.key));else{var f=r.data.field(u.field);if(U(f))throw new h(c.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+u.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===f){var l=u.field.canonicalString();throw new h(c.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+l+"' (used as the orderBy) does not exist.")}o.push(f)}}return new Tt(o,i)}(t._query,t.firestore._databaseId,e,n[0]._document,i);var o=ou(t.firestore);return function(t,e,n,r,i,o){var s=t.explicitOrderBy;if(i.length>s.length)throw new h(c.INVALID_ARGUMENT,"Too many arguments provided to "+r+"(). The number of arguments must be less than or equal to the number of orderBy() clauses");for(var a=[],u=0;u<i.length;u++){var f=i[u];if(s[u].field.isKeyField()){if("string"!=typeof f)throw new h(c.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+r+"(), but got a "+typeof f);if(!Ft(t)&&-1!==f.indexOf("/"))throw new h(c.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+r+"() must be a plain document ID, but '"+f+"' contains a slash.");var l=t.path.child(C.fromString(f));if(!z.isDocumentKey(l))throw new h(c.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+r+"() must result in a valid document path, but '"+l+"' is not because it contains an odd number of segments.");var d=new z(l);a.push(tt(e,d))}else{var p=yu(n,r,f);a.push(p)}}return new Tt(a,o)}(t._query,t.firestore._databaseId,o,e,n,i)}function Ku(t,e,n){if("string"==typeof(n=(0,r.getModularInstance)(n))){if(""===n)throw new h(c.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ft(e)&&-1!==n.indexOf("/"))throw new h(c.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+n+"' contains a '/' character.");var i=e.path.child(C.fromString(n));if(!z.isDocumentKey(i))throw new h(c.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+i+"' is not because it has an odd number of segments ("+i.length+").");return tt(t,new z(i))}if(n instanceof La)return tt(t,n._key);throw new h(c.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+Aa(n)+".")}function Gu(t,e){if(!Array.isArray(t)||0===t.length)throw new h(c.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+e.toString()+"' filters.");if(t.length>10)throw new h(c.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters support a maximum of 10 elements in the value array.")}function Qu(t,e,n){if(!n.isEqual(e))throw new h(c.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '"+e.toString()+"' and so you must also use '"+e.toString()+"' as your first argument to orderBy(), but your first orderBy() is on field '"+n.toString()+"' instead.")}var zu=function(){function t(){}return t.prototype.convertValue=function(t,e){switch(void 0===e&&(e="none"),W(t)){case 0:return null;case 1:return t.booleanValue;case 2:return V(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(q(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw m()}},t.prototype.convertObject=function(t,e){var n=this,r={};return A(t.fields,(function(t,i){r[t]=n.convertValue(i,e)})),r},t.prototype.convertGeoPoint=function(t){return new Ja(V(t.latitude),V(t.longitude))},t.prototype.convertArray=function(t,e){var n=this;return(t.values||[]).map((function(t){return n.convertValue(t,e)}))},t.prototype.convertServerTimestamp=function(t,e){switch(e){case"previous":var n=B(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(j(t));default:return null}},t.prototype.convertTimestamp=function(t){var e=F(t);return new S(e.seconds,e.nanos)},t.prototype.convertDocumentKey=function(t,e){var n=C.fromString(t);g(Ln(n));var r=new ya(n.get(1),n.get(3)),i=new z(n.popFirst(5));return r.isEqual(e)||p("Document "+i+" contains a document reference within a different database ("+r.projectId+"/"+r.database+") which is not supported. It will be treated as a reference in the current database ("+e.projectId+"/"+e.database+") instead."),i},t}();function Wu(t,e,n){return t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e}var Hu=function(t){function e(e){var n=this;return(n=t.call(this)||this).firestore=e,n}return(0,s.__extends)(e,t),e.prototype.convertBytes=function(t){return new $a(t)},e.prototype.convertReference=function(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return new La(this.firestore,null,e)},e}(zu),Yu=function(){function t(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=ou(t)}return t.prototype.set=function(t,e,n){this._verifyNotCommitted();var r=$u(t,this._firestore),i=Wu(r.converter,e,n),o=su(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(o.toMutation(r._key,he.none())),this},t.prototype.update=function(t,e,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];this._verifyNotCommitted();var s,a=$u(t,this._firestore);return s="string"==typeof(e=(0,r.getModularInstance)(e))||e instanceof Ya?pu(this._dataReader,"WriteBatch.update",a._key,e,n,i):du(this._dataReader,"WriteBatch.update",a._key,e),this._mutations.push(s.toMutation(a._key,he.exists(!0))),this},t.prototype.delete=function(t){this._verifyNotCommitted();var e=$u(t,this._firestore);return this._mutations=this._mutations.concat(new Se(e._key,he.none())),this},t.prototype.commit=function(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()},t.prototype._verifyNotCommitted=function(){if(this._committed)throw new h(c.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},t}();function $u(t,e){if((t=(0,r.getModularInstance)(t)).firestore!==e)throw new h(c.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}var Xu=function(t){function e(e){var n=this;return(n=t.call(this)||this).firestore=e,n}return(0,s.__extends)(e,t),e.prototype.convertBytes=function(t){return new $a(t)},e.prototype.convertReference=function(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return new La(this.firestore,null,e)},e}(zu);function Ju(t,e,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];t=ka(t,La);var s=ka(t.firestore,Ga),a=ou(s);return tc(s,[("string"==typeof(e=(0,r.getModularInstance)(e))||e instanceof Ya?pu(a,"updateDoc",t._key,e,n,i):du(a,"updateDoc",t._key,e)).toMutation(t._key,he.exists(!0))])}function Zu(t){for(var e,n,i,o=[],a=1;a<arguments.length;a++)o[a-1]=arguments[a];t=(0,r.getModularInstance)(t);var u={includeMetadataChanges:!1},c=0;"object"!=typeof o[c]||Ba(o[c])||(u=o[c],c++);var h,f,l,d={includeMetadataChanges:u.includeMetadataChanges};if(Ba(o[c])){var p=o[c];o[c]=null===(e=p.next)||void 0===e?void 0:e.bind(p),o[c+1]=null===(n=p.error)||void 0===n?void 0:n.bind(p),o[c+2]=null===(i=p.complete)||void 0===i?void 0:i.bind(p)}if(t instanceof La)f=ka(t.firestore,Ga),l=Rt(t._key.path),h={next:function(e){o[c]&&o[c](ec(f,t,e))},error:o[c+1],complete:o[c+2]};else{var y=ka(t,Oa);f=ka(y.firestore,Ga),l=y._query;var v=new Xu(f);h={next:function(t){o[c]&&o[c](new Cu(f,v,y,t))},error:o[c+1],complete:o[c+2]},Ou(t._query)}return function(t,e,n,r){var i=this,o=new Js(r),a=new is(e,o,n);return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(i,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return e=Zo,[4,fa(t)];case 1:return[2,e.apply(void 0,[n.sent(),a])]}}))}))})),function(){o.Wo(),t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(i,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return e=ts,[4,fa(t)];case 1:return[2,e.apply(void 0,[n.sent(),a])]}}))}))}))}}(Qa(f),l,d,h)}function tc(t,e){return function(t,e){var n=this,r=new rr;return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(n,void 0,void 0,(function(){var n;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return n=gs,[4,ha(t)];case 1:return[2,n.apply(void 0,[i.sent(),e,r])]}}))}))})),r.promise}(Qa(t),e)}function ec(t,e,n){var r=n.docs.get(e._key),i=new Xu(t);return new ku(t,i,e._key,r,new Au(n.hasPendingWrites,n.fromCache),e.converter)}var nc=function(t){function e(e,n){var r=this;return(r=t.call(this,e,n)||this)._firestore=e,r}return(0,s.__extends)(e,t),e.prototype.get=function(e){var n=this,r=$u(e,this._firestore),i=new Xu(this._firestore);return t.prototype.get.call(this,e).then((function(t){return new ku(n._firestore,i,r._key,t._document,new Au(!1,!1),r.converter)}))},e}(function(){function t(t,e){this._firestore=t,this._transaction=e,this._dataReader=ou(t)}return t.prototype.get=function(t){var e=this,n=$u(t,this._firestore),r=new Hu(this._firestore);return this._transaction.lookup([n._key]).then((function(t){if(!t||1!==t.length)return m();var i=t[0];if(i.isFoundDocument())return new Su(e._firestore,r,i.key,i,n.converter);if(i.isNoDocument())return new Su(e._firestore,r,n._key,null,n.converter);throw m()}))},t.prototype.set=function(t,e,n){var r=$u(t,this._firestore),i=Wu(r.converter,e,n),o=su(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,o),this},t.prototype.update=function(t,e,n){for(var i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];var s,a=$u(t,this._firestore);return s="string"==typeof(e=(0,r.getModularInstance)(e))||e instanceof Ya?pu(this._dataReader,"Transaction.update",a._key,e,n,i):du(this._dataReader,"Transaction.update",a._key,e),this._transaction.update(a._key,s),this},t.prototype.delete=function(t){var e=$u(t,this._firestore);return this._transaction.delete(e._key),this},t}());function rc(){if("undefined"==typeof Uint8Array)throw new h(c.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function ic(){if("undefined"==typeof atob)throw new h(c.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var oc=function(){function t(t){this._delegate=t}return t.fromBase64String=function(e){return ic(),new t($a.fromBase64String(e))},t.fromUint8Array=function(e){return rc(),new t($a.fromUint8Array(e))},t.prototype.toBase64=function(){return ic(),this._delegate.toBase64()},t.prototype.toUint8Array=function(){return rc(),this._delegate.toUint8Array()},t.prototype.isEqual=function(t){return this._delegate.isEqual(t._delegate)},t.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},t}(),sc=function(){function t(){}return t.prototype.enableIndexedDbPersistence=function(t,e){return function(t,e){Ha(t=ka(t,Ga));var n=Qa(t),r=t._freezeSettings(),i=new $s;return Wa(n,i,new Hs(i,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}(t._delegate,{forceOwnership:e})},t.prototype.enableMultiTabIndexedDbPersistence=function(t){return function(t){Ha(t=ka(t,Ga));var e=Qa(t),n=t._freezeSettings(),r=new $s;return Wa(e,r,new Ys(r,n.cacheSizeBytes))}(t._delegate)},t.prototype.clearIndexedDbPersistence=function(t){return function(t){var e=this;if(t._initialized&&!t._terminated)throw new h(c.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");var n=new rr;return t._queue.enqueueAndForgetEvenWhileRestricted((function(){return(0,s.__awaiter)(e,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return sr.yt()?(e=t+"main",[4,sr.delete(e)]):[2,Promise.resolve()];case 1:return n.sent(),[2]}}))}))}(mi(t._databaseId,t._persistenceKey))];case 1:return r.sent(),n.resolve(),[3,3];case 2:return e=r.sent(),n.reject(e),[3,3];case 3:return[2]}}))}))})),n.promise}(t._delegate)},t}(),ac=function(){function t(t,e,n){var r=this;this._delegate=e,this.Xc=n,this.INTERNAL={delete:function(){return r.terminate()}},t instanceof ya||(this.Zc=t)}return Object.defineProperty(t.prototype,"_databaseId",{get:function(){return this._delegate._databaseId},enumerable:!1,configurable:!0}),t.prototype.settings=function(t){var e=this._delegate._getSettings();t.merge||e.host===t.host||y("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&delete(t=Object.assign(Object.assign({},e),t)).merge,this._delegate._setSettings(t)},t.prototype.useEmulator=function(t,e,n){void 0===n&&(n={}),function(t,e,n,i){void 0===i&&(i={});var o=(t=ka(t,Ra))._getSettings();if("firestore.googleapis.com"!==o.host&&o.host!==e&&y("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},o),{host:e+":"+n,ssl:!1})),i.mockUserToken){var s=(0,r.createMockUserToken)(i.mockUserToken),a=i.mockUserToken.sub||i.mockUserToken.user_id;if(!a)throw new h(c.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t._credentials=new _a(new ma(s,new Hi(a)))}}(this._delegate,t,e,n)},t.prototype.enableNetwork=function(){return function(t){var e=this;return t.asyncQueue.enqueue((function(){return(0,s.__awaiter)(e,void 0,void 0,(function(){var e,n;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return[4,aa(t)];case 1:return e=r.sent(),[4,ca(t)];case 2:return n=r.sent(),[2,(e.setNetworkEnabled(!0),function(t){var e=_(t);return e.Or.delete(0),bo(e)}(n))]}}))}))}))}(Qa(ka(this._delegate,Ga)))},t.prototype.disableNetwork=function(){return function(t){var e=this;return t.asyncQueue.enqueue((function(){return(0,s.__awaiter)(e,void 0,void 0,(function(){var e,n;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return[4,aa(t)];case 1:return e=r.sent(),[4,ca(t)];case 2:return n=r.sent(),[2,(e.setNetworkEnabled(!1),function(t){return(0,s.__awaiter)(this,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return(e=_(t)).Or.add(0),[4,Io(e)];case 1:return n.sent(),e.Br.set("Offline"),[2]}}))}))}(n))]}}))}))}))}(Qa(ka(this._delegate,Ga)))},t.prototype.enablePersistence=function(t){var e=!1,n=!1;return t&&Sa("synchronizeTabs",e=!!t.synchronizeTabs,"experimentalForceOwningTab",n=!!t.experimentalForceOwningTab),e?this.Xc.enableMultiTabIndexedDbPersistence(this):this.Xc.enableIndexedDbPersistence(this,n)},t.prototype.clearPersistence=function(){return this.Xc.clearIndexedDbPersistence(this)},t.prototype.terminate=function(){return this.Zc&&(this.Zc._removeServiceInstance("firestore"),this.Zc._removeServiceInstance("firestore-exp")),this._delegate._delete()},t.prototype.waitForPendingWrites=function(){return function(t){var e=this,n=new rr;return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(e,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return e=Ts,[4,ha(t)];case 1:return[2,e.apply(void 0,[r.sent(),n])]}}))}))})),n.promise}(Qa(ka(this._delegate,Ga)))},t.prototype.onSnapshotsInSync=function(t){return function(t,e){return function(t,e){var n=this,r=new Js(e);return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(n,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return e=function(t,e){_(t).Gr.add(e),e.next()},[4,fa(t)];case 1:return[2,e.apply(void 0,[n.sent(),r])]}}))}))})),function(){r.Wo(),t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(n,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return e=function(t,e){_(t).Gr.delete(e)},[4,fa(t)];case 1:return[2,e.apply(void 0,[n.sent(),r])]}}))}))}))}}(Qa(t=ka(t,Ga)),Ba(e)?e:{next:e})}(this._delegate,t)},Object.defineProperty(t.prototype,"app",{get:function(){if(!this.Zc)throw new h(c.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this.Zc},enumerable:!1,configurable:!0}),t.prototype.collection=function(t){try{return new Ic(this,Ma(this._delegate,t))}catch(t){throw pc(t,"collection()","Firestore.collection()")}},t.prototype.doc=function(t){try{return new dc(this,Fa(this._delegate,t))}catch(t){throw pc(t,"doc()","Firestore.doc()")}},t.prototype.collectionGroup=function(t){try{return new _c(this,function(t,e){if(t=ka(t,Ra),Ea("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new h(c.INVALID_ARGUMENT,"Invalid collection ID '"+e+"' passed to function collectionGroup(). Collection IDs must not contain '/'.");return new Oa(t,null,function(t){return new xt(C.emptyPath(),t)}(e))}(this._delegate,t))}catch(t){throw pc(t,"collectionGroup()","Firestore.collectionGroup()")}},t.prototype.runTransaction=function(t){var e=this;return function(t,e){return function(t,e){var n=this,r=new rr;return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(n,void 0,void 0,(function(){var n;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return[4,function(t){return sa(t).then((function(t){return t.datastore}))}(t)];case 1:return n=i.sent(),new ea(t.asyncQueue,n,e,r).run(),[2]}}))}))})),r.promise}(Qa(t),(function(n){return e(new nc(t,n))}))}(this._delegate,(function(n){return t(new hc(e,n))}))},t.prototype.batch=function(){var t=this;return Qa(this._delegate),new fc(new Yu(this._delegate,(function(e){return tc(t._delegate,e)})))},t.prototype.loadBundle=function(t){throw new h(c.FAILED_PRECONDITION,'"loadBundle()" does not exist, have you imported "firebase/firestore/bundle"?')},t.prototype.namedQuery=function(t){throw new h(c.FAILED_PRECONDITION,'"namedQuery()" does not exist, have you imported "firebase/firestore/bundle"?')},t}(),uc=function(t){function e(e){var n=this;return(n=t.call(this)||this).firestore=e,n}return(0,s.__extends)(e,t),e.prototype.convertBytes=function(t){return new oc(new $a(t))},e.prototype.convertReference=function(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return dc.tu(e,this.firestore,null)},e}(zu);function cc(t){var e;e=t,f.setLogLevel(e)}var hc=function(){function t(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new uc(t)}return t.prototype.get=function(t){var e=this,n=Ec(t);return this._delegate.get(n).then((function(t){return new mc(e._firestore,new ku(e._firestore._delegate,e._userDataWriter,t._key,t._document,t.metadata,n.converter))}))},t.prototype.set=function(t,e,n){var r=Ec(t);return n?(Ta("Transaction.set",n),this._delegate.set(r,e,n)):this._delegate.set(r,e),this},t.prototype.update=function(t,e,n){for(var r,i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];var a=Ec(t);return 2===arguments.length?this._delegate.update(a,e):(r=this._delegate).update.apply(r,(0,s.__spreadArray)([a,e,n],i)),this},t.prototype.delete=function(t){var e=Ec(t);return this._delegate.delete(e),this},t}(),fc=function(){function t(t){this._delegate=t}return t.prototype.set=function(t,e,n){var r=Ec(t);return n?(Ta("WriteBatch.set",n),this._delegate.set(r,e,n)):this._delegate.set(r,e),this},t.prototype.update=function(t,e,n){for(var r,i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];var a=Ec(t);return 2===arguments.length?this._delegate.update(a,e):(r=this._delegate).update.apply(r,(0,s.__spreadArray)([a,e,n],i)),this},t.prototype.delete=function(t){var e=Ec(t);return this._delegate.delete(e),this},t.prototype.commit=function(){return this._delegate.commit()},t}(),lc=function(){function t(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}return t.prototype.fromFirestore=function(t,e){var n=new xu(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new gc(this._firestore,n),null!=e?e:{})},t.prototype.toFirestore=function(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)},t.eu=function(e,n){var r=t.nu,i=r.get(e);i||(i=new WeakMap,r.set(e,i));var o=i.get(n);return o||(o=new t(e,new uc(e),n),i.set(n,o)),o},t}();lc.nu=new WeakMap;var dc=function(){function t(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new uc(t)}return t.su=function(e,n,r){if(e.length%2!=0)throw new h(c.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new t(n,new La(n._delegate,r,new z(e)))},t.tu=function(e,n,r){return new t(n,new La(n._delegate,r,e))},Object.defineProperty(t.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new Ic(this.firestore,this._delegate.parent)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._delegate.path},enumerable:!1,configurable:!0}),t.prototype.collection=function(t){try{return new Ic(this.firestore,Ma(this._delegate,t))}catch(t){throw pc(t,"collection()","DocumentReference.collection()")}},t.prototype.isEqual=function(t){return(t=(0,r.getModularInstance)(t))instanceof La&&Va(this._delegate,t)},t.prototype.set=function(t,e){e=Ta("DocumentReference.set",e);try{return function(t,e,n){t=ka(t,La);var r=ka(t.firestore,Ga),i=Wu(t.converter,e,n);return tc(r,[su(ou(r),"setDoc",t._key,i,null!==t.converter,n).toMutation(t._key,he.none())])}(this._delegate,t,e)}catch(t){throw pc(t,"setDoc()","DocumentReference.set()")}},t.prototype.update=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];try{return 1===arguments.length?Ju(this._delegate,t):Ju.apply(void 0,(0,s.__spreadArray)([this._delegate,t,e],n))}catch(t){throw pc(t,"updateDoc()","DocumentReference.update()")}},t.prototype.delete=function(){return tc(ka((t=this._delegate).firestore,Ga),[new Se(t._key,he.none())]);var t},t.prototype.onSnapshot=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=yc(e),i=vc(e,(function(e){return new mc(t.firestore,new ku(t.firestore._delegate,t._userDataWriter,e._key,e._document,e.metadata,t._delegate.converter))}));return Zu(this._delegate,r,i)},t.prototype.get=function(t){var e=this;return("cache"===(null==t?void 0:t.source)?function(t){t=ka(t,La);var e=ka(t.firestore,Ga),n=Qa(e),r=new Xu(e);return function(t,e){var n=this,r=new rr;return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(n,void 0,void 0,(function(){var n;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return n=function(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i;return(0,s.__generator)(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,function(t,e){var n=_(t);return n.persistence.runTransaction("read document","readonly",(function(t){return n.Mn.mn(t,e)}))}(t,e)];case 1:return(i=o.sent()).isFoundDocument()?n.resolve(i):i.isNoDocument()?n.resolve(null):n.reject(new h(c.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")),[3,3];case 2:return r=o.sent(),i=Wo(r,"Failed to get document '"+e+" from cache"),n.reject(i),[3,3];case 3:return[2]}}))}))},[4,ua(t)];case 1:return[2,n.apply(void 0,[i.sent(),e,r])]}}))}))})),r.promise}(n,t._key).then((function(n){return new ku(e,r,t._key,n,new Au(null!==n&&n.hasLocalMutations,!0),t.converter)}))}(this._delegate):"server"===(null==t?void 0:t.source)?function(t){t=ka(t,La);var e=ka(t.firestore,Ga);return la(Qa(e),t._key,{source:"server"}).then((function(n){return ec(e,t,n)}))}(this._delegate):function(t){t=ka(t,La);var e=ka(t.firestore,Ga);return la(Qa(e),t._key).then((function(n){return ec(e,t,n)}))}(this._delegate)).then((function(t){return new mc(e.firestore,new ku(e.firestore._delegate,e._userDataWriter,t._key,t._document,t.metadata,e._delegate.converter))}))},t.prototype.withConverter=function(e){return new t(this.firestore,e?this._delegate.withConverter(lc.eu(this.firestore,e)):this._delegate.withConverter(null))},t}();function pc(t,e,n){return t.message=t.message.replace(e,n),t}function yc(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if("object"==typeof r&&!Ba(r))return r}return{}}function vc(t,e){var n,r,i;return{next:function(t){i.next&&i.next(e(t))},error:null===(n=(i=Ba(t[0])?t[0]:Ba(t[1])?t[1]:"function"==typeof t[0]?{next:t[0],error:t[1],complete:t[2]}:{next:t[1],error:t[2],complete:t[3]}).error)||void 0===n?void 0:n.bind(i),complete:null===(r=i.complete)||void 0===r?void 0:r.bind(i)}}var mc=function(){function t(t,e){this._firestore=t,this._delegate=e}return Object.defineProperty(t.prototype,"ref",{get:function(){return new dc(this._firestore,this._delegate.ref)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"metadata",{get:function(){return this._delegate.metadata},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"exists",{get:function(){return this._delegate.exists()},enumerable:!1,configurable:!0}),t.prototype.data=function(t){return this._delegate.data(t)},t.prototype.get=function(t,e){return this._delegate.get(t,e)},t.prototype.isEqual=function(t){return Lu(this._delegate,t._delegate)},t}(),gc=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,s.__extends)(e,t),e.prototype.data=function(t){return this._delegate.data(t)},e}(mc),_c=function(){function t(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new uc(t)}return t.prototype.where=function(e,n,r){try{return new t(this.firestore,Mu(this._delegate,function(t,e,n){var r=e,i=Du("where",t);return new Fu(i,r,n)}(e,n,r)))}catch(e){throw pc(e,/(orderBy|where)\(\)/,"Query.$1()")}},t.prototype.orderBy=function(e,n){try{return new t(this.firestore,Mu(this._delegate,function(t,e){void 0===e&&(e="asc");var n=e,r=Du("orderBy",t);return new Vu(r,n)}(e,n)))}catch(e){throw pc(e,/(orderBy|where)\(\)/,"Query.$1()")}},t.prototype.limit=function(e){try{return new t(this.firestore,Mu(this._delegate,function(t){return xa("limit",t),new qu("limit",t,"F")}(e)))}catch(e){throw pc(e,"limit()","Query.limit()")}},t.prototype.limitToLast=function(e){try{return new t(this.firestore,Mu(this._delegate,function(t){return xa("limitToLast",t),new qu("limitToLast",t,"L")}(e)))}catch(e){throw pc(e,"limitToLast()","Query.limitToLast()")}},t.prototype.startAt=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return new t(this.firestore,Mu(this._delegate,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new Uu("startAt",t,!0)}.apply(void 0,e)))}catch(e){throw pc(e,"startAt()","Query.startAt()")}},t.prototype.startAfter=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return new t(this.firestore,Mu(this._delegate,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new Uu("startAfter",t,!1)}.apply(void 0,e)))}catch(e){throw pc(e,"startAfter()","Query.startAfter()")}},t.prototype.endBefore=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return new t(this.firestore,Mu(this._delegate,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new Bu("endBefore",t,!0)}.apply(void 0,e)))}catch(e){throw pc(e,"endBefore()","Query.endBefore()")}},t.prototype.endAt=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return new t(this.firestore,Mu(this._delegate,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new Bu("endAt",t,!1)}.apply(void 0,e)))}catch(e){throw pc(e,"endAt()","Query.endAt()")}},t.prototype.isEqual=function(t){return qa(this._delegate,t._delegate)},t.prototype.get=function(t){var e=this;return("cache"===(null==t?void 0:t.source)?function(t){t=ka(t,Oa);var e=ka(t.firestore,Ga),n=Qa(e),r=new Xu(e);return function(t,e){var n=this,r=new rr;return t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(n,void 0,void 0,(function(){var n;return(0,s.__generator)(this,(function(i){switch(i.label){case 0:return n=function(t,e,n){return(0,s.__awaiter)(this,void 0,void 0,(function(){var r,i,o,a,u;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),[4,Ri(t,e,!0)];case 1:return u=s.sent(),r=new fs(e,u.Bn),i=r._o(u.documents),o=r.applyChanges(i,!1),n.resolve(o.snapshot),[3,3];case 2:return a=s.sent(),u=Wo(a,"Failed to execute query '"+e+" against cache"),n.reject(u),[3,3];case 3:return[2]}}))}))},[4,ua(t)];case 1:return[2,n.apply(void 0,[i.sent(),e,r])]}}))}))})),r.promise}(n,t._query).then((function(n){return new Cu(e,r,t,n)}))}(this._delegate):"server"===(null==t?void 0:t.source)?function(t){t=ka(t,Oa);var e=ka(t.firestore,Ga),n=Qa(e),r=new Xu(e);return da(n,t._query,{source:"server"}).then((function(n){return new Cu(e,r,t,n)}))}(this._delegate):function(t){t=ka(t,Oa);var e=ka(t.firestore,Ga),n=Qa(e),r=new Xu(e);return Ou(t._query),da(n,t._query).then((function(n){return new Cu(e,r,t,n)}))}(this._delegate)).then((function(t){return new bc(e.firestore,new Cu(e.firestore._delegate,e._userDataWriter,e._delegate,t._snapshot))}))},t.prototype.onSnapshot=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=yc(e),i=vc(e,(function(e){return new bc(t.firestore,new Cu(t.firestore._delegate,t._userDataWriter,t._delegate,e._snapshot))}));return Zu(this._delegate,r,i)},t.prototype.withConverter=function(e){return new t(this.firestore,e?this._delegate.withConverter(lc.eu(this.firestore,e)):this._delegate.withConverter(null))},t}(),wc=function(){function t(t,e){this._firestore=t,this._delegate=e}return Object.defineProperty(t.prototype,"type",{get:function(){return this._delegate.type},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"doc",{get:function(){return new gc(this._firestore,this._delegate.doc)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"oldIndex",{get:function(){return this._delegate.oldIndex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"newIndex",{get:function(){return this._delegate.newIndex},enumerable:!1,configurable:!0}),t}(),bc=function(){function t(t,e){this._firestore=t,this._delegate=e}return Object.defineProperty(t.prototype,"query",{get:function(){return new _c(this._firestore,this._delegate.query)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"metadata",{get:function(){return this._delegate.metadata},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._delegate.size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return this._delegate.empty},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"docs",{get:function(){var t=this;return this._delegate.docs.map((function(e){return new gc(t._firestore,e)}))},enumerable:!1,configurable:!0}),t.prototype.docChanges=function(t){var e=this;return this._delegate.docChanges(t).map((function(t){return new wc(e._firestore,t)}))},t.prototype.forEach=function(t,e){var n=this;this._delegate.forEach((function(r){t.call(e,new gc(n._firestore,r))}))},t.prototype.isEqual=function(t){return Lu(this._delegate,t._delegate)},t}(),Ic=function(t){function e(e,n){var r=this;return(r=t.call(this,e,n)||this).firestore=e,r._delegate=n,r}return(0,s.__extends)(e,t),Object.defineProperty(e.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._delegate.path},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){var t=this._delegate.parent;return t?new dc(this.firestore,t):null},enumerable:!1,configurable:!0}),e.prototype.doc=function(t){try{return new dc(this.firestore,void 0===t?Fa(this._delegate):Fa(this._delegate,t))}catch(t){throw pc(t,"doc()","CollectionReference.doc()")}},e.prototype.add=function(t){var e=this;return function(t,e){var n=ka(t.firestore,Ga),r=Fa(t),i=Wu(t.converter,e);return tc(n,[su(ou(t.firestore),"addDoc",r._key,i,null!==t.converter,{}).toMutation(r._key,he.exists(!1))]).then((function(){return r}))}(this._delegate,t).then((function(t){return new dc(e.firestore,t)}))},e.prototype.isEqual=function(t){return Va(this._delegate,t._delegate)},e.prototype.withConverter=function(t){return new e(this.firestore,t?this._delegate.withConverter(lc.eu(this.firestore,t)):this._delegate.withConverter(null))},e}(_c);function Ec(t){return ka(t,La)}var Tc=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._delegate=new(Ya.bind.apply(Ya,(0,s.__spreadArray)([void 0],t)))}return t.documentId=function(){return new t(L.keyField().canonicalString())},t.prototype.isEqual=function(t){return(t=(0,r.getModularInstance)(t))instanceof Ya&&this._delegate._internalPath.isEqual(t._internalPath)},t}(),Sc=function(){function t(t){this._delegate=t}return t.serverTimestamp=function(){var e=new cu("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new t(e)},t.delete=function(){var e=new au("deleteField");return e._methodName="FieldValue.delete",new t(e)},t.arrayUnion=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new hu("arrayUnion",t)}.apply(void 0,e);return r._methodName="FieldValue.arrayUnion",new t(r)},t.arrayRemove=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new fu("arrayRemove",t)}.apply(void 0,e);return r._methodName="FieldValue.arrayRemove",new t(r)},t.increment=function(e){var n=function(t){return new lu("increment",t)}(e);return n._methodName="FieldValue.increment",new t(n)},t.prototype.isEqual=function(t){return this._delegate.isEqual(t._delegate)},t}();function Nc(t){return function(t,e){var n=Qa(t=ka(t,Ga)),r=new ja;return function(t,e,n,r){var i=this,o=function(t,e){return function(t,e){return new Zs(t,e)}(function(t,e){if(t instanceof Uint8Array)return Xs(t,e);if(t instanceof ArrayBuffer)return Xs(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof t?(new TextEncoder).encode(t):t),e)}(n,lo(e));t.asyncQueue.enqueueAndForget((function(){return(0,s.__awaiter)(i,void 0,void 0,(function(){var e;return(0,s.__generator)(this,(function(n){switch(n.label){case 0:return e=zs,[4,ha(t)];case 1:return e.apply(void 0,[n.sent(),o,r]),[2]}}))}))}))}(n,t._databaseId,e,r),r}(this._delegate,t)}function Dc(t){var e,n,r=this;return(e=this._delegate,n=t,function(t,e){var n=this;return t.asyncQueue.enqueue((function(){return(0,s.__awaiter)(n,void 0,void 0,(function(){var n;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return n=function(t,e){var n=_(t);return n.persistence.runTransaction("Get named query","readonly",(function(t){return n.Qe.getNamedQuery(t,e)}))},[4,ua(t)];case 1:return[2,n.apply(void 0,[r.sent(),e])]}}))}))}))}(Qa(e=ka(e,Ga)),n).then((function(t){return t?new Oa(e,null,t.query):null}))).then((function(t){return t?new _c(r,t):null}))}}}]);
//# sourceMappingURL=a44e0c50-90eedd67de8fd4a87662.js.map